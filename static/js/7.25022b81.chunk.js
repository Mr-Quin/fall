(this.webpackJsonpfall=this.webpackJsonpfall||[]).push([[7],{264:function(e,t,n){"use strict";n.d(t,"e",(function(){return d})),n.d(t,"d",(function(){return f})),n.d(t,"f",(function(){return y})),n.d(t,"c",(function(){return m})),n.d(t,"g",(function(){return v})),n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r}));var o={};n.r(o),n.d(o,"GLTFBinaryExtension",(function(){return Ee})),n.d(o,"GLTFLoaderBase",(function(){return xe})),n.d(o,"GLTFLoader",(function(){return Ae})),n.d(o,"GLTFLoaderExtension",(function(){return we})),n.d(o,"EComponentType",(function(){return b})),n.d(o,"EShaderType",(function(){return g})),n.d(o,"EParameterType",(function(){return _})),n.d(o,"ETextureWrapMode",(function(){return x})),n.d(o,"ETextureFilterType",(function(){return A})),n.d(o,"ETextureFormat",(function(){return w})),n.d(o,"ECullingType",(function(){return E})),n.d(o,"EBlendingFunction",(function(){return T})),n.d(o,"GLTFUtils",(function(){return Z})),n.d(o,"GLTFMaterialsCommonExtension",(function(){return Te}));var r={};n.r(r),n.d(r,"ArrayItem",(function(){return Be})),n.d(r,"GLTFLoader",(function(){return Ie})),n.d(r,"EXT_lights_image_based",(function(){return ze})),n.d(r,"KHR_draco_mesh_compression",(function(){return ke})),n.d(r,"KHR_lights",(function(){return Ge})),n.d(r,"KHR_materials_pbrSpecularGlossiness",(function(){return He})),n.d(r,"KHR_materials_unlit",(function(){return Ke})),n.d(r,"KHR_materials_clearcoat",(function(){return Xe})),n.d(r,"KHR_materials_sheen",(function(){return Ye})),n.d(r,"KHR_materials_specular",(function(){return Qe})),n.d(r,"KHR_mesh_quantization",(function(){return Ze})),n.d(r,"KHR_texture_basisu",(function(){return Je})),n.d(r,"KHR_texture_transform",(function(){return $e})),n.d(r,"MSFT_audio_emitter",(function(){return ot})),n.d(r,"MSFT_lod",(function(){return rt})),n.d(r,"MSFT_minecraftMesh",(function(){return it})),n.d(r,"MSFT_sRGBFactors",(function(){return at})),n.d(r,"ExtrasAsMetadata",(function(){return st}));var i=n(5),a=n(14),s=n(38),l=n(157),u=n(6),c=n(213);function h(e,t,n,o){var r={externalResourceFunction:function(e){return o(e).then((function(e){return new Uint8Array(e)}))}};return n&&(r.uri="file:"===t?n:t+n),e instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(e),r):GLTFValidator.validateString(e,r)}function p(){var e=[];onmessage=function(t){var n=t.data;switch(n.id){case"init":importScripts(n.url);break;case"validate":h(n.data,n.rootUrl,n.fileName,(function(t){return new Promise((function(n,o){var r=e.length;e.push({resolve:n,reject:o}),postMessage({id:"getExternalResource",index:r,uri:t})}))})).then((function(e){postMessage({id:"validate.resolve",value:e})}),(function(e){postMessage({id:"validate.reject",reason:e})}));break;case"getExternalResource.resolve":e[n.index].resolve(n.value);break;case"getExternalResource.reject":e[n.index].reject(n.reason)}}}var d,f,y,v=function(){function e(){}return e.ValidateAsync=function(e,t,n,o){var r=this;return"function"===typeof Worker?new Promise((function(i,s){var l=h+"("+p+")()",u=URL.createObjectURL(new Blob([l],{type:"application/javascript"})),c=new Worker(u),d=function e(t){c.removeEventListener("error",e),c.removeEventListener("message",f),s(t)},f=function e(t){var n=t.data;switch(n.id){case"getExternalResource":o(n.uri).then((function(e){c.postMessage({id:"getExternalResource.resolve",index:n.index,value:e},[e])}),(function(e){c.postMessage({id:"getExternalResource.reject",index:n.index,reason:e})}));break;case"validate.resolve":c.removeEventListener("error",d),c.removeEventListener("message",e),i(n.value);break;case"validate.reject":c.removeEventListener("error",d),c.removeEventListener("message",e),s(n.reason)}};c.addEventListener("error",d),c.addEventListener("message",f),c.postMessage({id:"init",url:a.b.GetAbsoluteUrl(r.Configuration.url)}),c.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})})):(this._LoadScriptPromise||(this._LoadScriptPromise=a.b.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then((function(){return h(e,t,n,o)})))},e.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},e}();!function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"}(d||(d={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL"}(f||(f={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE"}(y||(y={}));var m=function(){function e(){this.onParsedObservable=new i.c,this.coordinateSystemMode=d.AUTO,this.animationStartMode=f.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.preprocessUrlAsync=function(e){return Promise.resolve(e)},this.onMeshLoadedObservable=new i.c,this.onTextureLoadedObservable=new i.c,this.onMaterialLoadedObservable=new i.c,this.onCameraLoadedObservable=new i.c,this.onCompleteObservable=new i.c,this.onErrorObservable=new i.c,this.onDisposeObservable=new i.c,this.onExtensionLoadedObservable=new i.c,this.validate=!1,this.onValidatedObservable=new i.c,this._loader=null,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}return Object.defineProperty(e.prototype,"onParsed",{set:function(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMeshLoaded",{set:function(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onTextureLoaded",{set:function(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMaterialLoaded",{set:function(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onCameraLoaded",{set:function(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onComplete",{set:function(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onError",{set:function(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onExtensionLoaded",{set:function(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"loggingEnabled",{get:function(){return this._loggingEnabled},set:function(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"capturePerformanceCounters",{get:function(){return this._capturePerformanceCounters},set:function(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onValidated",{set:function(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null),this._clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()},e.prototype._clear=function(){this.preprocessUrlAsync=function(e){return Promise.resolve(e)},this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear()},e.prototype.requestFile=function(e,t,n,o,r,s){var l=this;if(r){if(this.useRangeRequests){this.validate&&u.a.Warn("glTF validation is not supported when range requests are enabled");var h=new Array,p={abort:function(){return h.forEach((function(e){return e.abort()}))},onCompleteObservable:new i.c},d={readAsync:function(n,r){return new Promise((function(i,a){h.push(e._requestFile(t,(function(e,t){var n=t.getResponseHeader("Content-Range");n&&(d.byteLength=Number(n.split("/")[1])),i(new Uint8Array(e))}),o,!0,!0,(function(e){a(e)}),(function(e){e.setRequestHeader("Range","bytes="+n+"-"+(n+r-1))})))}))},byteLength:0};return this._unpackBinaryAsync(new c.a(d)).then((function(e){p.onCompleteObservable.notifyObservers(p),n(e)}),s),p}return e._requestFile(t,(function(e,t){var o=e;l._unpackBinaryAsync(new c.a({readAsync:function(e,t){return Promise.resolve(new Uint8Array(o,e,t))},byteLength:o.byteLength})).then((function(e){n(e,t)}),s)}),o,!0,!0,s)}return e._requestFile(t,(function(o,r){l._validate(e,o,a.b.GetFolderPath(t),a.b.GetFilename(t)),n({json:l._parseJson(o)},r)}),o,!0,!1,s)},e.prototype.readFile=function(e,t,n,o,r,i){var a=this;return e._readFile(t,(function(o){if(a._validate(e,o,"file:",t.name),r){var s=o;a._unpackBinaryAsync(new c.a({readAsync:function(e,t){return Promise.resolve(new Uint8Array(s,e,t))},byteLength:s.byteLength})).then(n,i)}else n({json:a._parseJson(o)})}),o,r,i)},e.prototype.importMeshAsync=function(e,t,n,o,r,i){var a=this;return Promise.resolve().then((function(){return a.onParsedObservable.notifyObservers(n),a.onParsedObservable.clear(),a._log("Loading "+(i||"")),a._loader=a._getLoader(n),a._loader.importMeshAsync(e,t,!1,n,o,r,i)}))},e.prototype.loadAsync=function(e,t,n,o,r){var i=this;return Promise.resolve().then((function(){return i.onParsedObservable.notifyObservers(t),i.onParsedObservable.clear(),i._log("Loading "+(r||"")),i._loader=i._getLoader(t),i._loader.loadAsync(e,t,n,o,r)}))},e.prototype.loadAssetContainerAsync=function(e,t,n,o,r){var i=this;return Promise.resolve().then((function(){i.onParsedObservable.notifyObservers(t),i.onParsedObservable.clear(),i._log("Loading "+(r||"")),i._loader=i._getLoader(t);var a=[];i.onMaterialLoadedObservable.add((function(e){a.push(e)}));var s=[];return i.onTextureLoadedObservable.add((function(e){s.push(e)})),i._loader.importMeshAsync(null,e,!0,t,n,o,r).then((function(t){var n=new l.a(e);return Array.prototype.push.apply(n.meshes,t.meshes),Array.prototype.push.apply(n.particleSystems,t.particleSystems),Array.prototype.push.apply(n.skeletons,t.skeletons),Array.prototype.push.apply(n.animationGroups,t.animationGroups),Array.prototype.push.apply(n.materials,a),Array.prototype.push.apply(n.textures,s),Array.prototype.push.apply(n.lights,t.lights),Array.prototype.push.apply(n.transformNodes,t.transformNodes),n}))}))},e.prototype.canDirectLoad=function(e){return-1!==e.indexOf("asset")&&-1!==e.indexOf("version")},e.prototype.directLoad=function(e,t){return this._validate(e,t),{json:this._parseJson(t)}},e.prototype.createPlugin=function(){return new e},Object.defineProperty(e.prototype,"loaderState",{get:function(){return this._loader?this._loader.state:null},enumerable:!0,configurable:!0}),e.prototype.whenCompleteAsync=function(){var e=this;return new Promise((function(t,n){e.onCompleteObservable.addOnce((function(){t()})),e.onErrorObservable.addOnce((function(e){n(e)}))}))},e.prototype._validate=function(e,t,n,o){var r=this;void 0===n&&(n=""),void 0===o&&(o=""),this.validate&&(this._startPerformanceCounter("Validate JSON"),v.ValidateAsync(t,n,o,(function(t){return r.preprocessUrlAsync(n+t).then((function(t){return e._loadFileAsync(t,void 0,!0,!0)}))})).then((function(e){r._endPerformanceCounter("Validate JSON"),r.onValidatedObservable.notifyObservers(e),r.onValidatedObservable.clear()}),(function(e){r._endPerformanceCounter("Validate JSON"),a.b.Warn("Failed to validate: "+e.message),r.onValidatedObservable.clear()})))},e.prototype._getLoader=function(t){var n=t.json.asset||{};this._log("Asset version: "+n.version),n.minVersion&&this._log("Asset minimum version: "+n.minVersion),n.generator&&this._log("Asset generator: "+n.generator);var o=e._parseVersion(n.version);if(!o)throw new Error("Invalid version: "+n.version);if(void 0!==n.minVersion){var r=e._parseVersion(n.minVersion);if(!r)throw new Error("Invalid minimum version: "+n.minVersion);if(e._compareVersion(r,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+n.minVersion)}var i={1:e._CreateGLTF1Loader,2:e._CreateGLTF2Loader}[o.major];if(!i)throw new Error("Unsupported version: "+n.version);return i(this)},e.prototype._parseJson=function(e){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: "+e.length);var t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t},e.prototype._unpackBinaryAsync=function(e){var t=this;return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then((function(){var n=e.readUint32();if(1179937895!==n)throw new Error("Unexpected magic: "+n);var o=e.readUint32();t.loggingEnabled&&t._log("Binary version: "+o);var r,i=e.readUint32();if(0!=e.buffer.byteLength&&i!==e.buffer.byteLength)throw new Error("Length in header does not match actual data length: "+i+" != "+e.buffer.byteLength);switch(o){case 1:r=t._unpackBinaryV1Async(e,i);break;case 2:r=t._unpackBinaryV2Async(e,i);break;default:throw new Error("Unsupported version: "+o)}return t._endPerformanceCounter("Unpack Binary"),r}))},e.prototype._unpackBinaryV1Async=function(e,t){var n=e.readUint32(),o=e.readUint32();if(0!==o)throw new Error("Unexpected content format: "+o);var r=t-e.byteOffset,i={json:this._parseJson(e.readString(n)),bin:null};if(0!==r){var a=e.byteOffset;i.bin={readAsync:function(t,n){return e.buffer.readAsync(a+t,n)},byteLength:r}}return Promise.resolve(i)},e.prototype._unpackBinaryV2Async=function(e,t){var n=this,o=1313821514,r=5130562,i=e.readUint32();if(e.readUint32()!==o)throw new Error("First chunk format is not JSON");return e.byteOffset+i===t?e.loadAsync(i).then((function(){return{json:n._parseJson(e.readString(i)),bin:null}})):e.loadAsync(i+8).then((function(){var a={json:n._parseJson(e.readString(i)),bin:null};return function n(){var i=e.readUint32();switch(e.readUint32()){case o:throw new Error("Unexpected JSON chunk");case r:var s=e.byteOffset;a.bin={readAsync:function(t,n){return e.buffer.readAsync(s+t,n)},byteLength:i},e.skipBytes(i);break;default:e.skipBytes(i)}return e.byteOffset!==t?e.loadAsync(8).then(n):Promise.resolve(a)}()}))},e._parseVersion=function(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};var t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null},e._compareVersion=function(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0},e.prototype._logOpen=function(e){this._log(e),this._logIndentLevel++},e.prototype._logClose=function(){--this._logIndentLevel},e.prototype._logEnabled=function(t){var n=e._logSpaces.substr(0,2*this._logIndentLevel);u.a.Log(""+n+t)},e.prototype._logDisabled=function(e){},e.prototype._startPerformanceCounterEnabled=function(e){a.b.StartPerformanceCounter(e)},e.prototype._startPerformanceCounterDisabled=function(e){},e.prototype._endPerformanceCounterEnabled=function(e){a.b.EndPerformanceCounter(e)},e.prototype._endPerformanceCounterDisabled=function(e){},e.IncrementalLoading=!0,e.HomogeneousCoordinates=!1,e._logSpaces="                                ",e}();s.a&&s.a.RegisterPlugin(new m);var b,g,_,x,A,w,E,T,S=n(1);!function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.FLOAT=5126]="FLOAT"}(b||(b={})),function(e){e[e.FRAGMENT=35632]="FRAGMENT",e[e.VERTEX=35633]="VERTEX"}(g||(g={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D"}(_||(_={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(x||(x={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9728]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(A||(A={})),function(e){e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(w||(w={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(E||(E={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"}(T||(T={}));var M,C=n(0),L=n(9),R=n(26),O=n(56),P=n(28),N=n(125),B=n(144),I=n(7),F=n(35),V=n(79),D=n(37),q=n(94),z=n(8),W=n(16),k=n(3),j=n(74),U=n(60),G=n(32),H=n(4),K=n(93),X=n(156),Y=n(159),Q=n(158),Z=function(){function e(){}return e.SetMatrix=function(e,t,n,o,r){var i=null;if("MODEL"===n.semantic?i=t.getWorldMatrix():"PROJECTION"===n.semantic?i=e.getProjectionMatrix():"VIEW"===n.semantic?i=e.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===n.semantic?i=C.a.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):"MODELVIEW"===n.semantic?i=t.getWorldMatrix().multiply(e.getViewMatrix()):"MODELVIEWPROJECTION"===n.semantic?i=t.getWorldMatrix().multiply(e.getTransformMatrix()):"MODELINVERSE"===n.semantic?i=t.getWorldMatrix().invert():"VIEWINVERSE"===n.semantic?i=e.getViewMatrix().invert():"PROJECTIONINVERSE"===n.semantic?i=e.getProjectionMatrix().invert():"MODELVIEWINVERSE"===n.semantic?i=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===n.semantic?i=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===n.semantic&&(i=C.a.Transpose(t.getWorldMatrix().invert())),i)switch(n.type){case _.FLOAT_MAT2:r.setMatrix2x2(o,C.a.GetAsMatrix2x2(i));break;case _.FLOAT_MAT3:r.setMatrix3x3(o,C.a.GetAsMatrix3x3(i));break;case _.FLOAT_MAT4:r.setMatrix(o,i)}},e.SetUniform=function(e,t,n,o){switch(o){case _.FLOAT:return e.setFloat(t,n),!0;case _.FLOAT_VEC2:return e.setVector2(t,C.d.FromArray(n)),!0;case _.FLOAT_VEC3:return e.setVector3(t,C.e.FromArray(n)),!0;case _.FLOAT_VEC4:return e.setVector4(t,C.f.FromArray(n)),!0;default:return!1}},e.GetWrapMode=function(e){switch(e){case x.CLAMP_TO_EDGE:return z.a.CLAMP_ADDRESSMODE;case x.MIRRORED_REPEAT:return z.a.MIRROR_ADDRESSMODE;case x.REPEAT:default:return z.a.WRAP_ADDRESSMODE}},e.GetByteStrideFromType=function(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},e.GetTextureFilterMode=function(e){switch(e){case A.LINEAR:case A.LINEAR_MIPMAP_NEAREST:case A.LINEAR_MIPMAP_LINEAR:return z.a.TRILINEAR_SAMPLINGMODE;case A.NEAREST:case A.NEAREST_MIPMAP_NEAREST:return z.a.NEAREST_SAMPLINGMODE;default:return z.a.BILINEAR_SAMPLINGMODE}},e.GetBufferFromBufferView=function(e,t,n,o,r){n=t.byteOffset+n;var i=e.loadedBufferViews[t.buffer];if(n+o>i.byteLength)throw new Error("Buffer access is out of range");var a=i.buffer;switch(n+=i.byteOffset,r){case b.BYTE:return new Int8Array(a,n,o);case b.UNSIGNED_BYTE:return new Uint8Array(a,n,o);case b.SHORT:return new Int16Array(a,n,o);case b.UNSIGNED_SHORT:return new Uint16Array(a,n,o);default:return new Float32Array(a,n,o)}},e.GetBufferFromAccessor=function(t,n){var o=t.bufferViews[n.bufferView],r=n.count*e.GetByteStrideFromType(n);return e.GetBufferFromBufferView(t,o,n.byteOffset,r,n.componentType)},e.DecodeBufferToText=function(e){for(var t="",n=e.byteLength,o=0;o<n;++o)t+=String.fromCharCode(e[o]);return t},e.GetDefaultMaterial=function(t){if(!e._DefaultMaterial){I.a.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),I.a.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join("\n");var n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};e._DefaultMaterial=new q.a("GLTFDefaultMaterial",t,{vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n),e._DefaultMaterial.setColor4("u_emission",new L.b(.5,.5,.5,1))}return e._DefaultMaterial},e._DefaultMaterial=null,e}(),J=n(203);!function(e){e[e.IDENTIFIER=1]="IDENTIFIER",e[e.UNKNOWN=2]="UNKNOWN",e[e.END_OF_INPUT=3]="END_OF_INPUT"}(M||(M={}));var $=function(){function e(e){this._pos=0,this.currentToken=M.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}return e.prototype.getNextToken=function(){if(this.isEnd())return M.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=M.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=M.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken},e.prototype.peek=function(){return this._toParse[this._pos]},e.prototype.read=function(){return this._toParse[this._pos++]},e.prototype.forward=function(){this._pos++},e.prototype.isEnd=function(){return this._pos>=this._maxPos},e}(),ee=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],te=["world","view","projection","worldView","worldViewProjection","mBones"],ne=["translation","rotation","scale"],oe=["position","rotationQuaternion","scaling"],re=function(e,t,n){for(var o in e){var r=e[o];n[t][o]=r}},ie=function(e){if(e)for(var t=0;t<e.length/2;t++)e[2*t+1]=1-e[2*t+1]},ae=function(e){if("NORMAL"===e.semantic)return"normal";if("POSITION"===e.semantic)return"position";if("JOINT"===e.semantic)return"matricesIndices";if("WEIGHT"===e.semantic)return"matricesWeights";if("COLOR"===e.semantic)return"color";if(e.semantic&&-1!==e.semantic.indexOf("TEXCOORD_")){var t=Number(e.semantic.split("_")[1]);return"uv"+(0===t?"":t+1)}return null},se=function(e){var t=null;if(e.translation||e.rotation||e.scale){var n=C.e.FromArray(e.scale||[1,1,1]),o=C.b.FromArray(e.rotation||[0,0,0,1]),r=C.e.FromArray(e.translation||[0,0,0]);t=C.a.Compose(n,o,r)}else t=C.a.FromArray(e.matrix);return t},le=function e(t,n,o,r){for(var i=0;i<r.bones.length;i++)if(r.bones[i].name===o)return r.bones[i];var a=t.nodes;for(var s in a){var l=a[s];if(l.jointName){var u=l.children;for(i=0;i<u.length;i++){var c=t.nodes[u[i]];if(c.jointName&&c.jointName===o){var h=se(l),p=new N.a(l.name||"",r,e(t,n,l.jointName,r),h);return p.id=s,p}}}}return null},ue=function(e,t){for(var n=0;n<e.length;n++)for(var o=e[n],r=0;r<o.node.children.length;r++){if(o.node.children[r]===t)return o.bone}return null},ce=function(e,t){var n=e.nodes,o=n[t];if(o)return{node:o,id:t};for(var r in n)if((o=n[r]).jointName===t)return{node:o,id:r};return null},he=function(e,t){for(var n=0;n<e.jointNames.length;n++)if(e.jointNames[n]===t)return!0;return!1},pe=function(e,t,n,o,r){if(o||(o=new B.a(t.name||"","",e.scene)),!t.babylonSkeleton)return o;var i=[],s=[];!function(e,t,n,o){for(var r in e.nodes){var i=e.nodes[r],a=r;if(i.jointName&&!he(n,i.jointName)){var s=se(i),l=new N.a(i.name||"",t,null,s);l.id=a,o.push({bone:l,node:i,id:a})}}for(var u=0;u<o.length;u++)for(var c=o[u],h=c.node.children,p=0;p<h.length;p++){for(var d=null,f=0;f<o.length;f++)if(o[f].id===h[p]){d=o[f];break}d&&(d.bone._parent=c.bone,c.bone.children.push(d.bone))}}(e,o,t,i),o.bones=[];for(var l=0;l<t.jointNames.length;l++){if(_=ce(e,t.jointNames[l])){var u=_.node;if(u){r=_.id;var c=e.scene.getBoneByID(r);if(c)o.bones.push(c);else{for(var h=!1,p=null,d=0;d<l;d++){var f=ce(e,t.jointNames[d]);if(f){var y=f.node;if(y){var v=y.children;if(v){h=!1;for(var m=0;m<v.length;m++)if(v[m]===r){p=le(e,t,t.jointNames[d],o),h=!0;break}if(h)break}}else a.b.Warn("Joint named "+t.jointNames[d]+" does not exist when looking for parent")}}var b=se(u);!p&&i.length>0&&(p=ue(i,r))&&-1===s.indexOf(p)&&s.push(p),new N.a(u.jointName||"",o,p,b).id=r}}else a.b.Warn("Joint named "+t.jointNames[l]+" does not exist")}}var g=o.bones;o.bones=[];for(l=0;l<t.jointNames.length;l++){var _;if(_=ce(e,t.jointNames[l]))for(d=0;d<g.length;d++)if(g[d].id===_.id){o.bones.push(g[d]);break}}o.prepare();for(l=0;l<s.length;l++)o.bones.push(s[l]);return o},de=function(e,t,n,o,r){if(r||(e.scene._blockEntityCollection=e.forAssetContainer,r=new H.a(t.name||"",e.scene),e.scene._blockEntityCollection=!1,r.id=o),!t.babylonNode)return r;for(var i,a=[],s=null,l=new Array,u=new Array,c=new Array,h=new Array,p=0;p<n.length;p++){var d=n[p];if(L=e.meshes[d])for(var f=0;f<L.primitives.length;f++){var y=new W.a,v=L.primitives[f];v.mode;var b=v.attributes,g=null,_=null;for(var x in b)if(g=e.accessors[b[x]],_=Z.GetBufferFromAccessor(e,g),"NORMAL"===x)y.normals=new Float32Array(_.length),y.normals.set(_);else if("POSITION"===x){if(m.HomogeneousCoordinates){y.positions=new Float32Array(_.length-_.length/4);for(var A=0;A<_.length;A+=4)y.positions[A]=_[A],y.positions[A+1]=_[A+1],y.positions[A+2]=_[A+2]}else y.positions=new Float32Array(_.length),y.positions.set(_);u.push(y.positions.length)}else if(-1!==x.indexOf("TEXCOORD_")){var w=Number(x.split("_")[1]),E=k.b.UVKind+(0===w?"":w+1),T=new Float32Array(_.length);T.set(_),ie(T),y.set(T,E)}else"JOINT"===x?(y.matricesIndices=new Float32Array(_.length),y.matricesIndices.set(_)):"WEIGHT"===x?(y.matricesWeights=new Float32Array(_.length),y.matricesWeights.set(_)):"COLOR"===x&&(y.colors=new Float32Array(_.length),y.colors.set(_));if(g=e.accessors[v.indices])_=Z.GetBufferFromAccessor(e,g),y.indices=new Int32Array(_.length),y.indices.set(_),h.push(y.indices.length);else{var S=[];for(A=0;A<y.positions.length/3;A++)S.push(A);y.indices=new Int32Array(S),h.push(y.indices.length)}s?s.merge(y):s=y;var M=e.scene.getMaterialByID(v.material);a.push(null===M?Z.GetDefaultMaterial(e.scene):M),l.push(0===l.length?0:l[l.length-1]+u[u.length-2]),c.push(0===c.length?0:c[c.length-1]+h[h.length-2])}}e.scene._blockEntityCollection=e.forAssetContainer,a.length>1?(i=new V.a("multimat"+o,e.scene)).subMaterials=a:i=new D.a("multimat"+o,e.scene),1===a.length&&(i=a[0]),r.material||(r.material=i),new j.a(o,e.scene,s,!1,r),r.computeWorldMatrix(!0),e.scene._blockEntityCollection=!1,r.subMeshes=[];var C=0;for(p=0;p<n.length;p++){var L;d=n[p];if(L=e.meshes[d])for(f=0;f<L.primitives.length;f++)L.primitives[f].mode,U.b.AddToMesh(C,l[C],u[C],c[C],h[C],r,r,!0),C++}return r},fe=function(e,t,n,o){e.position&&(e.position=t),(e.rotationQuaternion||e.rotation)&&(e.rotationQuaternion=n),e.scaling&&(e.scaling=o)},ye=function(e,t,n,o){var r=null;if(e.importOnlyMeshes&&(t.skin||t.meshes)&&e.importMeshesNames&&e.importMeshesNames.length>0&&-1===e.importMeshesNames.indexOf(t.name||""))return null;if(t.skin){if(t.meshes){var i=e.skins[t.skin];(a=de(e,t,t.meshes,n,t.babylonNode)).skeleton=e.scene.getLastSkeletonByID(t.skin),null===a.skeleton&&(a.skeleton=pe(e,i,0,i.babylonSkeleton,t.skin),i.babylonSkeleton||(i.babylonSkeleton=a.skeleton)),r=a}}else if(t.meshes){var a;r=a=de(e,t,t.mesh?[t.mesh]:t.meshes,n,t.babylonNode)}else if(!t.light||t.babylonNode||e.importOnlyMeshes){if(t.camera&&!t.babylonNode&&!e.importOnlyMeshes){var s=e.cameras[t.camera];if(s){if(e.scene._blockEntityCollection=e.forAssetContainer,"orthographic"===s.type){var l=new O.a(t.camera,C.e.Zero(),e.scene,!1);l.name=t.name||"",l.mode=R.a.ORTHOGRAPHIC_CAMERA,l.attachControl(e.scene.getEngine().getInputElement()),r=l}else if("perspective"===s.type){var u=s[s.type],c=new O.a(t.camera,C.e.Zero(),e.scene,!1);c.name=t.name||"",c.attachControl(e.scene.getEngine().getInputElement()),u.aspectRatio||(u.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),u.znear&&u.zfar&&(c.maxZ=u.zfar,c.minZ=u.znear),r=c}e.scene._blockEntityCollection=!1}}}else{var h=e.lights[t.light];if(h)if("ambient"===h.type){var p=h[h.type],d=new K.a(t.light,C.e.Zero(),e.scene);d.name=t.name||"",p.color&&(d.diffuse=L.a.FromArray(p.color)),r=d}else if("directional"===h.type){var f=h[h.type],y=new X.a(t.light,C.e.Zero(),e.scene);y.name=t.name||"",f.color&&(y.diffuse=L.a.FromArray(f.color)),r=y}else if("point"===h.type){var v=h[h.type],m=new Y.a(t.light,C.e.Zero(),e.scene);m.name=t.name||"",v.color&&(m.diffuse=L.a.FromArray(v.color)),r=m}else if("spot"===h.type){var b=h[h.type],g=new Q.a(t.light,C.e.Zero(),C.e.Zero(),0,0,e.scene);g.name=t.name||"",b.color&&(g.diffuse=L.a.FromArray(b.color)),b.fallOfAngle&&(g.angle=b.fallOfAngle),b.fallOffExponent&&(g.exponent=b.fallOffExponent),r=g}}if(!t.jointName){if(t.babylonNode)return t.babylonNode;if(null===r){e.scene._blockEntityCollection=e.forAssetContainer;var _=new H.a(t.name||"",e.scene);e.scene._blockEntityCollection=!1,t.babylonNode=_,r=_}}if(null!==r){if(t.matrix&&r instanceof H.a)!function(e,t,n){if(t.matrix){var o=new C.e(0,0,0),r=new C.b,i=new C.e(0,0,0);C.a.FromArray(t.matrix).decompose(i,r,o),fe(e,o,r,i)}else t.translation&&t.rotation&&t.scale&&fe(e,C.e.FromArray(t.translation),C.b.FromArray(t.rotation),C.e.FromArray(t.scale));e.computeWorldMatrix(!0)}(r,t);else{var x=t.translation||[0,0,0],A=t.rotation||[0,0,0,1],w=t.scale||[1,1,1];fe(r,C.e.FromArray(x),C.b.FromArray(A),C.e.FromArray(w))}r.updateCache(!0),t.babylonNode=r}return r},ve=function e(t,n,o,r){void 0===r&&(r=!1);var i=t.nodes[n],a=null;if(r=!(t.importOnlyMeshes&&!r&&t.importMeshesNames)||(-1!==t.importMeshesNames.indexOf(i.name||"")||0===t.importMeshesNames.length),!i.jointName&&r&&null!==(a=ye(t,i,n))&&(a.id=n,a.parent=o),i.children)for(var s=0;s<i.children.length;s++)e(t,i.children[s],a,r)},me=function(e){var t=e.currentScene;if(t)for(var n=0;n<t.nodes.length;n++)ve(e,t.nodes[n],null);else for(var o in e.scenes){t=e.scenes[o];for(n=0;n<t.nodes.length;n++)ve(e,t.nodes[n],null)}!function(e){for(var t in e.animations){var n=e.animations[t];if(n.channels&&n.samplers)for(var o=null,r=0;r<n.channels.length;r++){var i=n.channels[r],s=n.samplers[i.sampler];if(s){var l=null,u=null;n.parameters?(l=n.parameters[s.input],u=n.parameters[s.output]):(l=s.input,u=s.output);var c=Z.GetBufferFromAccessor(e,e.accessors[l]),h=Z.GetBufferFromAccessor(e,e.accessors[u]),p=i.target.id,d=e.scene.getNodeByID(p);if(null===d&&(d=e.scene.getNodeByName(p)),null!==d){var f=d instanceof N.a,y=i.target.path,v=ne.indexOf(y);-1!==v&&(y=oe[v]);var m=P.a.ANIMATIONTYPE_MATRIX;f||("rotationQuaternion"===y?(m=P.a.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new C.b):m=P.a.ANIMATIONTYPE_VECTOR3);var b=null,g=[],_=0,x=!1;f&&o&&o.getKeys().length===c.length&&(b=o,x=!0),x||(e.scene._blockEntityCollection=e.forAssetContainer,b=new P.a(t,f?"_matrix":y,1,m,P.a.ANIMATIONLOOPMODE_CYCLE),e.scene._blockEntityCollection=!1);for(var A=0;A<c.length;A++){var w=null;if("rotationQuaternion"===y?(w=C.b.FromArray([h[_],h[_+1],h[_+2],h[_+3]]),_+=4):(w=C.e.FromArray([h[_],h[_+1],h[_+2]]),_+=3),f){var E=d,T=C.e.Zero(),S=new C.b,M=C.e.Zero(),L=E.getBaseMatrix();x&&o&&(L=o.getKeys()[A].value),L.decompose(M,S,T),"position"===y?T=w:"rotationQuaternion"===y?S=w:M=w,w=C.a.Compose(M,S,T)}x?o&&(o.getKeys()[A].value=w):g.push({frame:c[A],value:w})}!x&&b&&(b.setKeys(g),d.animations.push(b)),o=b,e.scene.stopAnimation(d),e.scene.beginAnimation(d,0,c[c.length-1],!0,1)}else a.b.Warn("Creating animation named "+t+". But cannot find node named "+p+" to attach to")}}}}(e);for(n=0;n<e.scene.skeletons.length;n++){var r=e.scene.skeletons[n];e.scene.beginAnimation(r,0,Number.MAX_VALUE,!0,1)}},be=function(e,t,n,o,r,i){return function(a){!function(e,t,n,o,r){var i=o.values||n.parameters,a=n.uniforms;for(var s in r){var l=r[s],u=l.type,c=i[a[s]];if(void 0===c&&(c=l.value),c){var h=function(e){return function(n){l.value&&e&&(t.setTexture(e,n),delete r[e])}};u===_.SAMPLER_2D?we.LoadTextureAsync(e,o.values?c:l.value,h(s),(function(){return h(null)})):l.value&&Z.SetUniform(t,s,o.values?c:l.value,u)&&delete r[s]}}}(e,t,n,o,r),t.onBind=function(a){!function(e,t,n,o,r,i,a){var s=i.values||r.parameters;for(var l in n){var u=n[l],c=u.type;if(c===_.FLOAT_MAT2||c===_.FLOAT_MAT3||c===_.FLOAT_MAT4)if(!u.semantic||u.source||u.node){if(u.semantic&&(u.source||u.node)){var h=t.scene.getNodeByName(u.source||u.node||"");if(null===h&&(h=t.scene.getNodeByID(u.source||u.node||"")),null===h)continue;Z.SetMatrix(t.scene,h,u,l,o.getEffect())}}else Z.SetMatrix(t.scene,e,u,l,o.getEffect());else{var p=s[r.uniforms[l]];if(!p)continue;if(c===_.SAMPLER_2D){var d=t.textures[i.values?p:u.value].babylonTexture;if(null===d||void 0===d)continue;o.getEffect().setTexture(l,d)}else Z.SetUniform(o.getEffect(),l,p,c)}}a(o)}(a,e,r,t,n,o,i)}}},ge=function(e,t,n){for(var o in t.uniforms){var r=t.uniforms[o],i=t.parameters[r];if(e.currentIdentifier===o&&i.semantic&&!i.source&&!i.node){var a=ee.indexOf(i.semantic);if(-1!==a)return delete n[o],te[a]}}return e.currentIdentifier},_e=function(e){for(var t in e.materials)we.LoadMaterialAsync(e,t,(function(e){}),(function(){}))},xe=function(){function e(){}return e.CreateRuntime=function(e,t,n){var o={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],forAssetContainer:!1};return e.extensions&&re(e.extensions,"extensions",o),e.extensionsUsed&&re(e.extensionsUsed,"extensionsUsed",o),e.buffers&&function(e,t){for(var n in e){var o=e[n];t.buffers[n]=o,t.buffersCount++}}(e.buffers,o),e.bufferViews&&re(e.bufferViews,"bufferViews",o),e.accessors&&re(e.accessors,"accessors",o),e.meshes&&re(e.meshes,"meshes",o),e.lights&&re(e.lights,"lights",o),e.cameras&&re(e.cameras,"cameras",o),e.nodes&&re(e.nodes,"nodes",o),e.images&&re(e.images,"images",o),e.textures&&re(e.textures,"textures",o),e.shaders&&function(e,t){for(var n in e){var o=e[n];t.shaders[n]=o,t.shaderscount++}}(e.shaders,o),e.programs&&re(e.programs,"programs",o),e.samplers&&re(e.samplers,"samplers",o),e.techniques&&re(e.techniques,"techniques",o),e.materials&&re(e.materials,"materials",o),e.animations&&re(e.animations,"animations",o),e.skins&&re(e.skins,"skins",o),e.scenes&&(o.scenes=e.scenes),e.scene&&e.scenes&&(o.currentScene=e.scenes[e.scene]),o},e.LoadBufferAsync=function(e,t,n,o,r){var i=e.buffers[t];a.b.IsBase64(i.uri)?setTimeout((function(){return n(new Uint8Array(a.b.DecodeBase64(i.uri)))})):a.b.LoadFile(e.rootUrl+i.uri,(function(e){return n(new Uint8Array(e))}),r,void 0,!0,(function(e){e&&o(e.status+" "+e.statusText)}))},e.LoadTextureBufferAsync=function(e,t,n,o){var r=e.textures[t];if(r&&r.source)if(r.babylonTexture)n(null);else{var i=e.images[r.source];a.b.IsBase64(i.uri)?setTimeout((function(){return n(new Uint8Array(a.b.DecodeBase64(i.uri)))})):a.b.LoadFile(e.rootUrl+i.uri,(function(e){return n(new Uint8Array(e))}),void 0,void 0,!0,(function(e){e&&o(e.status+" "+e.statusText)}))}else o("")},e.CreateTextureAsync=function(e,t,n,o,r){var i=e.textures[t];if(i.babylonTexture)o(i.babylonTexture);else{var a=e.samplers[i.sampler],s=a.minFilter===A.NEAREST_MIPMAP_NEAREST||a.minFilter===A.NEAREST_MIPMAP_LINEAR||a.minFilter===A.LINEAR_MIPMAP_NEAREST||a.minFilter===A.LINEAR_MIPMAP_LINEAR,l=z.a.BILINEAR_SAMPLINGMODE,u=null==n?new Blob:new Blob([n]),c=URL.createObjectURL(u),h=function(){return URL.revokeObjectURL(c)},p=new z.a(c,e.scene,!s,!0,l,h,h);void 0!==a.wrapS&&(p.wrapU=Z.GetWrapMode(a.wrapS)),void 0!==a.wrapT&&(p.wrapV=Z.GetWrapMode(a.wrapT)),p.name=t,i.babylonTexture=p,o(p)}},e.LoadShaderStringAsync=function(e,t,n,o){var r=e.shaders[t];if(a.b.IsBase64(r.uri)){var i=atob(r.uri.split(",")[1]);n&&n(i)}else a.b.LoadFile(e.rootUrl+r.uri,n,void 0,void 0,!1,(function(e){e&&o&&o(e.status+" "+e.statusText)}))},e.LoadMaterialAsync=function(e,t,n,o){var r=e.materials[t];if(r.technique){var i=e.techniques[r.technique];if(!i){e.scene._blockEntityCollection=e.forAssetContainer;var a=new D.a(t,e.scene);return e.scene._blockEntityCollection=!1,a.diffuseColor=new L.a(.5,.5,.5),a.sideOrientation=F.a.CounterClockWiseSideOrientation,void n(a)}var s=e.programs[i.program],l=i.states,u=I.a.ShadersStore[s.vertexShader+"VertexShader"],c=I.a.ShadersStore[s.fragmentShader+"PixelShader"],h="",p="",d=new $(u),f=new $(c),y={},v=[],m=[],b=[];for(var g in i.uniforms){var x=i.uniforms[g],A=i.parameters[x];if(y[g]=A,!A.semantic||A.node||A.source)A.type===_.SAMPLER_2D?b.push(g):v.push(g);else{var w=ee.indexOf(A.semantic);-1!==w?(v.push(te[w]),delete y[g]):v.push(g)}}for(var S in i.attributes){var C=i.attributes[S];if((P=i.parameters[C]).semantic){var R=ae(P);R&&m.push(R)}}for(;!d.isEnd()&&d.getNextToken();){if(d.currentToken===M.IDENTIFIER){var O=!1;for(var S in i.attributes){C=i.attributes[S];var P=i.parameters[C];if(d.currentIdentifier===S&&P.semantic){h+=ae(P),O=!0;break}}O||(h+=ge(d,i,y))}else h+=d.currentString}for(;!f.isEnd()&&f.getNextToken();){f.currentToken===M.IDENTIFIER?p+=ge(f,i,y):p+=f.currentString}var N={vertex:s.vertexShader+t,fragment:s.fragmentShader+t},B={attributes:m,uniforms:v,samplers:b,needAlphaBlending:l&&l.enable&&-1!==l.enable.indexOf(3042)};I.a.ShadersStore[s.vertexShader+t+"VertexShader"]=h,I.a.ShadersStore[s.fragmentShader+t+"PixelShader"]=p;var V=new q.a(t,e.scene,N,B);if(V.onError=function(e,t,n){return function(o,r){t.dispose(!0),n("Cannot compile program named "+e.name+". Error: "+r+". Default material will be applied")}}(s,V,o),V.onCompiled=be(e,V,i,r,y,n),V.sideOrientation=F.a.CounterClockWiseSideOrientation,l&&l.functions){var z=l.functions;z.cullFace&&z.cullFace[0]!==E.BACK&&(V.backFaceCulling=!1);var W=z.blendFuncSeparate;W&&(W[0]===T.SRC_ALPHA&&W[1]===T.ONE_MINUS_SRC_ALPHA&&W[2]===T.ONE&&W[3]===T.ONE?V.alphaMode=J.a.ALPHA_COMBINE:W[0]===T.ONE&&W[1]===T.ONE&&W[2]===T.ZERO&&W[3]===T.ONE?V.alphaMode=J.a.ALPHA_ONEONE:W[0]===T.SRC_ALPHA&&W[1]===T.ONE&&W[2]===T.ZERO&&W[3]===T.ONE?V.alphaMode=J.a.ALPHA_ADD:W[0]===T.ZERO&&W[1]===T.ONE_MINUS_SRC_COLOR&&W[2]===T.ONE&&W[3]===T.ONE?V.alphaMode=J.a.ALPHA_SUBTRACT:W[0]===T.DST_COLOR&&W[1]===T.ZERO&&W[2]===T.ONE&&W[3]===T.ONE?V.alphaMode=J.a.ALPHA_MULTIPLY:W[0]===T.SRC_ALPHA&&W[1]===T.ONE_MINUS_SRC_COLOR&&W[2]===T.ONE&&W[3]===T.ONE&&(V.alphaMode=J.a.ALPHA_MAXIMIZED))}}else o&&o("No technique found.")},e}(),Ae=function(){function e(){this.state=null}return e.RegisterExtension=function(t){e.Extensions[t.name]?a.b.Error('Tool with the same name "'+t.name+'" already exists'):e.Extensions[t.name]=t},e.prototype.dispose=function(){},e.prototype._importMeshAsync=function(e,t,n,o,r,i,s,l){var u=this;return t.useRightHandedSystem=!0,we.LoadRuntimeAsync(t,n,o,(function(t){t.forAssetContainer=r,t.importOnlyMeshes=!0,""===e?t.importMeshesNames=[]:"string"===typeof e?t.importMeshesNames=[e]:!e||e instanceof Array?(t.importMeshesNames=[],a.b.Warn("Argument meshesNames must be of type string or string[]")):t.importMeshesNames=[e],u._createNodes(t);var n=new Array,o=new Array;for(var l in t.nodes){var c=t.nodes[l];c.babylonNode instanceof G.a&&n.push(c.babylonNode)}for(var h in t.skins){var p=t.skins[h];p.babylonSkeleton instanceof B.a&&o.push(p.babylonSkeleton)}u._loadBuffersAsync(t,(function(){u._loadShadersAsync(t,(function(){_e(t),me(t),!m.IncrementalLoading&&i&&i(n,o)}))}),s),m.IncrementalLoading&&i&&i(n,o)}),l),!0},e.prototype.importMeshAsync=function(e,t,n,o,r,i){var a=this;return new Promise((function(s,l){a._importMeshAsync(e,t,o,r,n,(function(e,t){s({meshes:e,particleSystems:[],skeletons:t,animationGroups:[],lights:[],transformNodes:[]})}),i,(function(e){l(new Error(e))}))}))},e.prototype._loadAsync=function(e,t,n,o,r,i,a){var s=this;e.useRightHandedSystem=!0,we.LoadRuntimeAsync(e,t,n,(function(e){we.LoadRuntimeExtensionsAsync(e,(function(){s._createNodes(e),s._loadBuffersAsync(e,(function(){s._loadShadersAsync(e,(function(){_e(e),me(e),m.IncrementalLoading||r()}))})),m.IncrementalLoading&&r()}),a)}),a)},e.prototype.loadAsync=function(e,t,n,o){var r=this;return new Promise((function(i,a){r._loadAsync(e,t,n,!1,(function(){i()}),o,(function(e){a(new Error(e))}))}))},e.prototype._loadShadersAsync=function(e,t){var n=!1,o=function(n,o){we.LoadShaderStringAsync(e,n,(function(r){r instanceof ArrayBuffer||(e.loadedShaderCount++,r&&(I.a.ShadersStore[n+(o.type===g.VERTEX?"VertexShader":"PixelShader")]=r),e.loadedShaderCount===e.shaderscount&&t())}),(function(){a.b.Error("Error when loading shader program named "+n+" located at "+o.uri)}))};for(var r in e.shaders){n=!0;var i=e.shaders[r];i?o.bind(this,r,i)():a.b.Error("No shader named: "+r)}n||t()},e.prototype._loadBuffersAsync=function(e,t,n){var o=!1,r=function(n,o){we.LoadBufferAsync(e,n,(function(r){e.loadedBufferCount++,r&&(r.byteLength!=e.buffers[n].byteLength&&a.b.Error("Buffer named "+n+" is length "+r.byteLength+". Expected: "+o.byteLength),e.loadedBufferViews[n]=r),e.loadedBufferCount===e.buffersCount&&t()}),(function(){a.b.Error("Error when loading buffer named "+n+" located at "+o.uri)}))};for(var i in e.buffers){o=!0;var s=e.buffers[i];s?r.bind(this,i,s)():a.b.Error("No buffer named: "+i)}o||t()},e.prototype._createNodes=function(e){var t=e.currentScene;if(t)for(var n=0;n<t.nodes.length;n++)ve(e,t.nodes[n],null);else for(var o in e.scenes){t=e.scenes[o];for(n=0;n<t.nodes.length;n++)ve(e,t.nodes[n],null)}},e.Extensions={},e}(),we=function(){function e(e){this._name=e}return Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),e.prototype.loadRuntimeAsync=function(e,t,n,o,r){return!1},e.prototype.loadRuntimeExtensionsAsync=function(e,t,n){return!1},e.prototype.loadBufferAsync=function(e,t,n,o,r){return!1},e.prototype.loadTextureBufferAsync=function(e,t,n,o){return!1},e.prototype.createTextureAsync=function(e,t,n,o,r){return!1},e.prototype.loadShaderStringAsync=function(e,t,n,o){return!1},e.prototype.loadMaterialAsync=function(e,t,n,o){return!1},e.LoadRuntimeAsync=function(t,n,o,r,i){e.ApplyExtensions((function(e){return e.loadRuntimeAsync(t,n,o,r,i)}),(function(){setTimeout((function(){r&&r(xe.CreateRuntime(n.json,t,o))}))}))},e.LoadRuntimeExtensionsAsync=function(t,n,o){e.ApplyExtensions((function(e){return e.loadRuntimeExtensionsAsync(t,n,o)}),(function(){setTimeout((function(){n()}))}))},e.LoadBufferAsync=function(t,n,o,r,i){e.ApplyExtensions((function(e){return e.loadBufferAsync(t,n,o,r,i)}),(function(){xe.LoadBufferAsync(t,n,o,r,i)}))},e.LoadTextureAsync=function(t,n,o,r){e.LoadTextureBufferAsync(t,n,(function(i){i&&e.CreateTextureAsync(t,n,i,o,r)}),r)},e.LoadShaderStringAsync=function(t,n,o,r){e.ApplyExtensions((function(e){return e.loadShaderStringAsync(t,n,o,r)}),(function(){xe.LoadShaderStringAsync(t,n,o,r)}))},e.LoadMaterialAsync=function(t,n,o,r){e.ApplyExtensions((function(e){return e.loadMaterialAsync(t,n,o,r)}),(function(){xe.LoadMaterialAsync(t,n,o,r)}))},e.LoadTextureBufferAsync=function(t,n,o,r){e.ApplyExtensions((function(e){return e.loadTextureBufferAsync(t,n,o,r)}),(function(){xe.LoadTextureBufferAsync(t,n,o,r)}))},e.CreateTextureAsync=function(t,n,o,r,i){e.ApplyExtensions((function(e){return e.createTextureAsync(t,n,o,r,i)}),(function(){xe.CreateTextureAsync(t,n,o,r,i)}))},e.ApplyExtensions=function(e,t){for(var n in Ae.Extensions){if(e(Ae.Extensions[n]))return}t()},e}();m._CreateGLTF1Loader=function(){return new Ae};var Ee=function(e){function t(){return e.call(this,"KHR_binary_glTF")||this}return Object(S.d)(t,e),t.prototype.loadRuntimeAsync=function(e,t,n,o,r){var i=t.json.extensionsUsed;return!(!i||-1===i.indexOf(this.name)||!t.bin)&&(this._bin=t.bin,o(xe.CreateRuntime(t.json,e,n)),!0)},t.prototype.loadBufferAsync=function(e,t,n,o){return-1!==e.extensionsUsed.indexOf(this.name)&&("binary_glTF"===t&&(this._bin.readAsync(0,this._bin.byteLength).then(n,(function(e){return o(e.message)})),!0))},t.prototype.loadTextureBufferAsync=function(e,t,n,o){var r=e.textures[t],i=e.images[r.source];if(!i.extensions||!(this.name in i.extensions))return!1;var a=i.extensions[this.name],s=e.bufferViews[a.bufferView];return n(Z.GetBufferFromBufferView(e,s,0,s.byteLength,b.UNSIGNED_BYTE)),!0},t.prototype.loadShaderStringAsync=function(e,t,n,o){var r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;var i=r.extensions[this.name],a=e.bufferViews[i.bufferView],s=Z.GetBufferFromBufferView(e,a,0,a.byteLength,b.UNSIGNED_BYTE);return setTimeout((function(){var e=Z.DecodeBufferToText(s);n(e)})),!0},t}(we);Ae.RegisterExtension(new Ee);var Te=function(e){function t(){return e.call(this,"KHR_materials_common")||this}return Object(S.d)(t,e),t.prototype.loadRuntimeExtensionsAsync=function(e,t,n){if(!e.extensions)return!1;var o=e.extensions[this.name];if(!o)return!1;var r=o.lights;if(r)for(var i in r){var s=r[i];switch(s.type){case"ambient":var l=new K.a(s.name,new C.e(0,1,0),e.scene),u=s.ambient;u&&(l.diffuse=L.a.FromArray(u.color||[1,1,1]));break;case"point":var c=new Y.a(s.name,new C.e(10,10,10),e.scene),h=s.point;h&&(c.diffuse=L.a.FromArray(h.color||[1,1,1]));break;case"directional":var p=new X.a(s.name,new C.e(0,-1,0),e.scene),d=s.directional;d&&(p.diffuse=L.a.FromArray(d.color||[1,1,1]));break;case"spot":var f=s.spot;if(f)new Q.a(s.name,new C.e(0,10,0),new C.e(0,-1,0),f.fallOffAngle||Math.PI,f.fallOffExponent||0,e.scene).diffuse=L.a.FromArray(f.color||[1,1,1]);break;default:a.b.Warn('GLTF Material Common extension: light type "'+s.type+"\u201d not supported")}}return!1},t.prototype.loadMaterialAsync=function(e,t,n,o){var r=e.materials[t];if(!r||!r.extensions)return!1;var i=r.extensions[this.name];if(!i)return!1;var a=new D.a(t,e.scene);return a.sideOrientation=F.a.CounterClockWiseSideOrientation,"CONSTANT"===i.technique&&(a.disableLighting=!0),a.backFaceCulling=void 0!==i.doubleSided&&!i.doubleSided,a.alpha=void 0===i.values.transparency?1:i.values.transparency,a.specularPower=void 0===i.values.shininess?0:i.values.shininess,"string"===typeof i.values.ambient?this._loadTexture(e,i.values.ambient,a,"ambientTexture",o):a.ambientColor=L.a.FromArray(i.values.ambient||[0,0,0]),"string"===typeof i.values.diffuse?this._loadTexture(e,i.values.diffuse,a,"diffuseTexture",o):a.diffuseColor=L.a.FromArray(i.values.diffuse||[0,0,0]),"string"===typeof i.values.emission?this._loadTexture(e,i.values.emission,a,"emissiveTexture",o):a.emissiveColor=L.a.FromArray(i.values.emission||[0,0,0]),"string"===typeof i.values.specular?this._loadTexture(e,i.values.specular,a,"specularTexture",o):a.specularColor=L.a.FromArray(i.values.specular||[0,0,0]),!0},t.prototype._loadTexture=function(e,t,n,o,r){xe.LoadTextureBufferAsync(e,t,(function(i){xe.CreateTextureAsync(e,t,i,(function(e){return n[o]=e}),r)}),r)},t}(we);Ae.RegisterExtension(new Te);var Se=n(205),Me=n(133),Ce=n(122),Le=n(50),Re=n(165),Oe=n(146),Pe=n(160),Ne=n(59),Be=function(){function e(){}return e.Get=function(e,t,n){if(!t||void 0==n||!t[n])throw new Error(e+": Failed to find index ("+n+")");return t[n]},e.Assign=function(e){if(e)for(var t=0;t<e.length;t++)e[t].index=t},e}(),Ie=function(){function e(e){this._completePromises=new Array,this._forAssetContainer=!1,this._babylonLights=[],this._disposed=!1,this._state=null,this._extensions=new Array,this._defaultBabylonMaterialData={},this._requests=new Array,this._parent=e}return e.RegisterExtension=function(t,n){e.UnregisterExtension(t)&&u.a.Warn("Extension with the name '"+t+"' already exists"),e._RegisteredExtensions[t]={factory:n}},e.UnregisterExtension=function(t){return!!e._RegisteredExtensions[t]&&(delete e._RegisteredExtensions[t],!0)},Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gltf",{get:function(){return this._gltf},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bin",{get:function(){return this._bin},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"babylonScene",{get:function(){return this._babylonScene},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rootBabylonMesh",{get:function(){return this._rootBabylonMesh},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){if(!this._disposed){this._disposed=!0;for(var e=0,t=this._requests;e<t.length;e++){t[e].abort()}for(var n in this._requests.length=0,this._completePromises.length=0,this._extensions){var o=this._extensions[n];o.dispose&&o.dispose(),delete this._extensions[n]}delete this._gltf,delete this._babylonScene,delete this._rootBabylonMesh,delete this._progressCallback,this._parent._clear()}},e.prototype.importMeshAsync=function(e,t,n,o,r,i,a){var s=this;return Promise.resolve().then((function(){s._babylonScene=t,s._rootUrl=r,s._fileName=a||"scene",s._progressCallback=i,s._forAssetContainer=n,s._loadData(o);var l=null;if(e){var u={};if(s._gltf.nodes)for(var c=0,h=s._gltf.nodes;c<h.length;c++){var p=h[c];p.name&&(u[p.name]=p.index)}l=(e instanceof Array?e:[e]).map((function(e){var t=u[e];if(void 0===t)throw new Error("Failed to find node '"+e+"'");return t}))}return s._loadAsync(l,(function(){return{meshes:s._getMeshes(),particleSystems:[],skeletons:s._getSkeletons(),animationGroups:s._getAnimationGroups(),lights:s._babylonLights,transformNodes:s._getTransformNodes()}}))}))},e.prototype.loadAsync=function(e,t,n,o,r){var i=this;return Promise.resolve().then((function(){return i._babylonScene=e,i._rootUrl=n,i._fileName=r||"scene",i._progressCallback=o,i._loadData(t),i._loadAsync(null,(function(){}))}))},e.prototype._loadAsync=function(e,t){var n=this;return Promise.resolve().then((function(){n._uniqueRootUrl=-1===n._rootUrl.indexOf("file:")&&n._fileName?n._rootUrl:""+n._rootUrl+Date.now()+"/",n._loadExtensions(),n._checkExtensions();var o=y[y.LOADING]+" => "+y[y.READY],r=y[y.LOADING]+" => "+y[y.COMPLETE];n._parent._startPerformanceCounter(o),n._parent._startPerformanceCounter(r),n._setState(y.LOADING),n._extensionsOnLoading();var i=new Array,s=n._babylonScene.blockMaterialDirtyMechanism;if(n._babylonScene.blockMaterialDirtyMechanism=!0,e)i.push(n.loadSceneAsync("/nodes",{nodes:e,index:-1}));else if(void 0!=n._gltf.scene||n._gltf.scenes&&n._gltf.scenes[0]){var l=Be.Get("/scene",n._gltf.scenes,n._gltf.scene||0);i.push(n.loadSceneAsync("/scenes/"+l.index,l))}n._babylonScene.blockMaterialDirtyMechanism=s,n._parent.compileMaterials&&i.push(n._compileMaterialsAsync()),n._parent.compileShadowGenerators&&i.push(n._compileShadowGeneratorsAsync());var u=Promise.all(i).then((function(){return n._rootBabylonMesh&&n._rootBabylonMesh.setEnabled(!0),n._setState(y.READY),n._extensionsOnReady(),n._startAnimations(),t()}));return u.then((function(){n._parent._endPerformanceCounter(o),a.b.SetImmediate((function(){n._disposed||Promise.all(n._completePromises).then((function(){n._parent._endPerformanceCounter(r),n._setState(y.COMPLETE),n._parent.onCompleteObservable.notifyObservers(void 0),n._parent.onCompleteObservable.clear(),n.dispose()}),(function(e){n._parent.onErrorObservable.notifyObservers(e),n._parent.onErrorObservable.clear(),n.dispose()}))}))})),u}),(function(e){throw n._disposed||(n._parent.onErrorObservable.notifyObservers(e),n._parent.onErrorObservable.clear(),n.dispose()),e}))},e.prototype._loadData=function(e){if(this._gltf=e.json,this._setupData(),e.bin){var t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){var n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&u.a.Warn("Binary buffer length ("+n.byteLength+") from JSON does not match chunk length ("+e.bin.byteLength+")"),this._bin=e.bin}else u.a.Warn("Unexpected BIN chunk")}},e.prototype._setupData=function(){if(Be.Assign(this._gltf.accessors),Be.Assign(this._gltf.animations),Be.Assign(this._gltf.buffers),Be.Assign(this._gltf.bufferViews),Be.Assign(this._gltf.cameras),Be.Assign(this._gltf.images),Be.Assign(this._gltf.materials),Be.Assign(this._gltf.meshes),Be.Assign(this._gltf.nodes),Be.Assign(this._gltf.samplers),Be.Assign(this._gltf.scenes),Be.Assign(this._gltf.skins),Be.Assign(this._gltf.textures),this._gltf.nodes){for(var e={},t=0,n=this._gltf.nodes;t<n.length;t++){if((l=n[t]).children)for(var o=0,r=l.children;o<r.length;o++){e[r[o]]=l.index}}for(var i=this._createRootNode(),a=0,s=this._gltf.nodes;a<s.length;a++){var l,u=e[(l=s[a]).index];l.parent=void 0===u?i:this._gltf.nodes[u]}}},e.prototype._loadExtensions=function(){for(var t in e._RegisteredExtensions){var n=e._RegisteredExtensions[t].factory(this);n.name!==t&&u.a.Warn("The name of the glTF loader extension instance does not match the registered name: "+n.name+" !== "+t),this._extensions.push(n),this._parent.onExtensionLoadedObservable.notifyObservers(n)}this._extensions.sort((function(e,t){return(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)})),this._parent.onExtensionLoadedObservable.clear()},e.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var e=function(e){if(!t._extensions.some((function(t){return t.name===e&&t.enabled})))throw new Error("Require extension "+e+" is not available")},t=this,n=0,o=this._gltf.extensionsRequired;n<o.length;n++){e(o[n])}},e.prototype._setState=function(e){this._state=e,this.log(y[this._state])},e.prototype._createRootNode=function(){this._babylonScene._blockEntityCollection=this._forAssetContainer,this._rootBabylonMesh=new H.a("__root__",this._babylonScene),this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);var t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case d.AUTO:this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],e._LoadTransform(t,this._rootBabylonMesh));break;case d.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error("Invalid coordinate system mode ("+this._parent.coordinateSystemMode+")")}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),t},e.prototype.loadSceneAsync=function(e,t){var n=this,o=this._extensionsLoadSceneAsync(e,t);if(o)return o;var r=new Array;if(this.logOpen(e+" "+(t.name||"")),t.nodes)for(var i=0,a=t.nodes;i<a.length;i++){var s=a[i],l=Be.Get(e+"/nodes/"+s,this._gltf.nodes,s);r.push(this.loadNodeAsync("/nodes/"+l.index,l,(function(e){e.parent=n._rootBabylonMesh})))}if(this._gltf.nodes)for(var u=0,c=this._gltf.nodes;u<c.length;u++){if((l=c[u])._babylonTransformNode&&l._babylonBones)for(var h=0,p=l._babylonBones;h<p.length;h++){p[h].linkTransformNode(l._babylonTransformNode)}}return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then((function(){}))},e.prototype._forEachPrimitive=function(e,t){if(e._primitiveBabylonMeshes)for(var n=0,o=e._primitiveBabylonMeshes;n<o.length;n++){t(o[n])}},e.prototype._getMeshes=function(){var e=new Array;e.push(this._rootBabylonMesh);var t=this._gltf.nodes;if(t)for(var n=0,o=t;n<o.length;n++){var r=o[n];this._forEachPrimitive(r,(function(t){e.push(t)}))}return e},e.prototype._getTransformNodes=function(){var e=new Array,t=this._gltf.nodes;if(t)for(var n=0,o=t;n<o.length;n++){var r=o[n];r._babylonTransformNode&&"TransformNode"===r._babylonTransformNode.getClassName()&&e.push(r._babylonTransformNode)}return e},e.prototype._getSkeletons=function(){var e=new Array,t=this._gltf.skins;if(t)for(var n=0,o=t;n<o.length;n++){var r=o[n];r._data&&e.push(r._data.babylonSkeleton)}return e},e.prototype._getAnimationGroups=function(){var e=new Array,t=this._gltf.animations;if(t)for(var n=0,o=t;n<o.length;n++){var r=o[n];r._babylonAnimationGroup&&e.push(r._babylonAnimationGroup)}return e},e.prototype._startAnimations=function(){switch(this._parent.animationStartMode){case f.NONE:break;case f.FIRST:0!==(e=this._getAnimationGroups()).length&&e[0].start(!0);break;case f.ALL:for(var e,t=0,n=e=this._getAnimationGroups();t<n.length;t++){n[t].start(!0)}break;default:return void u.a.Error("Invalid animation start mode ("+this._parent.animationStartMode+")")}},e.prototype.loadNodeAsync=function(t,n,o){var r=this;void 0===o&&(o=function(){});var i=this._extensionsLoadNodeAsync(t,n,o);if(i)return i;if(n._babylonTransformNode)throw new Error(t+": Invalid recursive node hierarchy");var a=new Array;this.logOpen(t+" "+(n.name||""));var s=function(i){if(e.AddPointerMetadata(i,t),e._LoadTransform(n,i),void 0!=n.camera){var s=Be.Get(t+"/camera",r._gltf.cameras,n.camera);a.push(r.loadCameraAsync("/cameras/"+s.index,s,(function(e){e.parent=i})))}if(n.children)for(var l=0,u=n.children;l<u.length;l++){var c=u[l],h=Be.Get(t+"/children/"+c,r._gltf.nodes,c);a.push(r.loadNodeAsync("/nodes/"+h.index,h,(function(e){e.parent=i})))}o(i)};if(void 0==n.mesh){var l=n.name||"node"+n.index;this._babylonScene._blockEntityCollection=this._forAssetContainer,n._babylonTransformNode=new Le.a(l,this._babylonScene),this._babylonScene._blockEntityCollection=!1,s(n._babylonTransformNode)}else{var u=Be.Get(t+"/mesh",this._gltf.meshes,n.mesh);a.push(this._loadMeshAsync("/meshes/"+u.index,n,u,s))}return this.logClose(),Promise.all(a).then((function(){return r._forEachPrimitive(n,(function(e){e.refreshBoundingInfo(!0)})),n._babylonTransformNode}))},e.prototype._loadMeshAsync=function(e,t,n,o){var r=n.primitives;if(!r||!r.length)throw new Error(e+": Primitives are missing");void 0==r[0].index&&Be.Assign(r);var i=new Array;this.logOpen(e+" "+(n.name||""));var a=t.name||"node"+t.index;if(1===r.length){var s=n.primitives[0];i.push(this._loadMeshPrimitiveAsync(e+"/primitives/"+s.index,a,t,n,s,(function(e){t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]})))}else{t._babylonTransformNode=new Le.a(a,this._babylonScene),t._primitiveBabylonMeshes=[];for(var l=0,u=r;l<u.length;l++){s=u[l];i.push(this._loadMeshPrimitiveAsync(e+"/primitives/"+s.index,a+"_primitive"+s.index,t,n,s,(function(e){e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)})))}}if(void 0!=t.skin){var c=Be.Get(e+"/skin",this._gltf.skins,t.skin);i.push(this._loadSkinAsync("/skins/"+c.index,t,c))}return o(t._babylonTransformNode),this.logClose(),Promise.all(i).then((function(){return t._babylonTransformNode}))},e.prototype._loadMeshPrimitiveAsync=function(t,n,o,r,i,a){var s=this,l=this._extensionsLoadMeshPrimitiveAsync(t,n,o,r,i,a);if(l)return l;this.logOpen(""+t);var u,c,h=this._parent.createInstances&&void 0==o.skin&&!r.primitives[0].targets;if(h&&i._instanceData)u=i._instanceData.babylonSourceMesh.createInstance(n),c=i._instanceData.promise;else{var p=new Array;this._babylonScene._blockEntityCollection=this._forAssetContainer;var d=new H.a(n,this._babylonScene);this._babylonScene._blockEntityCollection=!1,d.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?F.a.CounterClockWiseSideOrientation:F.a.ClockWiseSideOrientation,this._createMorphTargets(t,o,r,i,d),p.push(this._loadVertexDataAsync(t,i,d).then((function(e){return s._loadMorphTargetsAsync(t,i,d,e).then((function(){e.applyToMesh(d)}))})));var f=e._GetDrawMode(t,i.mode);if(void 0==i.material){var y=this._defaultBabylonMaterialData[f];y||(y=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(y),this._defaultBabylonMaterialData[f]=y),d.material=y}else{var v=Be.Get(t+"/material",this._gltf.materials,i.material);p.push(this._loadMaterialAsync("/materials/"+v.index,v,d,f,(function(e){d.material=e})))}c=Promise.all(p),h&&(i._instanceData={babylonSourceMesh:d,promise:c}),u=d}return e.AddPointerMetadata(u,t),this._parent.onMeshLoadedObservable.notifyObservers(u),a(u),this.logClose(),c.then((function(){return u}))},e.prototype._loadVertexDataAsync=function(e,t,n){var o=this,r=this._extensionsLoadVertexDataAsync(e,t,n);if(r)return r;var i=t.attributes;if(!i)throw new Error(e+": Attributes are missing");var a=new Array,s=new j.a(n.name,this._babylonScene);if(void 0==t.indices)n.isUnIndexed=!0;else{var l=Be.Get(e+"/indices",this._gltf.accessors,t.indices);a.push(this._loadIndicesAccessorAsync("/accessors/"+l.index,l).then((function(e){s.setIndices(e)})))}var u=function(t,r,l){if(void 0!=i[t]){n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(r)&&n._delayInfo.push(r);var u=Be.Get(e+"/attributes/"+t,o._gltf.accessors,i[t]);a.push(o._loadVertexAccessorAsync("/accessors/"+u.index,u,r).then((function(e){s.setVerticesBuffer(e,u.count)}))),r==k.b.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),l&&l(u)}};return u("POSITION",k.b.PositionKind),u("NORMAL",k.b.NormalKind),u("TANGENT",k.b.TangentKind),u("TEXCOORD_0",k.b.UVKind),u("TEXCOORD_1",k.b.UV2Kind),u("JOINTS_0",k.b.MatricesIndicesKind),u("WEIGHTS_0",k.b.MatricesWeightsKind),u("JOINTS_1",k.b.MatricesIndicesExtraKind),u("WEIGHTS_1",k.b.MatricesWeightsExtraKind),u("COLOR_0",k.b.ColorKind,(function(e){"VEC4"===e.type&&(n.hasVertexAlpha=!0)})),Promise.all(a).then((function(){return s}))},e.prototype._createMorphTargets=function(e,t,n,o,r){if(o.targets){if(void 0==t._numMorphTargets)t._numMorphTargets=o.targets.length;else if(o.targets.length!==t._numMorphTargets)throw new Error(e+": Primitives do not have the same number of targets");var i=n.extras?n.extras.targetNames:null;r.morphTargetManager=new Oe.a(r.getScene());for(var a=0;a<o.targets.length;a++){var s=t.weights?t.weights[a]:n.weights?n.weights[a]:0,l=i?i[a]:"morphTarget"+a;r.morphTargetManager.addTarget(new Re.a(l,s,r.getScene()))}}},e.prototype._loadMorphTargetsAsync=function(e,t,n,o){if(!t.targets)return Promise.resolve();for(var r=new Array,i=n.morphTargetManager,a=0;a<i.numTargets;a++){var s=i.getTarget(a);r.push(this._loadMorphTargetVertexDataAsync(e+"/targets/"+a,o,t.targets[a],s))}return Promise.all(r).then((function(){}))},e.prototype._loadMorphTargetVertexDataAsync=function(e,t,n,o){var r=this,i=new Array,a=function(o,a,s){if(void 0!=n[o]){var l=t.getVertexBuffer(a);if(l){var u=Be.Get(e+"/"+o,r._gltf.accessors,n[o]);i.push(r._loadFloatAccessorAsync("/accessors/"+u.index,u).then((function(e){s(l,e)})))}}};return a("POSITION",k.b.PositionKind,(function(e,t){var n=new Float32Array(t.length);e.forEach(t.length,(function(e,o){n[o]=t[o]+e})),o.setPositions(n)})),a("NORMAL",k.b.NormalKind,(function(e,t){var n=new Float32Array(t.length);e.forEach(n.length,(function(e,o){n[o]=t[o]+e})),o.setNormals(n)})),a("TANGENT",k.b.TangentKind,(function(e,t){var n=new Float32Array(t.length/3*4),r=0;e.forEach(t.length/3*4,(function(e,o){(o+1)%4!==0&&(n[r]=t[r]+e,r++)})),o.setTangents(n)})),Promise.all(i).then((function(){}))},e._LoadTransform=function(e,t){if(void 0==e.skin){var n=C.e.Zero(),o=C.b.Identity(),r=C.e.One();if(e.matrix)C.a.FromArray(e.matrix).decompose(r,o,n);else e.translation&&(n=C.e.FromArray(e.translation)),e.rotation&&(o=C.b.FromArray(e.rotation)),e.scale&&(r=C.e.FromArray(e.scale));t.position=n,t.rotationQuaternion=o,t.scaling=r}},e.prototype._loadSkinAsync=function(e,t,n){var o=this,r=this._extensionsLoadSkinAsync(e,t,n);if(r)return r;var i=function(e){o._forEachPrimitive(t,(function(t){t.skeleton=e}))};if(n._data)return i(n._data.babylonSkeleton),n._data.promise;var a="skeleton"+n.index;this._babylonScene._blockEntityCollection=this._forAssetContainer;var s=new B.a(n.name||a,a,this._babylonScene);this._babylonScene._blockEntityCollection=!1,s.overrideMesh=this._rootBabylonMesh,this._loadBones(e,n,s),i(s);var l=this._loadSkinInverseBindMatricesDataAsync(e,n).then((function(e){o._updateBoneMatrices(s,e)}));return n._data={babylonSkeleton:s,promise:l},l},e.prototype._loadBones=function(e,t,n){for(var o={},r=0,i=t.joints;r<i.length;r++){var a=i[r],s=Be.Get(e+"/joints/"+a,this._gltf.nodes,a);this._loadBone(s,t,n,o)}},e.prototype._loadBone=function(e,t,n,o){var r=o[e.index];if(r)return r;var i=null;e.parent&&e.parent._babylonTransformNode!==this._rootBabylonMesh&&(i=this._loadBone(e.parent,t,n,o));var a=t.joints.indexOf(e.index);return r=new N.a(e.name||"joint"+e.index,n,i,this._getNodeMatrix(e),null,null,a),o[e.index]=r,e._babylonBones=e._babylonBones||[],e._babylonBones.push(r),r},e.prototype._loadSkinInverseBindMatricesDataAsync=function(e,t){if(void 0==t.inverseBindMatrices)return Promise.resolve(null);var n=Be.Get(e+"/inverseBindMatrices",this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/"+n.index,n)},e.prototype._updateBoneMatrices=function(e,t){for(var n=0,o=e.bones;n<o.length;n++){var r=o[n],i=C.a.Identity(),a=r._index;t&&-1!==a&&(C.a.FromArrayToRef(t,16*a,i),i.invertToRef(i));var s=r.getParent();s&&i.multiplyToRef(s.getInvertedAbsoluteTransform(),i),r.updateMatrix(i,!1,!1),r._updateDifferenceMatrix(void 0,!1)}},e.prototype._getNodeMatrix=function(e){return e.matrix?C.a.FromArray(e.matrix):C.a.Compose(e.scale?C.e.FromArray(e.scale):C.e.One(),e.rotation?C.b.FromArray(e.rotation):C.b.Identity(),e.translation?C.e.FromArray(e.translation):C.e.Zero())},e.prototype.loadCameraAsync=function(t,n,o){void 0===o&&(o=function(){});var r=this._extensionsLoadCameraAsync(t,n,o);if(r)return r;var i=new Array;this.logOpen(t+" "+(n.name||"")),this._babylonScene._blockEntityCollection=this._forAssetContainer;var a=new O.a(n.name||"camera"+n.index,C.e.Zero(),this._babylonScene,!1);switch(this._babylonScene._blockEntityCollection=!1,a.rotation=new C.e(0,Math.PI,0),n.type){case"perspective":var s=n.perspective;if(!s)throw new Error(t+": Camera perspective properties are missing");a.fov=s.yfov,a.minZ=s.znear,a.maxZ=s.zfar||Number.MAX_VALUE;break;case"orthographic":if(!n.orthographic)throw new Error(t+": Camera orthographic properties are missing");a.mode=R.a.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-n.orthographic.xmag,a.orthoRight=n.orthographic.xmag,a.orthoBottom=-n.orthographic.ymag,a.orthoTop=n.orthographic.ymag,a.minZ=n.orthographic.znear,a.maxZ=n.orthographic.zfar;break;default:throw new Error(t+": Invalid camera type ("+n.type+")")}return e.AddPointerMetadata(a,t),this._parent.onCameraLoadedObservable.notifyObservers(a),o(a),Promise.all(i).then((function(){return a}))},e.prototype._loadAnimationsAsync=function(){var e=this._gltf.animations;if(!e)return Promise.resolve();for(var t=new Array,n=0;n<e.length;n++){var o=e[n];t.push(this.loadAnimationAsync("/animations/"+o.index,o))}return Promise.all(t).then((function(){}))},e.prototype.loadAnimationAsync=function(e,t){var n=this._extensionsLoadAnimationAsync(e,t);if(n)return n;this._babylonScene._blockEntityCollection=this._forAssetContainer;var o=new Me.a(t.name||"animation"+t.index,this._babylonScene);this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=o;var r=new Array;Be.Assign(t.channels),Be.Assign(t.samplers);for(var i=0,a=t.channels;i<a.length;i++){var s=a[i];r.push(this._loadAnimationChannelAsync(e+"/channels/"+s.index,e,t,s,o))}return Promise.all(r).then((function(){return o.normalize(0),o}))},e.prototype._loadAnimationChannelAsync=function(e,t,n,o,r,i){var a=this;if(void 0===i&&(i=null),void 0==o.target.node)return Promise.resolve();var s=Be.Get(e+"/target/node",this._gltf.nodes,o.target.node);if("weights"===o.target.path&&!s._numMorphTargets||"weights"!==o.target.path&&!s._babylonTransformNode)return Promise.resolve();var l=Be.Get(e+"/sampler",n.samplers,o.sampler);return this._loadAnimationSamplerAsync(t+"/samplers/"+o.sampler,l).then((function(t){var n,l;switch(o.target.path){case"translation":n="position",l=P.a.ANIMATIONTYPE_VECTOR3;break;case"rotation":n="rotationQuaternion",l=P.a.ANIMATIONTYPE_QUATERNION;break;case"scale":n="scaling",l=P.a.ANIMATIONTYPE_VECTOR3;break;case"weights":n="influence",l=P.a.ANIMATIONTYPE_FLOAT;break;default:throw new Error(e+"/target/path: Invalid value ("+o.target.path+")")}var u,c,h=0;switch(n){case"position":u=function(){var e=C.e.FromArray(t.output,h);return h+=3,e};break;case"rotationQuaternion":u=function(){var e=C.b.FromArray(t.output,h);return h+=4,e};break;case"scaling":u=function(){var e=C.e.FromArray(t.output,h);return h+=3,e};break;case"influence":u=function(){for(var e=new Array(s._numMorphTargets),n=0;n<s._numMorphTargets;n++)e[n]=t.output[h++];return e}}switch(t.interpolation){case"STEP":c=function(e){return{frame:t.input[e],value:u(),interpolation:Pe.a.STEP}};break;case"LINEAR":c=function(e){return{frame:t.input[e],value:u()}};break;case"CUBICSPLINE":c=function(e){return{frame:t.input[e],inTangent:u(),value:u(),outTangent:u()}}}for(var p=new Array(t.input.length),d=0;d<t.input.length;d++)p[d]=c(d);if("influence"===n)for(var f=function(e){var t=r.name+"_channel"+r.targetedAnimations.length,o=new P.a(t,n,1,l);o.setKeys(p.map((function(t){return{frame:t.frame,inTangent:t.inTangent?t.inTangent[e]:void 0,value:t.value[e],outTangent:t.outTangent?t.outTangent[e]:void 0}}))),a._forEachPrimitive(s,(function(t){var n=t.morphTargetManager.getTarget(e),i=o.clone();n.animations.push(i),r.addTargetedAnimation(i,n)}))},y=0;y<s._numMorphTargets;y++)f(y);else{var v=r.name+"_channel"+r.targetedAnimations.length,m=new P.a(v,n,1,l);m.setKeys(p),null!=i&&null!=i.animations?(i.animations.push(m),r.addTargetedAnimation(m,i)):(s._babylonTransformNode.animations.push(m),r.addTargetedAnimation(m,s._babylonTransformNode))}}))},e.prototype._loadAnimationSamplerAsync=function(e,t){if(t._data)return t._data;var n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(e+"/interpolation: Invalid value ("+t.interpolation+")")}var o=Be.Get(e+"/input",this._gltf.accessors,t.input),r=Be.Get(e+"/output",this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync("/accessors/"+o.index,o),this._loadFloatAccessorAsync("/accessors/"+r.index,r)]).then((function(e){var t=e[0],o=e[1];return{input:t,interpolation:n,output:o}})),t._data},e.prototype._loadBufferAsync=function(e,t,n,o){var r=this._extensionsLoadBufferAsync(e,t,n,o);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(e+"/uri",t,t.uri);else{if(!this._bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then((function(t){try{return new Uint8Array(t.buffer,t.byteOffset+n,o)}catch(r){throw new Error(e+": "+r.message)}}))},e.prototype.loadBufferViewAsync=function(e,t){var n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;var o=Be.Get(e+"/buffer",this._gltf.buffers,t.buffer);return t._data=this._loadBufferAsync("/buffers/"+o.index,o,t.byteOffset||0,t.byteLength),t._data},e.prototype._loadAccessorAsync=function(t,n,o){var r=this;if(n._data)return n._data;var i=e._GetNumComponents(t,n.type),a=i*k.b.GetTypeByteLength(n.componentType),s=i*n.count;if(void 0==n.bufferView)n._data=Promise.resolve(new o(s));else{var l=Be.Get(t+"/bufferView",this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/"+l.index,l).then((function(r){if(5126!==n.componentType||n.normalized){var u=new o(s);return k.b.ForEach(r,n.byteOffset||0,l.byteStride||a,i,n.componentType,u.length,n.normalized||!1,(function(e,t){u[t]=e})),u}return e._GetTypedArray(t,n.componentType,r,n.byteOffset,s)}))}if(n.sparse){var u=n.sparse;n._data=n._data.then((function(s){var l=s,c=Be.Get(t+"/sparse/indices/bufferView",r._gltf.bufferViews,u.indices.bufferView),h=Be.Get(t+"/sparse/values/bufferView",r._gltf.bufferViews,u.values.bufferView);return Promise.all([r.loadBufferViewAsync("/bufferViews/"+c.index,c),r.loadBufferViewAsync("/bufferViews/"+h.index,h)]).then((function(r){var s,c=r[0],h=r[1],p=e._GetTypedArray(t+"/sparse/indices",u.indices.componentType,c,u.indices.byteOffset,u.count),d=i*u.count;if(5126!==n.componentType||n.normalized){var f=e._GetTypedArray(t+"/sparse/values",n.componentType,h,u.values.byteOffset,d);s=new o(d),k.b.ForEach(f,0,a,i,n.componentType,s.length,n.normalized||!1,(function(e,t){s[t]=e}))}else s=e._GetTypedArray(t+"/sparse/values",n.componentType,h,u.values.byteOffset,d);for(var y=0,v=0;v<p.length;v++)for(var m=p[v]*i,b=0;b<i;b++)l[m++]=s[y++];return l}))}))}return n._data},e.prototype._loadFloatAccessorAsync=function(e,t){return this._loadAccessorAsync(e,t,Float32Array)},e.prototype._loadIndicesAccessorAsync=function(t,n){if("SCALAR"!==n.type)throw new Error(t+"/type: Invalid value "+n.type);if(5121!==n.componentType&&5123!==n.componentType&&5125!==n.componentType)throw new Error(t+"/componentType: Invalid value "+n.componentType);if(n._data)return n._data;if(n.sparse){var o=e._GetTypedArrayConstructor(t+"/componentType",n.componentType);n._data=this._loadAccessorAsync(t,n,o)}else{var r=Be.Get(t+"/bufferView",this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/"+r.index,r).then((function(o){return e._GetTypedArray(t,n.componentType,o,n.byteOffset,n.count)}))}return n._data},e.prototype._loadVertexBufferViewAsync=function(e,t){var n=this;return e._babylonBuffer||(e._babylonBuffer=this.loadBufferViewAsync("/bufferViews/"+e.index,e).then((function(e){return new k.a(n._babylonScene.getEngine(),e,!1)}))),e._babylonBuffer},e.prototype._loadVertexAccessorAsync=function(t,n,o){var r=this;if(n._babylonVertexBuffer)return n._babylonVertexBuffer;if(n.sparse)n._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+n.index,n).then((function(e){return new k.b(r._babylonScene.getEngine(),e,o,!1)}));else if(n.byteOffset&&n.byteOffset%k.b.GetTypeByteLength(n.componentType)!==0)u.a.Warn("Accessor byte offset is not a multiple of component type byte length"),n._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+n.index,n).then((function(e){return new k.b(r._babylonScene.getEngine(),e,o,!1)}));else if(o===k.b.MatricesIndicesKind||o===k.b.MatricesIndicesExtraKind)n._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+n.index,n).then((function(e){return new k.b(r._babylonScene.getEngine(),e,o,!1)}));else{var i=Be.Get(t+"/bufferView",this._gltf.bufferViews,n.bufferView);n._babylonVertexBuffer=this._loadVertexBufferViewAsync(i,o).then((function(a){var s=e._GetNumComponents(t,n.type);return new k.b(r._babylonScene.getEngine(),a,o,!1,!1,i.byteStride,!1,n.byteOffset,s,n.componentType,n.normalized,!0)}))}return n._babylonVertexBuffer},e.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(e,t,n){if(!(n instanceof Ce.a))throw new Error(e+": Material type not supported");var o=new Array;return t&&(t.baseColorFactor?(n.albedoColor=L.a.FromArray(t.baseColorFactor),n.alpha=t.baseColorFactor[3]):n.albedoColor=L.a.White(),n.metallic=void 0==t.metallicFactor?1:t.metallicFactor,n.roughness=void 0==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&o.push(this.loadTextureInfoAsync(e+"/baseColorTexture",t.baseColorTexture,(function(e){e.name=n.name+" (Base Color)",n.albedoTexture=e}))),t.metallicRoughnessTexture&&(o.push(this.loadTextureInfoAsync(e+"/metallicRoughnessTexture",t.metallicRoughnessTexture,(function(e){e.name=n.name+" (Metallic Roughness)",n.metallicTexture=e}))),n.useMetallnessFromMetallicTextureBlue=!0,n.useRoughnessFromMetallicTextureGreen=!0,n.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(o).then((function(){}))},e.prototype._loadMaterialAsync=function(t,n,o,r,i){void 0===i&&(i=function(){});var a=this._extensionsLoadMaterialAsync(t,n,o,r,i);if(a)return a;n._data=n._data||{};var s=n._data[r];if(!s){this.logOpen(t+" "+(n.name||""));var l=this.createMaterial(t,n,r);s={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(t,n,l)},n._data[r]=s,e.AddPointerMetadata(l,t),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return s.babylonMeshes.push(o),o.onDisposeObservable.addOnce((function(){var e=s.babylonMeshes.indexOf(o);-1!==e&&s.babylonMeshes.splice(e,1)})),i(s.babylonMaterial),s.promise.then((function(){return s.babylonMaterial}))},e.prototype._createDefaultMaterial=function(e,t){this._babylonScene._blockEntityCollection=this._forAssetContainer;var n=new Ce.a(e,this._babylonScene);return this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.enableSpecularAntiAliasing=!0,n.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,n.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,n.transparencyMode=Ce.a.PBRMATERIAL_OPAQUE,n.metallic=1,n.roughness=1,n},e.prototype.createMaterial=function(e,t,n){var o=this._extensionsCreateMaterial(e,t,n);if(o)return o;var r=t.name||"material"+t.index;return this._createDefaultMaterial(r,n)},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(o)return o;var r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(e+"/pbrMetallicRoughness",t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(r).then((function(){}))},e.prototype.loadMaterialBasePropertiesAsync=function(e,t,n){if(!(n instanceof Ce.a))throw new Error(e+": Material type not supported");var o=new Array;return n.emissiveColor=t.emissiveFactor?L.a.FromArray(t.emissiveFactor):new L.a(0,0,0),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),t.normalTexture&&(o.push(this.loadTextureInfoAsync(e+"/normalTexture",t.normalTexture,(function(e){e.name=n.name+" (Normal)",n.bumpTexture=e}))),n.invertNormalMapX=!this._babylonScene.useRightHandedSystem,n.invertNormalMapY=this._babylonScene.useRightHandedSystem,void 0!=t.normalTexture.scale&&(n.bumpTexture.level=t.normalTexture.scale),n.forceIrradianceInFragment=!0),t.occlusionTexture&&(o.push(this.loadTextureInfoAsync(e+"/occlusionTexture",t.occlusionTexture,(function(e){e.name=n.name+" (Occlusion)",n.ambientTexture=e}))),n.useAmbientInGrayScale=!0,void 0!=t.occlusionTexture.strength&&(n.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&o.push(this.loadTextureInfoAsync(e+"/emissiveTexture",t.emissiveTexture,(function(e){e.name=n.name+" (Emissive)",n.emissiveTexture=e}))),Promise.all(o).then((function(){}))},e.prototype.loadMaterialAlphaProperties=function(e,t,n){if(!(n instanceof Ce.a))throw new Error(e+": Material type not supported");switch(t.alphaMode||"OPAQUE"){case"OPAQUE":n.transparencyMode=Ce.a.PBRMATERIAL_OPAQUE;break;case"MASK":n.transparencyMode=Ce.a.PBRMATERIAL_ALPHATEST,n.alphaCutOff=void 0==t.alphaCutoff?.5:t.alphaCutoff,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0);break;case"BLEND":n.transparencyMode=Ce.a.PBRMATERIAL_ALPHABLEND,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0,n.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(e+"/alphaMode: Invalid value ("+t.alphaMode+")")}},e.prototype.loadTextureInfoAsync=function(t,n,o){var r=this;void 0===o&&(o=function(){});var i=this._extensionsLoadTextureInfoAsync(t,n,o);if(i)return i;if(this.logOpen(""+t),n.texCoord>=2)throw new Error(t+"/texCoord: Invalid value ("+n.texCoord+")");var a=Be.Get(t+"/index",this._gltf.textures,n.index),s=this._loadTextureAsync("/textures/"+n.index,a,(function(i){i.coordinatesIndex=n.texCoord||0,e.AddPointerMetadata(i,t),r._parent.onTextureLoadedObservable.notifyObservers(i),o(i)}));return this.logClose(),s},e.prototype._loadTextureAsync=function(t,n,o){void 0===o&&(o=function(){});var r=this._extensionsLoadTextureAsync(t,n,o);if(r)return r;this.logOpen(t+" "+(n.name||""));var i=void 0==n.sampler?e.DefaultSampler:Be.Get(t+"/sampler",this._gltf.samplers,n.sampler),a=Be.Get(t+"/source",this._gltf.images,n.source),s=this._createTextureAsync(t,i,a,o);return this.logClose(),s},e.prototype._createTextureAsync=function(e,t,n,o){var r=this;void 0===o&&(o=function(){});var i=this._loadSampler("/samplers/"+t.index,t),a=new Array,s=new Se.a;this._babylonScene._blockEntityCollection=this._forAssetContainer;var l=new z.a(null,this._babylonScene,i.noMipMaps,!1,i.samplingMode,(function(){r._disposed||s.resolve()}),(function(t,n){r._disposed||s.reject(new Error(e+": "+(n&&n.message?n.message:t||"Failed to load texture")))}),void 0,void 0,void 0,n.mimeType);return this._babylonScene._blockEntityCollection=!1,a.push(s.promise),a.push(this.loadImageAsync("/images/"+n.index,n).then((function(e){var t=n.uri||r._fileName+"#image"+n.index,o="data:"+r._uniqueRootUrl+t;l.updateURL(o,e)}))),l.wrapU=i.wrapU,l.wrapV=i.wrapV,o(l),Promise.all(a).then((function(){return l}))},e.prototype._loadSampler=function(t,n){return n._data||(n._data={noMipMaps:9728===n.minFilter||9729===n.minFilter,samplingMode:e._GetTextureSamplingMode(t,n),wrapU:e._GetTextureWrapMode(t+"/wrapS",n.wrapS),wrapV:e._GetTextureWrapMode(t+"/wrapT",n.wrapT)}),n._data},e.prototype.loadImageAsync=function(e,t){if(!t._data){if(this.logOpen(e+" "+(t.name||"")),t.uri)t._data=this.loadUriAsync(e+"/uri",t,t.uri);else{var n=Be.Get(e+"/bufferView",this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync("/bufferViews/"+n.index,n)}this.logClose()}return t._data},e.prototype.loadUriAsync=function(t,n,o){var r=this,i=this._extensionsLoadUriAsync(t,n,o);if(i)return i;if(!e._ValidateUri(o))throw new Error(t+": '"+o+"' is invalid");if(a.b.IsBase64(o)){var s=new Uint8Array(a.b.DecodeBase64(o));return this.log("Decoded "+o.substr(0,64)+"... ("+s.length+" bytes)"),Promise.resolve(s)}return this.log("Loading "+o),this._parent.preprocessUrlAsync(this._rootUrl+o).then((function(e){return new Promise((function(n,i){if(!r._disposed){var s=a.b.LoadFile(e,(function(e){if(!r._disposed){var t=new Uint8Array(e);r.log("Loaded "+o+" ("+t.length+" bytes)"),n(t)}}),(function(e){if(!r._disposed&&(s&&(s._lengthComputable=e.lengthComputable,s._loaded=e.loaded,s._total=e.total),r._state===y.LOADING))try{r._onProgress()}catch(t){i(t)}}),r._babylonScene.offlineProvider,!0,(function(e,n){r._disposed||i(new Ne.b(t+": Failed to load '"+o+"'"+(e?": "+e.status+" "+e.statusText:""),e))}));r._requests.push(s)}}))}))},e.prototype._onProgress=function(){if(this._progressCallback){for(var e=!0,t=0,n=0,o=0,r=this._requests;o<r.length;o++){var i=r[o];if(void 0===i._lengthComputable||void 0===i._loaded||void 0===i._total)return;e=e&&i._lengthComputable,t+=i._loaded,n+=i._total}this._progressCallback(new s.c(e,t,e?n:0))}},e.AddPointerMetadata=function(e,t){var n=e.metadata=e.metadata||{},o=n.gltf=n.gltf||{};(o.pointers=o.pointers||[]).push(t)},e._GetTextureWrapMode=function(e,t){switch(t=void 0==t?10497:t){case 33071:return z.a.CLAMP_ADDRESSMODE;case 33648:return z.a.MIRROR_ADDRESSMODE;case 10497:return z.a.WRAP_ADDRESSMODE;default:return u.a.Warn(e+": Invalid value ("+t+")"),z.a.WRAP_ADDRESSMODE}},e._GetTextureSamplingMode=function(e,t){var n=void 0==t.magFilter?9729:t.magFilter,o=void 0==t.minFilter?9987:t.minFilter;if(9729===n)switch(o){case 9728:return z.a.LINEAR_NEAREST;case 9729:return z.a.LINEAR_LINEAR;case 9984:return z.a.LINEAR_NEAREST_MIPNEAREST;case 9985:return z.a.LINEAR_LINEAR_MIPNEAREST;case 9986:return z.a.LINEAR_NEAREST_MIPLINEAR;case 9987:return z.a.LINEAR_LINEAR_MIPLINEAR;default:return u.a.Warn(e+"/minFilter: Invalid value ("+o+")"),z.a.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==n&&u.a.Warn(e+"/magFilter: Invalid value ("+n+")"),o){case 9728:return z.a.NEAREST_NEAREST;case 9729:return z.a.NEAREST_LINEAR;case 9984:return z.a.NEAREST_NEAREST_MIPNEAREST;case 9985:return z.a.NEAREST_LINEAR_MIPNEAREST;case 9986:return z.a.NEAREST_NEAREST_MIPLINEAR;case 9987:return z.a.NEAREST_LINEAR_MIPLINEAR;default:return u.a.Warn(e+"/minFilter: Invalid value ("+o+")"),z.a.NEAREST_NEAREST_MIPNEAREST}},e._GetTypedArrayConstructor=function(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(e+": Invalid component type "+t)}},e._GetTypedArray=function(t,n,o,r,i){var a=o.buffer;r=o.byteOffset+(r||0);var s=e._GetTypedArrayConstructor(t+"/componentType",n);try{return new s(a,r,i)}catch(l){throw new Error(t+": "+l)}},e._GetNumComponents=function(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(e+": Invalid type ("+t+")")},e._ValidateUri=function(e){return a.b.IsBase64(e)||-1===e.indexOf("..")},e._GetDrawMode=function(e,t){switch(void 0==t&&(t=4),t){case 0:return F.a.PointListDrawMode;case 1:return F.a.LineListDrawMode;case 2:return F.a.LineLoopDrawMode;case 3:return F.a.LineStripDrawMode;case 4:return F.a.TriangleFillMode;case 5:return F.a.TriangleStripDrawMode;case 6:return F.a.TriangleFanDrawMode}throw new Error(e+": Invalid mesh primitive mode ("+t+")")},e.prototype._compileMaterialsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile materials");var t=new Array;if(this._gltf.materials)for(var n=0,o=this._gltf.materials;n<o.length;n++){var r=o[n];if(r._data)for(var i in r._data)for(var a=r._data[i],s=0,l=a.babylonMeshes;s<l.length;s++){var u=l[s];u.computeWorldMatrix(!0);var c=a.babylonMaterial;t.push(c.forceCompilationAsync(u)),t.push(c.forceCompilationAsync(u,{useInstances:!0})),this._parent.useClipPlane&&(t.push(c.forceCompilationAsync(u,{clipPlane:!0})),t.push(c.forceCompilationAsync(u,{clipPlane:!0,useInstances:!0})))}}return Promise.all(t).then((function(){e._parent._endPerformanceCounter("Compile materials")}))},e.prototype._compileShadowGeneratorsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile shadow generators");for(var t=new Array,n=0,o=this._babylonScene.lights;n<o.length;n++){var r=o[n].getShadowGenerator();r&&t.push(r.forceCompilationAsync())}return Promise.all(t).then((function(){e._parent._endPerformanceCounter("Compile shadow generators")}))},e.prototype._forEachExtensions=function(e){for(var t=0,n=this._extensions;t<n.length;t++){var o=n[t];o.enabled&&e(o)}},e.prototype._applyExtensions=function(e,t,n){for(var o=0,r=this._extensions;o<r.length;o++){var i=r[o];if(i.enabled){var a=i.name+"."+t,s=e;s._activeLoaderExtensionFunctions=s._activeLoaderExtensionFunctions||{};var l=s._activeLoaderExtensionFunctions;if(!l[a]){l[a]=!0;try{var u=n(i);if(u)return u}finally{delete l[a]}}}}return null},e.prototype._extensionsOnLoading=function(){this._forEachExtensions((function(e){return e.onLoading&&e.onLoading()}))},e.prototype._extensionsOnReady=function(){this._forEachExtensions((function(e){return e.onReady&&e.onReady()}))},e.prototype._extensionsLoadSceneAsync=function(e,t){return this._applyExtensions(t,"loadScene",(function(n){return n.loadSceneAsync&&n.loadSceneAsync(e,t)}))},e.prototype._extensionsLoadNodeAsync=function(e,t,n){return this._applyExtensions(t,"loadNode",(function(o){return o.loadNodeAsync&&o.loadNodeAsync(e,t,n)}))},e.prototype._extensionsLoadCameraAsync=function(e,t,n){return this._applyExtensions(t,"loadCamera",(function(o){return o.loadCameraAsync&&o.loadCameraAsync(e,t,n)}))},e.prototype._extensionsLoadVertexDataAsync=function(e,t,n){return this._applyExtensions(t,"loadVertexData",(function(o){return o._loadVertexDataAsync&&o._loadVertexDataAsync(e,t,n)}))},e.prototype._extensionsLoadMeshPrimitiveAsync=function(e,t,n,o,r,i){return this._applyExtensions(r,"loadMeshPrimitive",(function(a){return a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,n,o,r,i)}))},e.prototype._extensionsLoadMaterialAsync=function(e,t,n,o,r){return this._applyExtensions(t,"loadMaterial",(function(i){return i._loadMaterialAsync&&i._loadMaterialAsync(e,t,n,o,r)}))},e.prototype._extensionsCreateMaterial=function(e,t,n){return this._applyExtensions(t,"createMaterial",(function(o){return o.createMaterial&&o.createMaterial(e,t,n)}))},e.prototype._extensionsLoadMaterialPropertiesAsync=function(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",(function(o){return o.loadMaterialPropertiesAsync&&o.loadMaterialPropertiesAsync(e,t,n)}))},e.prototype._extensionsLoadTextureInfoAsync=function(e,t,n){return this._applyExtensions(t,"loadTextureInfo",(function(o){return o.loadTextureInfoAsync&&o.loadTextureInfoAsync(e,t,n)}))},e.prototype._extensionsLoadTextureAsync=function(e,t,n){return this._applyExtensions(t,"loadTexture",(function(o){return o._loadTextureAsync&&o._loadTextureAsync(e,t,n)}))},e.prototype._extensionsLoadAnimationAsync=function(e,t){return this._applyExtensions(t,"loadAnimation",(function(n){return n.loadAnimationAsync&&n.loadAnimationAsync(e,t)}))},e.prototype._extensionsLoadSkinAsync=function(e,t,n){return this._applyExtensions(n,"loadSkin",(function(o){return o._loadSkinAsync&&o._loadSkinAsync(e,t,n)}))},e.prototype._extensionsLoadUriAsync=function(e,t,n){return this._applyExtensions(t,"loadUri",(function(o){return o._loadUriAsync&&o._loadUriAsync(e,t,n)}))},e.prototype._extensionsLoadBufferViewAsync=function(e,t){return this._applyExtensions(t,"loadBufferView",(function(n){return n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t)}))},e.prototype._extensionsLoadBufferAsync=function(e,t,n,o){return this._applyExtensions(t,"loadBuffer",(function(r){return r.loadBufferAsync&&r.loadBufferAsync(e,t,n,o)}))},e.LoadExtensionAsync=function(e,t,n,o){if(!t.extensions)return null;var r=t.extensions[n];return r?o(e+"/extensions/"+n,r):null},e.LoadExtraAsync=function(e,t,n,o){if(!t.extras)return null;var r=t.extras[n];return r?o(e+"/extras/"+n,r):null},e.prototype.isExtensionUsed=function(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)},e.prototype.logOpen=function(e){this._parent._logOpen(e)},e.prototype.logClose=function(){this._parent._logClose()},e.prototype.log=function(e){this._parent._log(e)},e.prototype.startPerformanceCounter=function(e){this._parent._startPerformanceCounter(e)},e.prototype.endPerformanceCounter=function(e){this._parent._endPerformanceCounter(e)},e._RegisteredExtensions={},e.DefaultSampler={index:-1},e}();m._CreateGLTF2Loader=function(e){return new Ie(e)};var Fe=n(15),Ve=n(86),De=n(210),qe="EXT_lights_image_based",ze=function(){function e(e){this.name=qe,this._loader=e,this.enabled=this._loader.isExtensionUsed(qe)}return e.prototype.dispose=function(){delete this._loader,delete this._lights},e.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var t=e[this.name];this._lights=t.lights}},e.prototype.loadSceneAsync=function(e,t){var n=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(o,r){var i=new Array;i.push(n._loader.loadSceneAsync(e,t)),n._loader.logOpen(""+o);var a=Be.Get(o+"/light",n._lights,r.light);return i.push(n._loadLightAsync("#/extensions/"+n.name+"/lights/"+r.light,a).then((function(e){n._loader.babylonScene.environmentTexture=e}))),n._loader.logClose(),Promise.all(i).then((function(){}))}))},e.prototype._loadLightAsync=function(e,t){var n=this;if(!t._loaded){var o=new Array;this._loader.logOpen(""+e);for(var r=new Array(t.specularImages.length),i=function(n){var i=t.specularImages[n];r[n]=new Array(i.length);for(var s=function(t){var s=e+"/specularImages/"+n+"/"+t;a._loader.logOpen(""+s);var l=i[t],u=Be.Get(s,a._loader.gltf.images,l);o.push(a._loader.loadImageAsync("#/images/"+l,u).then((function(e){r[n][t]=e}))),a._loader.logClose()},l=0;l<i.length;l++)s(l)},a=this,s=0;s<t.specularImages.length;s++)i(s);this._loader.logClose(),t._loaded=Promise.all(o).then((function(){var e=new De.a(n._loader.babylonScene,null,t.specularImageSize);if(t._babylonTexture=e,void 0!=t.intensity&&(e.level=t.intensity),t.rotation){var o=C.b.FromArray(t.rotation);n._loader.babylonScene.useRightHandedSystem||(o=C.b.Inverse(o)),C.a.FromQuaternionToRef(o,e.getReflectionTextureMatrix())}var i=Ve.a.FromArray(t.irradianceCoefficients);i.scaleInPlace(t.intensity),i.convertIrradianceToLambertianRadiance();var a=Ve.b.FromHarmonics(i),s=(r.length-1)/Fe.a.Log2(t.specularImageSize);return e.updateRGBDAsync(r,a,s)}))}return t._loaded.then((function(){return t._babylonTexture}))},e}();Ie.RegisterExtension(qe,(function(e){return new ze(e)}));var We=n(211),ke=function(){function e(e){this.name="KHR_draco_mesh_compression",this._loader=e,this.enabled=We.a.DecoderAvailable&&this._loader.isExtensionUsed("KHR_draco_mesh_compression")}return e.prototype.dispose=function(){delete this.dracoCompression,delete this._loader},e.prototype._loadVertexDataAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){if(void 0!=t.mode){if(5!==t.mode&&4!==t.mode)throw new Error(e+": Unsupported mode "+t.mode);if(5===t.mode)throw new Error(e+": Mode "+t.mode+" is not currently supported")}var a={},s=function(e,t){var o=i.attributes[e];void 0!=o&&(n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(t)&&n._delayInfo.push(t),a[t]=o)};s("POSITION",k.b.PositionKind),s("NORMAL",k.b.NormalKind),s("TANGENT",k.b.TangentKind),s("TEXCOORD_0",k.b.UVKind),s("TEXCOORD_1",k.b.UV2Kind),s("JOINTS_0",k.b.MatricesIndicesKind),s("WEIGHTS_0",k.b.MatricesWeightsKind),s("COLOR_0",k.b.ColorKind);var l=Be.Get(r,o._loader.gltf.bufferViews,i.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=o._loader.loadBufferViewAsync("#/bufferViews/"+l.index,l).then((function(t){return(o.dracoCompression||We.a.Default).decodeMeshAsync(t,a).then((function(e){var t=new j.a(n.name,o._loader.babylonScene);return e.applyToGeometry(t),t})).catch((function(t){throw new Error(e+": "+t.message)}))}))),l._dracoBabylonGeometry}))},e}();Ie.RegisterExtension("KHR_draco_mesh_compression",(function(e){return new ke(e)}));var je,Ue=n(53);!function(e){e.DIRECTIONAL="directional",e.POINT="point",e.SPOT="spot"}(je||(je={}));var Ge=function(){function e(e){this.name="KHR_lights_punctual",this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_lights_punctual")}return e.prototype.dispose=function(){delete this._loader,delete this._lights},e.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var t=e[this.name];this._lights=t.lights}},e.prototype.loadNodeAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){return o._loader.loadNodeAsync(e,t,(function(e){var t,a=Be.Get(r,o._lights,i.light),s=a.name||e.name;switch(o._loader.babylonScene._blockEntityCollection=o._loader._forAssetContainer,a.type){case je.DIRECTIONAL:t=new X.a(s,C.e.Backward(),o._loader.babylonScene);break;case je.POINT:t=new Y.a(s,C.e.Zero(),o._loader.babylonScene);break;case je.SPOT:var l=new Q.a(s,C.e.Zero(),C.e.Backward(),0,1,o._loader.babylonScene);l.angle=2*(a.spot&&a.spot.outerConeAngle||Math.PI/4),l.innerAngle=2*(a.spot&&a.spot.innerConeAngle||0),t=l;break;default:throw o._loader.babylonScene._blockEntityCollection=!1,new Error(r+": Invalid light type ("+a.type+")")}o._loader.babylonScene._blockEntityCollection=!1,t.falloffType=Ue.a.FALLOFF_GLTF,t.diffuse=a.color?L.a.FromArray(a.color):L.a.White(),t.intensity=void 0==a.intensity?1:a.intensity,t.range=void 0==a.range?Number.MAX_VALUE:a.range,t.parent=e,o._loader._babylonLights.push(t),Ie.AddPointerMetadata(t,r),n(e)}))}))},e}();Ie.RegisterExtension("KHR_lights_punctual",(function(e){return new Ge(e)}));var He=function(){function e(e){this.name="KHR_materials_pbrSpecularGlossiness",this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_pbrSpecularGlossiness")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){var a=new Array;return a.push(o._loader.loadMaterialBasePropertiesAsync(e,t,n)),a.push(o._loadSpecularGlossinessPropertiesAsync(r,t,i,n)),o._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(a).then((function(){}))}))},e.prototype._loadSpecularGlossinessPropertiesAsync=function(e,t,n,o){if(!(o instanceof Ce.a))throw new Error(e+": Material type not supported");var r=new Array;return o.metallic=null,o.roughness=null,n.diffuseFactor?(o.albedoColor=L.a.FromArray(n.diffuseFactor),o.alpha=n.diffuseFactor[3]):o.albedoColor=L.a.White(),o.reflectivityColor=n.specularFactor?L.a.FromArray(n.specularFactor):L.a.White(),o.microSurface=void 0==n.glossinessFactor?1:n.glossinessFactor,n.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(e+"/diffuseTexture",n.diffuseTexture,(function(e){e.name=o.name+" (Diffuse)",o.albedoTexture=e}))),n.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(e+"/specularGlossinessTexture",n.specularGlossinessTexture,(function(e){e.name=o.name+" (Specular Glossiness)",o.reflectivityTexture=e}))),o.reflectivityTexture.hasAlpha=!0,o.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then((function(){}))},e}();Ie.RegisterExtension("KHR_materials_pbrSpecularGlossiness",(function(e){return new He(e)}));var Ke=function(){function e(e){this.name="KHR_materials_unlit",this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_unlit")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(){return o._loadUnlitPropertiesAsync(e,t,n)}))},e.prototype._loadUnlitPropertiesAsync=function(e,t,n){if(!(n instanceof Ce.a))throw new Error(e+": Material type not supported");var o=new Array;n.unlit=!0;var r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(n.albedoColor=L.a.FromArray(r.baseColorFactor),n.alpha=r.baseColorFactor[3]):n.albedoColor=L.a.White(),r.baseColorTexture&&o.push(this._loader.loadTextureInfoAsync(e+"/baseColorTexture",r.baseColorTexture,(function(e){e.name=n.name+" (Base Color)",n.albedoTexture=e})))),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(o).then((function(){}))},e}();Ie.RegisterExtension("KHR_materials_unlit",(function(e){return new Ke(e)}));var Xe=function(){function e(e){this.name="KHR_materials_clearcoat",this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_clearcoat")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){var a=new Array;return a.push(o._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(o._loadClearCoatPropertiesAsync(r,i,n)),Promise.all(a).then((function(){}))}))},e.prototype._loadClearCoatPropertiesAsync=function(e,t,n){if(!(n instanceof Ce.a))throw new Error(e+": Material type not supported");var o=new Array;return n.clearCoat.isEnabled=!0,void 0!=t.clearcoatFactor?n.clearCoat.intensity=t.clearcoatFactor:n.clearCoat.intensity=0,t.clearcoatTexture&&o.push(this._loader.loadTextureInfoAsync(e+"/clearcoatTexture",t.clearcoatTexture,(function(e){e.name=n.name+" (ClearCoat Intensity)",n.clearCoat.texture=e}))),void 0!=t.clearcoatRoughnessFactor?n.clearCoat.roughness=t.clearcoatRoughnessFactor:n.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&o.push(this._loader.loadTextureInfoAsync(e+"/clearcoatRoughnessTexture",t.clearcoatRoughnessTexture,(function(e){e.name=n.name+" (ClearCoat Roughness)",n.clearCoat.texture=e}))),t.clearcoatNormalTexture&&(o.push(this._loader.loadTextureInfoAsync(e+"/clearcoatNormalTexture",t.clearcoatNormalTexture,(function(e){e.name=n.name+" (ClearCoat Normal)",n.clearCoat.bumpTexture=e}))),n.invertNormalMapX=!n.getScene().useRightHandedSystem,n.invertNormalMapY=n.getScene().useRightHandedSystem,void 0!=t.clearcoatNormalTexture.scale&&(n.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(o).then((function(){}))},e}();Ie.RegisterExtension("KHR_materials_clearcoat",(function(e){return new Xe(e)}));var Ye=function(){function e(e){this.name="KHR_materials_sheen",this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_sheen")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){var a=new Array;return a.push(o._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(o._loadSheenPropertiesAsync(r,i,n)),Promise.all(a).then((function(){}))}))},e.prototype._loadSheenPropertiesAsync=function(e,t,n){if(!(n instanceof Ce.a))throw new Error(e+": Material type not supported");var o=new Array;return n.sheen.isEnabled=!0,void 0!=t.intensityFactor?n.sheen.intensity=t.intensityFactor:n.sheen.intensity=0,void 0!=t.colorFactor&&(n.sheen.color=L.a.FromArray(t.colorFactor)),t.colorIntensityTexture&&o.push(this._loader.loadTextureInfoAsync(e+"/sheenTexture",t.colorIntensityTexture,(function(e){e.name=n.name+" (Sheen Intensity)",n.sheen.texture=e}))),Promise.all(o).then((function(){}))},e}();Ie.RegisterExtension("KHR_materials_sheen",(function(e){return new Ye(e)}));var Qe=function(){function e(e){this.name="KHR_materials_specular",this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_specular")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){var a=new Array;return a.push(o._loader.loadMaterialPropertiesAsync(e,t,n)),a.push(o._loadSpecularPropertiesAsync(r,i,n)),Promise.all(a).then((function(){}))}))},e.prototype._loadSpecularPropertiesAsync=function(e,t,n){if(!(n instanceof Ce.a))throw new Error(e+": Material type not supported");return void 0!==t.specularFactor&&(n.metallicF0Factor=t.specularFactor),t.specularTexture&&(n.useMetallicF0FactorFromMetallicTexture=!0),Promise.resolve()},e}();Ie.RegisterExtension("KHR_materials_specular",(function(e){return new Qe(e)}));var Ze=function(){function e(e){this.name="KHR_mesh_quantization",this.enabled=e.isExtensionUsed("KHR_mesh_quantization")}return e.prototype.dispose=function(){},e}();Ie.RegisterExtension("KHR_mesh_quantization",(function(e){return new Ze(e)}));var Je=function(){function e(e){this.name="KHR_texture_basisu",this._loader=e,this.enabled=e.isExtensionUsed("KHR_texture_basisu")}return e.prototype.dispose=function(){delete this._loader},e.prototype._loadTextureAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){var a=void 0==t.sampler?Ie.DefaultSampler:Be.Get(e+"/sampler",o._loader.gltf.samplers,t.sampler),s=Be.Get(r+"/source",o._loader.gltf.images,i.source);return o._loader._createTextureAsync(e,a,s,(function(e){e.gammaSpace=!1,n(e)}))}))},e}();Ie.RegisterExtension("KHR_texture_basisu",(function(e){return new Je(e)}));var $e=function(){function e(e){this.name="KHR_texture_transform",this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_texture_transform")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadTextureInfoAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(r,i){return o._loader.loadTextureInfoAsync(e,t,(function(e){if(!(e instanceof z.a))throw new Error(r+": Texture type not supported");i.offset&&(e.uOffset=i.offset[0],e.vOffset=i.offset[1]),e.uRotationCenter=0,e.vRotationCenter=0,i.rotation&&(e.wAng=-i.rotation),i.scale&&(e.uScale=i.scale[0],e.vScale=i.scale[1]),void 0!=i.texCoord&&(e.coordinatesIndex=i.texCoord),n(e)}))}))},e}();Ie.RegisterExtension("KHR_texture_transform",(function(e){return new $e(e)}));var et=n(206),tt=n(129),nt=n(207),ot=function(){function e(e){this.name="MSFT_audio_emitter",this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_audio_emitter")}return e.prototype.dispose=function(){delete this._loader,delete this._clips,delete this._emitters},e.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,Be.Assign(this._clips),Be.Assign(this._emitters)}},e.prototype.loadSceneAsync=function(e,t){var n=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(o,r){var i=new Array;i.push(n._loader.loadSceneAsync(e,t));for(var a=0,s=r.emitters;a<s.length;a++){var l=s[a],u=Be.Get(o+"/emitters",n._emitters,l);if(void 0!=u.refDistance||void 0!=u.maxDistance||void 0!=u.rolloffFactor||void 0!=u.distanceModel||void 0!=u.innerAngle||void 0!=u.outerAngle)throw new Error(o+": Direction or Distance properties are not allowed on emitters attached to a scene");i.push(n._loadEmitterAsync(o+"/emitters/"+u.index,u))}return Promise.all(i).then((function(){}))}))},e.prototype.loadNodeAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(e,r){var i=new Array;return o._loader.loadNodeAsync(e,t,(function(t){for(var s=function(n){var r=Be.Get(e+"/emitters",o._emitters,n);i.push(o._loadEmitterAsync(e+"/emitters/"+r.index,r).then((function(){for(var e=0,n=r._babylonSounds;e<n.length;e++){var o=n[e];o.attachToMesh(t),void 0==r.innerAngle&&void 0==r.outerAngle||(o.setLocalDirectionToMesh(C.e.Forward()),o.setDirectionalCone(2*a.b.ToDegrees(void 0==r.innerAngle?Math.PI:r.innerAngle),2*a.b.ToDegrees(void 0==r.outerAngle?Math.PI:r.outerAngle),0))}})))},l=0,u=r.emitters;l<u.length;l++){s(u[l])}n(t)})).then((function(e){return Promise.all(i).then((function(){return e}))}))}))},e.prototype.loadAnimationAsync=function(e,t){var n=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(o,r){return n._loader.loadAnimationAsync(e,t).then((function(i){var a=new Array;Be.Assign(r.events);for(var s=0,l=r.events;s<l.length;s++){var u=l[s];a.push(n._loadAnimationEventAsync(o+"/events/"+u.index,e,t,u,i))}return Promise.all(a).then((function(){return i}))}))}))},e.prototype._loadClipAsync=function(e,t){if(t._objectURL)return t._objectURL;var n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{var o=Be.Get(e+"/bufferView",this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync("#/bufferViews/"+o.index,o)}return t._objectURL=n.then((function(e){return URL.createObjectURL(new Blob([e],{type:t.mimeType}))})),t._objectURL},e.prototype._loadEmitterAsync=function(e,t){var n=this;if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){for(var o=new Array,r=t.name||"emitter"+t.index,i={loop:!1,autoplay:!1,volume:void 0==t.volume?1:t.volume},s=function(e){var a="#/extensions/"+l.name+"/clips",s=Be.Get(a,l._clips,t.clips[e].clip);o.push(l._loadClipAsync(a+"/"+t.clips[e].clip,s).then((function(o){var a=t._babylonSounds[e]=new tt.a(r,o,n._loader.babylonScene,null,i);a.refDistance=t.refDistance||1,a.maxDistance=t.maxDistance||256,a.rolloffFactor=t.rolloffFactor||1,a.distanceModel=t.distanceModel||"exponential",a._positionInEmitterSpace=!0})))},l=this,u=0;u<t.clips.length;u++)s(u);var c=Promise.all(o).then((function(){var e=t.clips.map((function(e){return e.weight||1})),n=new nt.a(t.loop||!1,t._babylonSounds,e);t.innerAngle&&(n.directionalConeInnerAngle=2*a.b.ToDegrees(t.innerAngle)),t.outerAngle&&(n.directionalConeOuterAngle=2*a.b.ToDegrees(t.outerAngle)),t.volume&&(n.volume=t.volume),t._babylonData.sound=n}));t._babylonData={loaded:c}}return t._babylonData.loaded},e.prototype._getEventAction=function(e,t,n,o,r){switch(n){case"play":return function(e){var n=(r||0)+(e-o);t.play(n)};case"stop":return function(e){t.stop()};case"pause":return function(e){t.pause()};default:throw new Error(e+": Unsupported action "+n)}},e.prototype._loadAnimationEventAsync=function(e,t,n,o,r){var i=this;if(0==r.targetedAnimations.length)return Promise.resolve();var a=r.targetedAnimations[0],s=o.emitter,l=Be.Get("#/extensions/"+this.name+"/emitters",this._emitters,s);return this._loadEmitterAsync(e,l).then((function(){var t=l._babylonData.sound;if(t){var n=new et.a(o.time,i._getEventAction(e,t,o.action,o.time,o.startOffset));a.animation.addEvent(n),r.onAnimationGroupEndObservable.add((function(){t.stop()})),r.onAnimationGroupPauseObservable.add((function(){t.pause()}))}}))},e}();Ie.RegisterExtension("MSFT_audio_emitter",(function(e){return new ot(e)}));var rt=function(){function e(e){this.name="MSFT_lod",this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new i.c,this.onMaterialLODsLoadedObservable=new i.c,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._indexLOD=null,this._bufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_lod")}return e.prototype.dispose=function(){delete this._loader,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._indexLOD=null,this._bufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()},e.prototype.onReady=function(){for(var e=this,t=function(t){var o=Promise.all(n._nodePromiseLODs[t]).then((function(){0!==t&&e._loader.endPerformanceCounter("Node LOD "+t),e._loader.log("Loaded node LOD "+t),e.onNodeLODsLoadedObservable.notifyObservers(t),t!==e._nodePromiseLODs.length-1&&(e._loader.startPerformanceCounter("Node LOD "+(t+1)),e._nodeSignalLODs[t]&&e._nodeSignalLODs[t].resolve())}));n._loader._completePromises.push(o)},n=this,o=0;o<this._nodePromiseLODs.length;o++)t(o);var r=function(t){var n=Promise.all(i._materialPromiseLODs[t]).then((function(){0!==t&&e._loader.endPerformanceCounter("Material LOD "+t),e._loader.log("Loaded material LOD "+t),e.onMaterialLODsLoadedObservable.notifyObservers(t),t!==e._materialPromiseLODs.length-1&&(e._loader.startPerformanceCounter("Material LOD "+(t+1)),e._materialSignalLODs[t]&&e._materialSignalLODs[t].resolve())}));i._loader._completePromises.push(n)},i=this;for(o=0;o<this._materialPromiseLODs.length;o++)r(o);for(o=1;o<this._bufferLODs.length;o++)this._loadBufferLOD(o)},e.prototype.loadSceneAsync=function(e,t){var n=this._loader.loadSceneAsync(e,t);return 0!==this._bufferLODs.length&&this._loadBufferLOD(0),n},e.prototype.loadNodeAsync=function(e,t,n){var o=this;return Ie.LoadExtensionAsync(e,t,this.name,(function(e,n){var r,i=o._getLODs(e,t,o._loader.gltf.nodes,n.ids);o._loader.logOpen(""+e);for(var a=function(e){var t=i[e];o._indexLOD=e,0!==e&&(o._nodeIndexLOD=e,o._nodeSignalLODs[e]=o._nodeSignalLODs[e]||new Se.a);var n=o._loader.loadNodeAsync("#/nodes/"+t.index,t,(function(e){e.setEnabled(!1)})).then((function(t){if(0!==e){var n=i[e-1];n._babylonTransformNode&&(o._disposeTransformNode(n._babylonTransformNode),delete n._babylonTransformNode)}return t.setEnabled(!0),t}));0===e?r=n:o._nodeIndexLOD=null,o._indexLOD=null,o._nodePromiseLODs[e]=o._nodePromiseLODs[e]||[],o._nodePromiseLODs[e].push(n)},s=0;s<i.length;s++)a(s);return o._loader.logClose(),r}))},e.prototype._loadMaterialAsync=function(e,t,n,o,r){var i=this;return this._indexLOD?null:Ie.LoadExtensionAsync(e,t,this.name,(function(e,a){var s,l=i._getLODs(e,t,i._loader.gltf.materials,a.ids);i._loader.logOpen(""+e);for(var u=function(e){var t=l[e];i._indexLOD=e,0!==e&&(i._materialIndexLOD=e);var a=i._loader._loadMaterialAsync("#/materials/"+t.index,t,n,o,(function(t){0===e&&r(t)})).then((function(t){if(0!==e){r(t);var n=l[e-1]._data;n[o]&&(i._disposeMaterials([n[o].babylonMaterial]),delete n[o])}return t}));0===e?s=a:i._materialIndexLOD=null,i._indexLOD=null,i._materialPromiseLODs[e]=i._materialPromiseLODs[e]||[],i._materialPromiseLODs[e].push(a)},c=0;c<l.length;c++)u(c);return i._loader.logClose(),s}))},e.prototype._loadUriAsync=function(e,t,n){var o=this;if(null!==this._materialIndexLOD){this._loader.log("deferred");var r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new Se.a,this._materialSignalLODs[r].promise.then((function(){return o._loader.loadUriAsync(e,t,n)}))}if(null!==this._nodeIndexLOD){this._loader.log("deferred");r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new Se.a,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then((function(){return o._loader.loadUriAsync(e,t,n)}))}return null},e.prototype.loadBufferAsync=function(e,t,n,o){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");var r=this._indexLOD||0,i=n,a=i+o-1,s=this._bufferLODs[r];return s?(s.start=Math.min(s.start,i),s.end=Math.max(s.end,a)):(s={start:i,end:a,loaded:new Se.a},this._bufferLODs[r]=s),s.loaded.promise.then((function(e){return new Uint8Array(e.buffer,e.byteOffset+n-s.start,o)}))}return null},e.prototype._loadBufferLOD=function(e){var t=this._bufferLODs[e];this._loader.bin.readAsync(t.start,t.end-t.start+1).then((function(e){t.loaded.resolve(e)}),(function(e){t.loaded.reject(e)}))},e.prototype._getLODs=function(e,t,n,o){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");for(var r=new Array,i=o.length-1;i>=0;i--)if(r.push(Be.Get(e+"/ids/"+o[i],n,o[i])),r.length===this.maxLODsToLoad)return r;return r.push(t),r},e.prototype._disposeTransformNode=function(e){var t=this,n=new Array,o=e.material;o&&n.push(o);for(var r=0,i=e.getChildMeshes();r<i.length;r++){var a=i[r];a.material&&n.push(a.material)}e.dispose();var s=n.filter((function(e){return t._loader.babylonScene.meshes.every((function(t){return t.material!=e}))}));this._disposeMaterials(s)},e.prototype._disposeMaterials=function(e){for(var t={},n=0,o=e;n<o.length;n++){for(var r=0,i=(c=o[n]).getActiveTextures();r<i.length;r++){var a=i[r];t[a.uniqueId]=a}c.dispose()}for(var s in t)for(var l=0,u=this._loader.babylonScene.materials;l<u.length;l++){var c;(c=u[l]).hasTexture(t[s])&&delete t[s]}for(var s in t)t[s].dispose()},e}();Ie.RegisterExtension("MSFT_lod",(function(e){return new rt(e)}));var it=function(){function e(e){this.name="MSFT_minecraftMesh",this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_minecraftMesh")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this;return Ie.LoadExtraAsync(e,t,this.name,(function(r,i){if(i){if(!(n instanceof Ce.a))throw new Error(r+": Material type not supported");var a=o._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,a}return null}))},e}();Ie.RegisterExtension("MSFT_minecraftMesh",(function(e){return new it(e)}));var at=function(){function e(e){this.name="MSFT_sRGBFactors",this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_sRGBFactors")}return e.prototype.dispose=function(){delete this._loader},e.prototype.loadMaterialPropertiesAsync=function(e,t,n){var o=this;return Ie.LoadExtraAsync(e,t,this.name,(function(r,i){if(i){if(!(n instanceof Ce.a))throw new Error(r+": Material type not supported");var a=o._loader.loadMaterialPropertiesAsync(e,t,n);return n.albedoTexture||n.albedoColor.toLinearSpaceToRef(n.albedoColor),n.reflectivityTexture||n.reflectivityColor.toLinearSpaceToRef(n.reflectivityColor),a}return null}))},e}();Ie.RegisterExtension("MSFT_sRGBFactors",(function(e){return new at(e)}));var st=function(){function e(e){this.name="ExtrasAsMetadata",this.enabled=!0,this._loader=e}return e.prototype._assignExtras=function(e,t){if(t.extras&&Object.keys(t.extras).length>0){var n=e.metadata=e.metadata||{};(n.gltf=n.gltf||{}).extras=t.extras}},e.prototype.dispose=function(){delete this._loader},e.prototype.loadNodeAsync=function(e,t,n){var o=this;return this._loader.loadNodeAsync(e,t,(function(e){o._assignExtras(e,t),n(e)}))},e.prototype.loadCameraAsync=function(e,t,n){var o=this;return this._loader.loadCameraAsync(e,t,(function(e){o._assignExtras(e,t),n(e)}))},e.prototype.createMaterial=function(e,t,n){var o=this._loader.createMaterial(e,t,n);return this._assignExtras(o,t),o},e}();Ie.RegisterExtension("ExtrasAsMetadata",(function(e){return new st(e)}))},269:function(e,t,n){e.exports=function e(t,n,o){function r(a,s){if(!n[a]){if(!t[a]){if(i)return i(a,!0);throw new Error("Cannot find module '"+a+"'")}var l=n[a]={exports:{}};t[a][0].call(l.exports,(function(e){var n=t[a][1][e];return r(n||e)}),l,l.exports,e,t,n,o)}return n[a].exports}for(var i=!1,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(e,t,n){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,n){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t,n){var o=e("../math/Vec3");function r(e){e=e||{},this.lowerBound=new o,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new o,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=r;var i=new o;r.prototype.setFromPoints=function(e,t,n,o){var r=this.lowerBound,a=this.upperBound,s=n;r.copy(e[0]),s&&s.vmult(r,r),a.copy(r);for(var l=1;l<e.length;l++){var u=e[l];s&&(s.vmult(u,i),u=i),u.x>a.x&&(a.x=u.x),u.x<r.x&&(r.x=u.x),u.y>a.y&&(a.y=u.y),u.y<r.y&&(r.y=u.y),u.z>a.z&&(a.z=u.z),u.z<r.z&&(r.z=u.z)}return t&&(t.vadd(r,r),t.vadd(a,a)),o&&(r.x-=o,r.y-=o,r.z-=o,a.x+=o,a.y+=o,a.z+=o),this},r.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(e){var t=e.lowerBound.x;this.lowerBound.x>t&&(this.lowerBound.x=t);var n=e.upperBound.x;this.upperBound.x<n&&(this.upperBound.x=n),t=e.lowerBound.y,this.lowerBound.y>t&&(this.lowerBound.y=t),n=e.upperBound.y,this.upperBound.y<n&&(this.upperBound.y=n),t=e.lowerBound.z,this.lowerBound.z>t&&(this.lowerBound.z=t),n=e.upperBound.z,this.upperBound.z<n&&(this.upperBound.z=n)},r.prototype.overlaps=function(e){var t=this.lowerBound,n=this.upperBound,o=e.lowerBound,r=e.upperBound;return(o.x<=n.x&&n.x<=r.x||t.x<=r.x&&r.x<=n.x)&&(o.y<=n.y&&n.y<=r.y||t.y<=r.y&&r.y<=n.y)&&(o.z<=n.z&&n.z<=r.z||t.z<=r.z&&r.z<=n.z)},r.prototype.contains=function(e){var t=this.lowerBound,n=this.upperBound,o=e.lowerBound,r=e.upperBound;return t.x<=o.x&&n.x>=r.x&&t.y<=o.y&&n.y>=r.y&&t.z<=o.z&&n.z>=r.z},r.prototype.getCorners=function(e,t,n,o,r,i,a,s){var l=this.lowerBound,u=this.upperBound;e.copy(l),t.set(u.x,l.y,l.z),n.set(u.x,u.y,l.z),o.set(l.x,u.y,u.z),r.set(u.x,l.y,l.z),i.set(l.x,u.y,l.z),a.set(l.x,l.y,u.z),s.copy(u)};var a=[new o,new o,new o,new o,new o,new o,new o,new o];r.prototype.toLocalFrame=function(e,t){var n=a,o=n[0],r=n[1],i=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7];this.getCorners(o,r,i,s,l,u,c,h);for(var p=0;8!==p;p++){var d=n[p];e.pointToLocal(d,d)}return t.setFromPoints(n)},r.prototype.toWorldFrame=function(e,t){var n=a,o=n[0],r=n[1],i=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7];this.getCorners(o,r,i,s,l,u,c,h);for(var p=0;8!==p;p++){var d=n[p];e.pointToWorld(d,d)}return t.setFromPoints(n)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t,n){function o(){this.matrix=[]}t.exports=o,o.prototype.get=function(e,t){if(e=e.index,(t=t.index)>e){var n=t;t=e,e=n}return this.matrix[(e*(e+1)>>1)+t-1]},o.prototype.set=function(e,t,n){if(e=e.index,(t=t.index)>e){var o=t;t=e,e=o}this.matrix[(e*(e+1)>>1)+t-1]=n?1:0},o.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},o.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,n){var o=e("../objects/Body"),r=e("../math/Vec3"),i=e("../math/Quaternion");function a(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),t.exports=a,a.prototype.collisionPairs=function(e,t,n){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var s=o.STATIC|o.KINEMATIC;a.prototype.needBroadphaseCollision=function(e,t){return 0!==(e.collisionFilterGroup&t.collisionFilterMask)&&0!==(t.collisionFilterGroup&e.collisionFilterMask)&&(0===(e.type&s)&&e.sleepState!==o.SLEEPING||0===(t.type&s)&&t.sleepState!==o.SLEEPING)},a.prototype.intersectionTest=function(e,t,n,o){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,n,o):this.doBoundingSphereBroadphase(e,t,n,o)};var l=new r;new r,new i,new r,a.prototype.doBoundingSphereBroadphase=function(e,t,n,o){var r=l;t.position.vsub(e.position,r);var i=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<i&&(n.push(e),o.push(t))},a.prototype.doBoundingBoxBroadphase=function(e,t,n,o){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(n.push(e),o.push(t))};var u={keys:[]},c=[],h=[];a.prototype.makePairsUnique=function(e,t){for(var n=u,o=c,r=h,i=e.length,a=0;a!==i;a++)o[a]=e[a],r[a]=t[a];for(e.length=0,t.length=0,a=0;a!==i;a++){var s=o[a].id,l=r[a].id;n[p=s<l?s+","+l:l+","+s]=a,n.keys.push(p)}for(a=0;a!==n.keys.length;a++){var p=n.keys.pop(),d=n[p];e.push(o[d]),t.push(r[d]),delete n[p]}},a.prototype.setWorld=function(e){};var p=new r;a.boundingSphereCheck=function(e,t){var n=p;return e.position.vsub(t.position,n),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>n.norm2()},a.prototype.aabbQuery=function(e,t,n){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t,n){t.exports=a;var o=e("./Broadphase"),r=e("../math/Vec3"),i=e("../shapes/Shape");function a(e,t,n,i,a){o.apply(this),this.nx=n||10,this.ny=i||10,this.nz=a||10,this.aabbMin=e||new r(100,100,100),this.aabbMax=t||new r(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var l=0;l<s;l++)this.bins[l]=[],this.binLengths[l]=0}a.prototype=new o,a.prototype.constructor=a;var s=new r;new r,a.prototype.collisionPairs=function(e,t,n){for(var o=e.numObjects(),r=e.bodies,a=this.aabbMax,l=this.aabbMin,u=this.nx,c=this.ny,h=this.nz,p=c*h,d=h,f=a.x,y=a.y,v=a.z,m=l.x,b=l.y,g=l.z,_=u/(f-m),x=c/(y-b),A=h/(v-g),w=(f-m)/u,E=(y-b)/c,T=(v-g)/h,S=.5*Math.sqrt(w*w+E*E+T*T),M=i.types,C=M.SPHERE,L=M.PLANE,R=(M.BOX,M.COMPOUND,M.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,P=this.bins.length,N=0;N!==P;N++)O[N]=0;var B=Math.ceil;function I(e,t,n,o,r,i,a){var s=(e-m)*_|0,l=(t-b)*x|0,f=(n-g)*A|0,y=B((o-m)*_),v=B((r-b)*x),w=B((i-g)*A);s<0?s=0:s>=u&&(s=u-1),l<0?l=0:l>=c&&(l=c-1),f<0?f=0:f>=h&&(f=h-1),y<0?y=0:y>=u&&(y=u-1),v<0?v=0:v>=c&&(v=c-1),w<0?w=0:w>=h&&(w=h-1),l*=d,f*=1,y*=p,v*=d,w*=1;for(var E=s*=p;E<=y;E+=p)for(var T=l;T<=v;T+=d)for(var S=f;S<=w;S+=1){var M=E+T+S;R[M][O[M]++]=a}}for(l=Math.min,a=Math.max,N=0;N!==o;N++){var F=(te=r[N]).shape;switch(F.type){case C:var V=te.position.x,D=te.position.y,q=te.position.z,z=F.radius;I(V-z,D-z,q-z,V+z,D+z,q+z,te);break;case L:F.worldNormalNeedsUpdate&&F.computeWorldNormal(te.quaternion);var W=F.worldNormal,k=m+.5*w-te.position.x,j=b+.5*E-te.position.y,U=g+.5*T-te.position.z,G=s;G.set(k,j,U);for(var H=0,K=0;H!==u;H++,K+=p,G.y=j,G.x+=w)for(var X=0,Y=0;X!==c;X++,Y+=d,G.z=U,G.y+=E)for(var Q=0,Z=0;Q!==h;Q++,Z+=1,G.z+=T)if(G.dot(W)<S){var J=K+Y+Z;R[J][O[J]++]=te}break;default:te.aabbNeedsUpdate&&te.computeAABB(),I(te.aabb.lowerBound.x,te.aabb.lowerBound.y,te.aabb.lowerBound.z,te.aabb.upperBound.x,te.aabb.upperBound.y,te.aabb.upperBound.z,te)}}for(N=0;N!==P;N++){var $=O[N];if($>1){var ee=R[N];for(H=0;H!==$;H++){var te=ee[H];for(X=0;X!==H;X++){var ne=ee[X];this.needBroadphaseCollision(te,ne)&&this.intersectionTest(te,ne,t,n)}}}}this.makePairsUnique(t,n)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t,n){t.exports=i;var o=e("./Broadphase"),r=e("./AABB");function i(){o.apply(this)}i.prototype=new o,i.prototype.constructor=i,i.prototype.collisionPairs=function(e,t,n){var o,r,i,a,s=e.bodies,l=s.length;for(o=0;o!==l;o++)for(r=0;r!==o;r++)i=s[o],a=s[r],this.needBroadphaseCollision(i,a)&&this.intersectionTest(i,a,t,n)},new r,i.prototype.aabbQuery=function(e,t,n){n=n||[];for(var o=0;o<e.bodies.length;o++){var r=e.bodies[o];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&n.push(r)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,n){function o(){this.matrix={}}t.exports=o,o.prototype.get=function(e,t){if(e=e.id,(t=t.id)>e){var n=t;t=e,e=n}return e+"-"+t in this.matrix},o.prototype.set=function(e,t,n){if(e=e.id,(t=t.id)>e){var o=t;t=e,e=o}n?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},o.prototype.reset=function(){this.matrix={}},o.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,n){t.exports=u;var o=e("../math/Vec3"),r=e("../math/Quaternion"),i=e("../math/Transform"),a=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),s=e("../shapes/Shape"),l=e("../collision/AABB");function u(e,t){this.from=e?e.clone():new o,this.to=t?t.clone():new o,this._direction=new o,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=u.ANY,this.result=new a,this.hasHit=!1,this.callback=function(e){}}u.prototype.constructor=u,u.CLOSEST=1,u.ANY=2,u.ALL=4;var c=new l,h=[];u.prototype.intersectWorld=function(e,t){return this.mode=t.mode||u.ANY,this.result=t.result||new a,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask="undefined"!==typeof t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!==typeof t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(c),h.length=0,e.broadphase.aabbQuery(e,c,h),this.intersectBodies(h),this.hasHit};var p=new o,d=new o;function f(e,t,n,o){o.vsub(t,B),n.vsub(t,p),e.vsub(t,d);var r,i,a=B.dot(B),s=B.dot(p),l=B.dot(d),u=p.dot(p),c=p.dot(d);return(r=u*l-s*c)>=0&&(i=a*c-s*l)>=0&&r+i<a*u-s*s}u.pointInTriangle=f;var y=new o,v=new r;u.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var n=this.checkCollisionResponse;if((!n||e.collisionResponse)&&0!==(this.collisionFilterGroup&e.collisionFilterMask)&&0!==(e.collisionFilterGroup&this.collisionFilterMask))for(var o=y,r=v,i=0,a=e.shapes.length;i<a;i++){var s=e.shapes[i];if((!n||s.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[i],r),e.quaternion.vmult(e.shapeOffsets[i],o),o.vadd(e.position,o),this.intersectShape(s,r,o,e),this.result._shouldStop))break}},u.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var n=0,o=e.length;!this.result._shouldStop&&n<o;n++)this.intersectBody(e[n])},u.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},u.prototype.intersectShape=function(e,t,n,o){if(!(function(e,t,n){n.vsub(e,B);var o=B.dot(t);return t.mult(o,I),I.vadd(e,I),n.distanceTo(I)}(this.from,this._direction,n)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,n,o)}},new o,new o;var m=new o,b=new o,g=new o,_=new o;new o,new a,u.prototype.intersectBox=function(e,t,n,o){return this.intersectConvex(e.convexPolyhedronRepresentation,t,n,o)},u.prototype[s.types.BOX]=u.prototype.intersectBox,u.prototype.intersectPlane=function(e,t,n,r){var i=this.from,a=this.to,s=this._direction,l=new o(0,0,1);t.vmult(l,l);var u=new o;i.vsub(n,u);var c=u.dot(l);if(a.vsub(n,u),!(c*u.dot(l)>0)&&!(i.distanceTo(a)<c)){var h=l.dot(s);if(!(Math.abs(h)<this.precision)){var p=new o,d=new o,f=new o;i.vsub(n,p);var y=-l.dot(p)/h;s.scale(y,d),i.vadd(d,f),this.reportIntersection(l,f,e,r,-1)}}},u.prototype[s.types.PLANE]=u.prototype.intersectPlane,u.prototype.getAABB=function(e){var t=this.to,n=this.from;e.lowerBound.x=Math.min(t.x,n.x),e.lowerBound.y=Math.min(t.y,n.y),e.lowerBound.z=Math.min(t.z,n.z),e.upperBound.x=Math.max(t.x,n.x),e.upperBound.y=Math.max(t.y,n.y),e.upperBound.z=Math.max(t.z,n.z)};var x={faceList:[0]};u.prototype.intersectHeightfield=function(e,t,n,r){e.data,e.elementSize;var a=new o,s=new u(this.from,this.to);i.pointToLocalFrame(n,t,s.from,s.from),i.pointToLocalFrame(n,t,s.to,s.to);var l=[],c=null,h=null,p=null,d=null,f=e.getIndexOfPosition(s.from.x,s.from.y,l,!1);if(f&&(c=l[0],h=l[1],p=l[0],d=l[1]),(f=e.getIndexOfPosition(s.to.x,s.to.y,l,!1))&&((null===c||l[0]<c)&&(c=l[0]),(null===p||l[0]>p)&&(p=l[0]),(null===h||l[1]<h)&&(h=l[1]),(null===d||l[1]>d)&&(d=l[1])),null!==c){var y=[];e.getRectMinMax(c,h,p,d,y);for(var v=c;v<=p;v++)for(var m=h;m<=d;m++){if(this.result._shouldStop)return;if(e.getConvexTrianglePillar(v,m,!1),i.pointToWorldFrame(n,t,e.pillarOffset,a),this.intersectConvex(e.pillarConvex,t,a,r,x),this.result._shouldStop)return;e.getConvexTrianglePillar(v,m,!0),i.pointToWorldFrame(n,t,e.pillarOffset,a),this.intersectConvex(e.pillarConvex,t,a,r,x)}}},u.prototype[s.types.HEIGHTFIELD]=u.prototype.intersectHeightfield;var A=new o,w=new o;u.prototype.intersectSphere=function(e,t,n,o){var r=this.from,i=this.to,a=e.radius,s=Math.pow(i.x-r.x,2)+Math.pow(i.y-r.y,2)+Math.pow(i.z-r.z,2),l=2*((i.x-r.x)*(r.x-n.x)+(i.y-r.y)*(r.y-n.y)+(i.z-r.z)*(r.z-n.z)),u=Math.pow(r.x-n.x,2)+Math.pow(r.y-n.y,2)+Math.pow(r.z-n.z,2)-Math.pow(a,2),c=Math.pow(l,2)-4*s*u,h=A,p=w;if(!(c<0))if(0===c)r.lerp(i,c,h),h.vsub(n,p),p.normalize(),this.reportIntersection(p,h,e,o,-1);else{var d=(-l-Math.sqrt(c))/(2*s),f=(-l+Math.sqrt(c))/(2*s);if(d>=0&&d<=1&&(r.lerp(i,d,h),h.vsub(n,p),p.normalize(),this.reportIntersection(p,h,e,o,-1)),this.result._shouldStop)return;f>=0&&f<=1&&(r.lerp(i,f,h),h.vsub(n,p),p.normalize(),this.reportIntersection(p,h,e,o,-1))}},u.prototype[s.types.SPHERE]=u.prototype.intersectSphere;var E=new o,T=(new o,new o,new o);u.prototype.intersectConvex=function(e,t,n,o,r){for(var i=E,a=T,s=r&&r.faceList||null,l=e.faces,u=e.vertices,c=e.faceNormals,h=this._direction,p=this.from,d=this.to,y=p.distanceTo(d),v=s?s.length:l.length,x=this.result,A=0;!x._shouldStop&&A<v;A++){var w=s?s[A]:A,S=l[w],M=c[w],C=t,L=n;a.copy(u[S[0]]),C.vmult(a,a),a.vadd(L,a),a.vsub(p,a),C.vmult(M,i);var R=h.dot(i);if(!(Math.abs(R)<this.precision)){var O=i.dot(a)/R;if(!(O<0)){h.mult(O,m),m.vadd(p,m),b.copy(u[S[0]]),C.vmult(b,b),L.vadd(b,b);for(var P=1;!x._shouldStop&&P<S.length-1;P++){g.copy(u[S[P]]),_.copy(u[S[P+1]]),C.vmult(g,g),C.vmult(_,_),L.vadd(g,g),L.vadd(_,_);var N=m.distanceTo(p);!f(m,b,g,_)&&!f(m,g,b,_)||N>y||this.reportIntersection(i,m,e,o,w)}}}}},u.prototype[s.types.CONVEXPOLYHEDRON]=u.prototype.intersectConvex;var S=new o,M=new o,C=new o,L=new o,R=new o,O=new o,P=(new l,[]),N=new i;u.prototype.intersectTrimesh=function(e,t,n,o,r){var a=S,s=P,l=N,u=T,c=M,h=C,p=L,d=O,y=R,v=(r&&r.faceList,e.indices),x=(e.vertices,e.faceNormals,this.from),A=this.to,w=this._direction;l.position.copy(n),l.quaternion.copy(t),i.vectorToLocalFrame(n,t,w,c),i.pointToLocalFrame(n,t,x,h),i.pointToLocalFrame(n,t,A,p);var E=h.distanceSquared(p);e.tree.rayQuery(this,l,s);for(var B=0,I=s.length;!this.result._shouldStop&&B!==I;B++){var F=s[B];e.getNormal(F,a),e.getVertex(v[3*F],b),b.vsub(h,u);var V=c.dot(a),D=a.dot(u)/V;if(!(D<0)){c.scale(D,m),m.vadd(h,m),e.getVertex(v[3*F+1],g),e.getVertex(v[3*F+2],_);var q=m.distanceSquared(h);!f(m,g,b,_)&&!f(m,b,g,_)||q>E||(i.vectorToWorldFrame(t,a,y),i.pointToWorldFrame(n,t,m,d),this.reportIntersection(y,d,e,o,F))}}s.length=0},u.prototype[s.types.TRIMESH]=u.prototype.intersectTrimesh,u.prototype.reportIntersection=function(e,t,n,o,r){var i=this.from,a=this.to,s=i.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(l.hitFaceIndex="undefined"!==typeof r?r:-1,this.mode){case u.ALL:this.hasHit=!0,l.set(i,a,e,t,n,o,s),l.hasHit=!0,this.callback(l);break;case u.CLOSEST:(s<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(i,a,e,t,n,o,s));break;case u.ANY:this.hasHit=!0,l.hasHit=!0,l.set(i,a,e,t,n,o,s),l._shouldStop=!0}};var B=new o,I=new o},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t,n){var o=e("../math/Vec3");function r(){this.rayFromWorld=new o,this.rayToWorld=new o,this.hitNormalWorld=new o,this.hitPointWorld=new o,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}t.exports=r,r.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(e,t,n,o,r,i,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(o),this.shape=r,this.body=i,this.distance=a}},{"../math/Vec3":30}],11:[function(e,t,n){e("../shapes/Shape");var o=e("../collision/Broadphase");function r(e){o.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var n=t.indexOf(e.body);-1!==n&&t.splice(n,1)},e&&this.setWorld(e)}t.exports=r,r.prototype=new o,r.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},r.insertionSortX=function(e){for(var t=1,n=e.length;t<n;t++){for(var o=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.x<=o.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=o}return e},r.insertionSortY=function(e){for(var t=1,n=e.length;t<n;t++){for(var o=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.y<=o.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=o}return e},r.insertionSortZ=function(e){for(var t=1,n=e.length;t<n;t++){for(var o=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.z<=o.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=o}return e},r.prototype.collisionPairs=function(e,t,n){var o,i,a=this.axisList,s=a.length,l=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),o=0;o!==s;o++){var u=a[o];for(i=o+1;i<s;i++){var c=a[i];if(this.needBroadphaseCollision(u,c)){if(!r.checkBounds(u,c,l))break;this.intersectionTest(u,c,t,n)}}}},r.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,n=e.length,o=0;o!==n;o++){var i=e[o];i.aabbNeedsUpdate&&i.computeAABB()}0===t?r.insertionSortX(e):1===t?r.insertionSortY(e):2===t&&r.insertionSortZ(e)},r.checkBounds=function(e,t,n){var o,r;0===n?(o=e.position.x,r=t.position.x):1===n?(o=e.position.y,r=t.position.y):2===n&&(o=e.position.z,r=t.position.z);var i=e.boundingRadius,a=t.boundingRadius;return r-a<o+i},r.prototype.autoDetectAxis=function(){for(var e=0,t=0,n=0,o=0,r=0,i=0,a=this.axisList,s=a.length,l=1/s,u=0;u!==s;u++){var c=a[u],h=c.position.x;e+=h,t+=h*h;var p=c.position.y;n+=p,o+=p*p;var d=c.position.z;r+=d,i+=d*d}var f=t-e*e*l,y=o-n*n*l,v=i-r*r*l;this.axisIndex=f>y?f>v?0:2:y>v?1:2},r.prototype.aabbQuery=function(e,t,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,r="x";1===o&&(r="y"),2===o&&(r="z");for(var i=this.axisList,a=(t.lowerBound[r],t.upperBound[r],0);a<i.length;a++){var s=i[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&n.push(s)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t,n){t.exports=s,e("./Constraint");var o=e("./PointToPointConstraint"),r=e("../equations/ConeEquation"),i=e("../equations/RotationalEquation"),a=(e("../equations/ContactEquation"),e("../math/Vec3"));function s(e,t,n){var s="undefined"!==typeof(n=n||{}).maxForce?n.maxForce:1e6,l=n.pivotA?n.pivotA.clone():new a,u=n.pivotB?n.pivotB.clone():new a;this.axisA=n.axisA?n.axisA.clone():new a,this.axisB=n.axisB?n.axisB.clone():new a,o.call(this,e,l,t,u,s),this.collideConnected=!!n.collideConnected,this.angle="undefined"!==typeof n.angle?n.angle:0;var c=this.coneEquation=new r(e,t,n),h=this.twistEquation=new i(e,t,n);this.twistAngle="undefined"!==typeof n.twistAngle?n.twistAngle:0,c.maxForce=0,c.minForce=-s,h.maxForce=0,h.minForce=-s,this.equations.push(c,h)}s.prototype=new o,s.constructor=s,new a,new a,s.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.coneEquation,r=this.twistEquation;o.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,n.axisA),t.vectorToWorldFrame(this.axisB,n.axisB),this.axisA.tangents(r.axisA,r.axisA),e.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),t.vectorToWorldFrame(r.axisB,r.axisB),n.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t,n){t.exports=r;var o=e("../utils/Utils");function r(e,t,n){n=o.defaults(n,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=n.collideConnected,n.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":53}],14:[function(e,t,n){t.exports=i;var o=e("./Constraint"),r=e("../equations/ContactEquation");function i(e,t,n,i){o.call(this,e,t),"undefined"===typeof n&&(n=e.position.distanceTo(t.position)),"undefined"===typeof i&&(i=1e6),this.distance=n;var a=this.distanceEquation=new r(e,t);this.equations.push(a),a.minForce=-i,a.maxForce=i}i.prototype=new o,i.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.distanceEquation,o=.5*this.distance,r=n.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(o,n.ri),r.mult(-o,n.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t,n){t.exports=s,e("./Constraint");var o=e("./PointToPointConstraint"),r=e("../equations/RotationalEquation"),i=e("../equations/RotationalMotorEquation"),a=(e("../equations/ContactEquation"),e("../math/Vec3"));function s(e,t,n){var s="undefined"!==typeof(n=n||{}).maxForce?n.maxForce:1e6,l=n.pivotA?n.pivotA.clone():new a,u=n.pivotB?n.pivotB.clone():new a;o.call(this,e,l,t,u,s),(this.axisA=n.axisA?n.axisA.clone():new a(1,0,0)).normalize(),(this.axisB=n.axisB?n.axisB.clone():new a(1,0,0)).normalize();var c=this.rotationalEquation1=new r(e,t,n),h=this.rotationalEquation2=new r(e,t,n),p=this.motorEquation=new i(e,t,s);p.enabled=!1,this.equations.push(c,h,p)}s.prototype=new o,s.constructor=s,s.prototype.enableMotor=function(){this.motorEquation.enabled=!0},s.prototype.disableMotor=function(){this.motorEquation.enabled=!1},s.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},s.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var l=new a,u=new a;s.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.motorEquation,r=this.rotationalEquation1,i=this.rotationalEquation2,a=l,s=u,c=this.axisA,h=this.axisB;o.prototype.update.call(this),e.quaternion.vmult(c,a),t.quaternion.vmult(h,s),a.tangents(r.axisA,i.axisA),r.axisB.copy(s),i.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,n.axisA),t.quaternion.vmult(this.axisB,n.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t,n){t.exports=a,e("./Constraint");var o=e("./PointToPointConstraint"),r=e("../equations/RotationalEquation"),i=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function a(e,t,n){var a="undefined"!==typeof(n=n||{}).maxForce?n.maxForce:1e6,s=new i,l=new i,u=new i;e.position.vadd(t.position,u),u.scale(.5,u),t.pointToLocalFrame(u,l),e.pointToLocalFrame(u,s),o.call(this,e,s,t,l,a);var c=this.rotationalEquation1=new r(e,t,n),h=this.rotationalEquation2=new r(e,t,n),p=this.rotationalEquation3=new r(e,t,n);this.equations.push(c,h,p)}a.prototype=new o,a.constructor=a,new i,new i,a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,a=this.rotationalEquation3;o.prototype.update.call(this),e.vectorToWorldFrame(i.UNIT_X,n.axisA),t.vectorToWorldFrame(i.UNIT_Y,n.axisB),e.vectorToWorldFrame(i.UNIT_Y,r.axisA),t.vectorToWorldFrame(i.UNIT_Z,r.axisB),e.vectorToWorldFrame(i.UNIT_Z,a.axisA),t.vectorToWorldFrame(i.UNIT_X,a.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t,n){t.exports=a;var o=e("./Constraint"),r=e("../equations/ContactEquation"),i=e("../math/Vec3");function a(e,t,n,a,s){o.call(this,e,n),s="undefined"!==typeof s?s:1e6,this.pivotA=t?t.clone():new i,this.pivotB=a?a.clone():new i;var l=this.equationX=new r(e,n),u=this.equationY=new r(e,n),c=this.equationZ=new r(e,n);this.equations.push(l,u,c),l.minForce=u.minForce=c.minForce=-s,l.maxForce=u.maxForce=c.maxForce=s,l.ni.set(1,0,0),u.ni.set(0,1,0),c.ni.set(0,0,1)}a.prototype=new o,a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.equationX,o=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,n.ri),t.quaternion.vmult(this.pivotB,n.rj),o.ri.copy(n.ri),o.rj.copy(n.rj),r.ri.copy(n.ri),r.rj.copy(n.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t,n){t.exports=i;var o=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function i(e,t,n){var i="undefined"!==typeof(n=n||{}).maxForce?n.maxForce:1e6;r.call(this,e,t,-i,i),this.axisA=n.axisA?n.axisA.clone():new o(1,0,0),this.axisB=n.axisB?n.axisB.clone():new o(0,1,0),this.angle="undefined"!==typeof n.angle?n.angle:0}i.prototype=new r,i.prototype.constructor=i;var a=new o,s=new o;i.prototype.computeB=function(e){var t=this.a,n=this.b,o=this.axisA,r=this.axisB,i=a,l=s,u=this.jacobianElementA,c=this.jacobianElementB;return o.cross(r,i),r.cross(o,l),u.rotational.copy(l),c.rotational.copy(i),-(Math.cos(this.angle)-o.dot(r))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t,n){t.exports=i;var o=e("./Equation"),r=e("../math/Vec3");function i(e,t,n){n="undefined"!==typeof n?n:1e6,o.call(this,e,t,0,n),this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}e("../math/Mat3"),i.prototype=new o,i.prototype.constructor=i;var a=new r,s=new r,l=new r;i.prototype.computeB=function(e){var t=this.a,n=this.b,o=this.bi,r=this.bj,i=this.ri,u=this.rj,c=a,h=s,p=o.velocity,d=o.angularVelocity,f=(o.force,o.torque,r.velocity),y=r.angularVelocity,v=(r.force,r.torque,l),m=this.jacobianElementA,b=this.jacobianElementB,g=this.ni;i.cross(g,c),u.cross(g,h),g.negate(m.spatial),c.negate(m.rotational),b.spatial.copy(g),b.rotational.copy(h),v.copy(r.position),v.vadd(u,v),v.vsub(o.position,v),v.vsub(i,v);var _=g.dot(v),x=this.restitution+1;return-_*t-(x*f.dot(g)-x*p.dot(g)+y.dot(h)-d.dot(c))*n-e*this.computeGiMf()};var u=new r,c=new r,h=new r,p=new r,d=new r;i.prototype.getImpactVelocityAlongNormal=function(){var e=u,t=c,n=h,o=p,r=d;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,o),this.bi.getVelocityAtWorldPoint(n,e),this.bj.getVelocityAtWorldPoint(o,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t,n){t.exports=i;var o=e("../math/JacobianElement"),r=e("../math/Vec3");function i(e,t,n,r){this.id=i.id++,this.minForce="undefined"===typeof n?-1e6:n,this.maxForce="undefined"===typeof r?1e6:r,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new o,this.jacobianElementB=new o,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}i.prototype.constructor=i,i.id=0,i.prototype.setSpookParams=function(e,t,n){var o=t,r=e,i=n;this.a=4/(i*(1+4*o)),this.b=4*o/(1+4*o),this.eps=4/(i*i*r*(1+4*o))},i.prototype.computeB=function(e,t,n){var o=this.computeGW();return-this.computeGq()*e-o*t-this.computeGiMf()*n},i.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,o=this.bj,r=n.position,i=o.position;return e.spatial.dot(r)+t.spatial.dot(i)};var a=new r;i.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,o=this.bj,r=n.velocity,i=o.velocity,s=n.angularVelocity||a,l=o.angularVelocity||a;return e.multiplyVectors(r,s)+t.multiplyVectors(i,l)},i.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,o=this.bj,r=n.vlambda,i=o.vlambda,s=n.wlambda||a,l=o.wlambda||a;return e.multiplyVectors(r,s)+t.multiplyVectors(i,l)};var s=new r,l=new r,u=new r,c=new r;i.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,o=this.bj,r=n.force,i=n.torque,a=o.force,h=o.torque,p=n.invMassSolve,d=o.invMassSolve;return n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(i,u):u.set(0,0,0),o.invInertiaWorldSolve?o.invInertiaWorldSolve.vmult(h,c):c.set(0,0,0),r.mult(p,s),a.mult(d,l),e.multiplyVectors(s,u)+t.multiplyVectors(l,c)};var h=new r;i.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,o=this.bj,r=n.invMassSolve,i=o.invMassSolve,a=n.invInertiaWorldSolve,s=o.invInertiaWorldSolve,l=r+i;return a&&(a.vmult(e.rotational,h),l+=h.dot(e.rotational)),s&&(s.vmult(t.rotational,h),l+=h.dot(t.rotational)),l};var p=new r;new r,new r,new r,new r,new r,i.prototype.addToWlambda=function(e){var t=this.jacobianElementA,n=this.jacobianElementB,o=this.bi,r=this.bj,i=p;t.spatial.mult(o.invMassSolve*e,i),o.vlambda.vadd(i,o.vlambda),n.spatial.mult(r.invMassSolve*e,i),r.vlambda.vadd(i,r.vlambda),o.invInertiaWorldSolve&&(o.invInertiaWorldSolve.vmult(t.rotational,i),i.mult(e,i),o.wlambda.vadd(i,o.wlambda)),r.invInertiaWorldSolve&&(r.invInertiaWorldSolve.vmult(n.rotational,i),i.mult(e,i),r.wlambda.vadd(i,r.wlambda))},i.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t,n){t.exports=i;var o=e("./Equation"),r=e("../math/Vec3");function i(e,t,n){o.call(this,e,t,-n,n),this.ri=new r,this.rj=new r,this.t=new r}e("../math/Mat3"),i.prototype=new o,i.prototype.constructor=i;var a=new r,s=new r;i.prototype.computeB=function(e){this.a;var t=this.b,n=(this.bi,this.bj,this.ri),o=this.rj,r=a,i=s,l=this.t;n.cross(l,r),o.cross(l,i);var u=this.jacobianElementA,c=this.jacobianElementB;return l.negate(u.spatial),r.negate(u.rotational),c.spatial.copy(l),c.rotational.copy(i),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t,n){t.exports=i;var o=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function i(e,t,n){var i="undefined"!==typeof(n=n||{}).maxForce?n.maxForce:1e6;r.call(this,e,t,-i,i),this.axisA=n.axisA?n.axisA.clone():new o(1,0,0),this.axisB=n.axisB?n.axisB.clone():new o(0,1,0),this.maxAngle=Math.PI/2}i.prototype=new r,i.prototype.constructor=i;var a=new o,s=new o;i.prototype.computeB=function(e){var t=this.a,n=this.b,o=this.axisA,r=this.axisB,i=a,l=s,u=this.jacobianElementA,c=this.jacobianElementB;return o.cross(r,i),r.cross(o,l),u.rotational.copy(l),c.rotational.copy(i),-(Math.cos(this.maxAngle)-o.dot(r))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t,n){t.exports=i;var o=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function i(e,t,n){n="undefined"!==typeof n?n:1e6,r.call(this,e,t,-n,n),this.axisA=new o,this.axisB=new o,this.targetVelocity=0}i.prototype=new r,i.prototype.constructor=i,i.prototype.computeB=function(e){this.a;var t=this.b,n=(this.bi,this.bj,this.axisA),o=this.axisB,r=this.jacobianElementA,i=this.jacobianElementB;return r.rotational.copy(n),o.negate(i.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t,n){var o=e("../utils/Utils");function r(e,t,n){n=o.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=r.idCounter++,this.materials=[e,t],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}t.exports=r,r.idCounter=0},{"../utils/Utils":53}],25:[function(e,t,n){function o(e){var t="";"string"===typeof(e=e||{})?(t=e,e={}):"object"===typeof e&&(t=""),this.name=t,this.id=o.idCounter++,this.friction="undefined"!==typeof e.friction?e.friction:-1,this.restitution="undefined"!==typeof e.restitution?e.restitution:-1}t.exports=o,o.idCounter=0},{}],26:[function(e,t,n){t.exports=r;var o=e("./Vec3");function r(){this.spatial=new o,this.rotational=new o}r.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t,n){t.exports=r;var o=e("./Vec3");function r(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}r.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},r.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},r.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},r.prototype.getTrace=function(e){e=e||new o;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},r.prototype.vmult=function(e,t){t=t||new o;var n=this.elements,r=e.x,i=e.y,a=e.z;return t.x=n[0]*r+n[1]*i+n[2]*a,t.y=n[3]*r+n[4]*i+n[5]*a,t.z=n[6]*r+n[7]*i+n[8]*a,t},r.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},r.prototype.mmult=function(e,t){for(var n=t||new r,o=0;o<3;o++)for(var i=0;i<3;i++){for(var a=0,s=0;s<3;s++)a+=e.elements[o+3*s]*this.elements[s+3*i];n.elements[o+3*i]=a}return n},r.prototype.scale=function(e,t){t=t||new r;for(var n=this.elements,o=t.elements,i=0;3!==i;i++)o[3*i+0]=e.x*n[3*i+0],o[3*i+1]=e.y*n[3*i+1],o[3*i+2]=e.z*n[3*i+2];return t},r.prototype.solve=function(e,t){t=t||new o;for(var n,r=[],i=0;i<12;i++)r.push(0);for(i=0;i<3;i++)for(n=0;n<3;n++)r[i+4*n]=this.elements[i+3*n];r[3]=e.x,r[7]=e.y,r[11]=e.z;var a,s,l=3,u=l;do{if(0===r[(i=u-l)+4*i])for(n=i+1;n<u;n++)if(0!==r[i+4*n]){a=4;do{r[(s=4-a)+4*i]+=r[s+4*n]}while(--a);break}if(0!==r[i+4*i])for(n=i+1;n<u;n++){var c=r[i+4*n]/r[i+4*i];a=4;do{r[(s=4-a)+4*n]=s<=i?0:r[s+4*n]-r[s+4*i]*c}while(--a)}}while(--l);if(t.z=r[11]/r[10],t.y=(r[7]-r[6]*t.z)/r[5],t.x=(r[3]-r[2]*t.z-r[1]*t.y)/r[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},r.prototype.e=function(e,t,n){if(void 0===n)return this.elements[t+3*e];this.elements[t+3*e]=n},r.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},r.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},r.prototype.reverse=function(e){e=e||new r;for(var t,n=[],o=0;o<18;o++)n.push(0);for(o=0;o<3;o++)for(t=0;t<3;t++)n[o+6*t]=this.elements[o+3*t];n[3]=1,n[9]=0,n[15]=0,n[4]=0,n[10]=1,n[16]=0,n[5]=0,n[11]=0,n[17]=1;var i,a,s=3,l=s;do{if(0===n[(o=l-s)+6*o])for(t=o+1;t<l;t++)if(0!==n[o+6*t]){i=6;do{n[(a=6-i)+6*o]+=n[a+6*t]}while(--i);break}if(0!==n[o+6*o])for(t=o+1;t<l;t++){var u=n[o+6*t]/n[o+6*o];i=6;do{n[(a=6-i)+6*t]=a<=o?0:n[a+6*t]-n[a+6*o]*u}while(--i)}}while(--s);o=2;do{t=o-1;do{u=n[o+6*t]/n[o+6*o],i=6;do{n[(a=6-i)+6*t]=n[a+6*t]-n[a+6*o]*u}while(--i)}while(t--)}while(--o);o=2;do{u=1/n[o+6*o],i=6;do{n[(a=6-i)+6*o]=n[a+6*o]*u}while(--i)}while(o--);o=2;do{t=2;do{if(a=n[3+t+6*o],isNaN(a)||a===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(o,t,a)}while(t--)}while(o--);return e},r.prototype.setRotationFromQuaternion=function(e){var t=e.x,n=e.y,o=e.z,r=e.w,i=t+t,a=n+n,s=o+o,l=t*i,u=t*a,c=t*s,h=n*a,p=n*s,d=o*s,f=r*i,y=r*a,v=r*s,m=this.elements;return m[0]=1-(h+d),m[1]=u-v,m[2]=c+y,m[3]=u+v,m[4]=1-(l+d),m[5]=p-f,m[6]=c-y,m[7]=p+f,m[8]=1-(l+h),this},r.prototype.transpose=function(e){for(var t=(e=e||new r).elements,n=this.elements,o=0;3!==o;o++)for(var i=0;3!==i;i++)t[3*o+i]=n[3*i+o];return e}},{"./Vec3":30}],28:[function(e,t,n){t.exports=r;var o=e("./Vec3");function r(e,t,n,o){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==n?n:0,this.w=void 0!==o?o:1}r.prototype.set=function(e,t,n,o){this.x=e,this.y=t,this.z=n,this.w=o},r.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},r.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},r.prototype.setFromAxisAngle=function(e,t){var n=Math.sin(.5*t);this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*t)},r.prototype.toAxisAngle=function(e){e=e||new o,this.normalize();var t=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return n<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,t]};var i=new o,a=new o;r.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var n=i,o=a;e.tangents(n,o),this.setFromAxisAngle(n,Math.PI)}else{var r=e.cross(t);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}};var s=new o,l=new o,u=new o;r.prototype.mult=function(e,t){t=t||new r;var n=this.w,o=s,i=l,a=u;return o.set(this.x,this.y,this.z),i.set(e.x,e.y,e.z),t.w=n*e.w-o.dot(i),o.cross(i,a),t.x=n*i.x+e.w*o.x+a.x,t.y=n*i.y+e.w*o.y+a.y,t.z=n*i.z+e.w*o.z+a.z,t},r.prototype.inverse=function(e){var t=this.x,n=this.y,o=this.z,i=this.w;e=e||new r,this.conjugate(e);var a=1/(t*t+n*n+o*o+i*i);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},r.prototype.conjugate=function(e){return(e=e||new r).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},r.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},r.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},r.prototype.vmult=function(e,t){t=t||new o;var n=e.x,r=e.y,i=e.z,a=this.x,s=this.y,l=this.z,u=this.w,c=u*n+s*i-l*r,h=u*r+l*n-a*i,p=u*i+a*r-s*n,d=-a*n-s*r-l*i;return t.x=c*u+d*-a+h*-l-p*-s,t.y=h*u+d*-s+p*-a-c*-l,t.z=p*u+d*-l+c*-s-h*-a,t},r.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},r.prototype.toEuler=function(e,t){var n,o,r;t=t||"YZX";var i=this.x,a=this.y,s=this.z,l=this.w;switch(t){case"YZX":var u=i*a+s*l;if(u>.499&&(n=2*Math.atan2(i,l),o=Math.PI/2,r=0),u<-.499&&(n=-2*Math.atan2(i,l),o=-Math.PI/2,r=0),isNaN(n)){var c=i*i,h=a*a,p=s*s;n=Math.atan2(2*a*l-2*i*s,1-2*h-2*p),o=Math.asin(2*u),r=Math.atan2(2*i*l-2*a*s,1-2*c-2*p)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=n,e.z=o,e.x=r},r.prototype.setFromEuler=function(e,t,n,o){o=o||"XYZ";var r=Math.cos(e/2),i=Math.cos(t/2),a=Math.cos(n/2),s=Math.sin(e/2),l=Math.sin(t/2),u=Math.sin(n/2);return"XYZ"===o?(this.x=s*i*a+r*l*u,this.y=r*l*a-s*i*u,this.z=r*i*u+s*l*a,this.w=r*i*a-s*l*u):"YXZ"===o?(this.x=s*i*a+r*l*u,this.y=r*l*a-s*i*u,this.z=r*i*u-s*l*a,this.w=r*i*a+s*l*u):"ZXY"===o?(this.x=s*i*a-r*l*u,this.y=r*l*a+s*i*u,this.z=r*i*u+s*l*a,this.w=r*i*a-s*l*u):"ZYX"===o?(this.x=s*i*a-r*l*u,this.y=r*l*a+s*i*u,this.z=r*i*u-s*l*a,this.w=r*i*a+s*l*u):"YZX"===o?(this.x=s*i*a+r*l*u,this.y=r*l*a+s*i*u,this.z=r*i*u-s*l*a,this.w=r*i*a-s*l*u):"XZY"===o&&(this.x=s*i*a-r*l*u,this.y=r*l*a-s*i*u,this.z=r*i*u+s*l*a,this.w=r*i*a+s*l*u),this},r.prototype.clone=function(){return new r(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t,n){var o=e("./Vec3"),r=e("./Quaternion");function i(e){e=e||{},this.position=new o,e.position&&this.position.copy(e.position),this.quaternion=new r,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=i;var a=new r;i.pointToLocalFrame=function(e,t,n,r){return r=r||new o,n.vsub(e,r),t.conjugate(a),a.vmult(r,r),r},i.prototype.pointToLocal=function(e,t){return i.pointToLocalFrame(this.position,this.quaternion,e,t)},i.pointToWorldFrame=function(e,t,n,r){return r=r||new o,t.vmult(n,r),r.vadd(e,r),r},i.prototype.pointToWorld=function(e,t){return i.pointToWorldFrame(this.position,this.quaternion,e,t)},i.prototype.vectorToWorldFrame=function(e,t){return t=t||new o,this.quaternion.vmult(e,t),t},i.vectorToWorldFrame=function(e,t,n){return e.vmult(t,n),n},i.vectorToLocalFrame=function(e,t,n,r){return r=r||new o,t.w*=-1,t.vmult(n,r),t.w*=-1,r}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t,n){t.exports=r;var o=e("./Mat3");function r(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0}r.ZERO=new r(0,0,0),r.UNIT_X=new r(1,0,0),r.UNIT_Y=new r(0,1,0),r.UNIT_Z=new r(0,0,1),r.prototype.cross=function(e,t){var n=e.x,o=e.y,i=e.z,a=this.x,s=this.y,l=this.z;return(t=t||new r).x=s*i-l*o,t.y=l*n-a*i,t.z=a*o-s*n,t},r.prototype.set=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},r.prototype.setZero=function(){this.x=this.y=this.z=0},r.prototype.vadd=function(e,t){if(!t)return new r(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},r.prototype.vsub=function(e,t){if(!t)return new r(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},r.prototype.crossmat=function(){return new o([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},r.prototype.normalize=function(){var e=this.x,t=this.y,n=this.z,o=Math.sqrt(e*e+t*t+n*n);if(o>0){var r=1/o;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return o},r.prototype.unit=function(e){e=e||new r;var t=this.x,n=this.y,o=this.z,i=Math.sqrt(t*t+n*n+o*o);return i>0?(i=1/i,e.x=t*i,e.y=n*i,e.z=o*i):(e.x=1,e.y=0,e.z=0),e},r.prototype.norm=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)},r.prototype.length=r.prototype.norm,r.prototype.norm2=function(){return this.dot(this)},r.prototype.lengthSquared=r.prototype.norm2,r.prototype.distanceTo=function(e){var t=this.x,n=this.y,o=this.z,r=e.x,i=e.y,a=e.z;return Math.sqrt((r-t)*(r-t)+(i-n)*(i-n)+(a-o)*(a-o))},r.prototype.distanceSquared=function(e){var t=this.x,n=this.y,o=this.z,r=e.x,i=e.y,a=e.z;return(r-t)*(r-t)+(i-n)*(i-n)+(a-o)*(a-o)},r.prototype.mult=function(e,t){t=t||new r;var n=this.x,o=this.y,i=this.z;return t.x=e*n,t.y=e*o,t.z=e*i,t},r.prototype.scale=r.prototype.mult,r.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},r.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},r.prototype.negate=function(e){return(e=e||new r).x=-this.x,e.y=-this.y,e.z=-this.z,e};var i=new r,a=new r;r.prototype.tangents=function(e,t){var n=this.norm();if(n>0){var o=i,r=1/n;o.set(this.x*r,this.y*r,this.z*r);var s=a;Math.abs(o.x)<.9?(s.set(1,0,0),o.cross(s,e)):(s.set(0,1,0),o.cross(s,e)),o.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},r.prototype.toString=function(){return this.x+","+this.y+","+this.z},r.prototype.toArray=function(){return[this.x,this.y,this.z]},r.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},r.prototype.lerp=function(e,t,n){var o=this.x,r=this.y,i=this.z;n.x=o+(e.x-o)*t,n.y=r+(e.y-r)*t,n.z=i+(e.z-i)*t},r.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},r.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var s=new r;r.prototype.isAntiparallelTo=function(e,t){return this.negate(s),s.almostEquals(e,t)},r.prototype.clone=function(){return new r(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t,n){t.exports=u;var o=e("../utils/EventTarget"),r=(e("../shapes/Shape"),e("../math/Vec3")),i=e("../math/Mat3"),a=e("../math/Quaternion"),s=(e("../material/Material"),e("../collision/AABB")),l=e("../shapes/Box");function u(e){e=e||{},o.apply(this),this.id=u.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new r,this.collisionFilterGroup="number"===typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"===typeof e.collisionFilterMask?e.collisionFilterMask:1,this.collisionResponse=!0,this.position=new r,e.position&&this.position.copy(e.position),this.previousPosition=new r,this.initPosition=new r,this.velocity=new r,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new r,this.force=new r;var t="number"===typeof e.mass?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping="number"===typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?u.STATIC:u.DYNAMIC,typeof e.type===typeof u.STATIC&&(this.type=e.type),this.allowSleep="undefined"===typeof e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit="undefined"!==typeof e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit="undefined"!==typeof e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new r,this.quaternion=new a,e.quaternion&&this.quaternion.copy(e.quaternion),this.initQuaternion=new a,this.angularVelocity=new r,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new r,this.interpolatedPosition=new r,this.interpolatedQuaternion=new a,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new r,this.invInertia=new r,this.invInertiaWorld=new i,this.invMassSolve=0,this.invInertiaSolve=new r,this.invInertiaWorldSolve=new i,this.fixedRotation="undefined"!==typeof e.fixedRotation&&e.fixedRotation,this.angularDamping="undefined"!==typeof e.angularDamping?e.angularDamping:.01,this.aabb=new s,this.aabbNeedsUpdate=!0,this.wlambda=new r,e.shape&&this.addShape(e.shape),this.updateMassProperties()}u.prototype=new o,u.prototype.constructor=u,u.DYNAMIC=1,u.STATIC=2,u.KINEMATIC=4,u.AWAKE=0,u.SLEEPY=1,u.SLEEPING=2,u.idCounter=0,u.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===u.SLEEPING&&this.dispatchEvent({type:"wakeup"})},u.prototype.sleep=function(){this.sleepState=u.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},u.sleepyEvent={type:"sleepy"},u.sleepEvent={type:"sleep"},u.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),o=Math.pow(this.sleepSpeedLimit,2);t===u.AWAKE&&n<o?(this.sleepState=u.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(u.sleepyEvent)):t===u.SLEEPY&&n>o?this.wakeUp():t===u.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(u.sleepEvent))}},u.prototype.updateSolveMassProperties=function(){this.sleepState===u.SLEEPING||this.type===u.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},u.prototype.pointToLocalFrame=function(e,t){return t=t||new r,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},u.prototype.vectorToLocalFrame=function(e,t){return t=t||new r,this.quaternion.conjugate().vmult(e,t),t},u.prototype.pointToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},u.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t};var c=new r,h=new a;u.prototype.addShape=function(e,t,n){var o=new r,i=new a;return t&&o.copy(t),n&&i.copy(n),this.shapes.push(e),this.shapeOffsets.push(o),this.shapeOrientations.push(i),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},u.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,n=e.length,o=0,r=0;r!==n;r++){var i=e[r];i.updateBoundingSphereRadius();var a=t[r].norm(),s=i.boundingSphereRadius;a+s>o&&(o=a+s)}this.boundingRadius=o};var p=new s;u.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,n=this.shapeOrientations,o=e.length,r=c,i=h,a=this.quaternion,s=this.aabb,l=p,u=0;u!==o;u++){var d=e[u];n[u].mult(a,i),i.vmult(t[u],r),r.vadd(this.position,r),d.calculateWorldAABB(r,i,l.lowerBound,l.upperBound),0===u?s.copy(l):s.extend(l)}this.aabbNeedsUpdate=!1};var d=new i,f=new i;new i,u.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var n=d,o=f;n.setRotationFromQuaternion(this.quaternion),n.transpose(o),n.scale(t,n),n.mmult(o,this.invInertiaWorld)}};var y=new r,v=new r;u.prototype.applyForce=function(e,t){if(this.type===u.DYNAMIC){var n=y;t.vsub(this.position,n);var o=v;n.cross(e,o),this.force.vadd(e,this.force),this.torque.vadd(o,this.torque)}};var m=new r,b=new r;u.prototype.applyLocalForce=function(e,t){if(this.type===u.DYNAMIC){var n=m,o=b;this.vectorToWorldFrame(e,n),this.pointToWorldFrame(t,o),this.applyForce(n,o)}};var g=new r,_=new r,x=new r;u.prototype.applyImpulse=function(e,t){if(this.type===u.DYNAMIC){var n=g;t.vsub(this.position,n);var o=_;o.copy(e),o.mult(this.invMass,o),this.velocity.vadd(o,this.velocity);var r=x;n.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var A=new r,w=new r;u.prototype.applyLocalImpulse=function(e,t){if(this.type===u.DYNAMIC){var n=A,o=w;this.vectorToWorldFrame(e,n),this.pointToWorldFrame(t,o),this.applyImpulse(n,o)}};var E=new r;u.prototype.updateMassProperties=function(){var e=E;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,n=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!n?1/t.x:0,t.y>0&&!n?1/t.y:0,t.z>0&&!n?1/t.z:0),this.updateInertiaWorld(!0)},u.prototype.getVelocityAtWorldPoint=function(e,t){var n=new r;return e.vsub(this.position,n),this.angularVelocity.cross(n,t),this.velocity.vadd(t,t),t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t,n){e("./Body");var o=e("../math/Vec3"),r=e("../math/Quaternion"),i=(e("../collision/RaycastResult"),e("../collision/Ray")),a=e("../objects/WheelInfo");function s(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"!==typeof e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis="undefined"!==typeof e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis="undefined"!==typeof e.indexUpAxis?e.indexUpAxis:2}t.exports=s,new o,new o,new o;var l=new o,u=new o,c=new o;new i,s.prototype.addWheel=function(e){var t=new a(e=e||{}),n=this.wheelInfos.length;return this.wheelInfos.push(t),n},s.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new o,s.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},s.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},s.prototype.addToWorld=function(e){this.constraints,e.add(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},s.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},s.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,n=t.length,r=this.chassisBody,i=0;i<n;i++)this.updateWheelTransform(i);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var a=new o;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),i=0;i<n;i++)this.castRay(t[i]);this.updateSuspension(e);var s=new o,l=new o;for(i=0;i<n;i++){var u=(d=t[i]).suspensionForce;u>d.maxSuspensionForce&&(u=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(u*e,s),d.raycastResult.hitPointWorld.vsub(r.position,l),r.applyImpulse(s,d.raycastResult.hitPointWorld)}this.updateFriction(e);var c=new o,h=new o,p=new o;for(i=0;i<n;i++){var d=t[i];r.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,p);var f=1;switch(this.indexUpAxis){case 1:f=-1}if(d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);var y=h.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(y,c),h.vsub(c,h);var v=h.dot(p);d.deltaRotation=f*v*e/d.radius}!d.sliding&&d.isInContact||0===d.engineForce||!d.useCustomSlidingRotationalSpeed||(d.deltaRotation=(d.engineForce>0?1:-1)*d.customSlidingRotationalSpeed*e),Math.abs(d.brake)>Math.abs(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=.99}},s.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,n=this.wheelInfos,o=n.length,r=0;r<o;r++){var i=n[r];if(i.isInContact){var a,s=i.suspensionRestLength-i.suspensionLength;a=i.suspensionStiffness*s*i.clippedInvContactDotSuspension;var l=i.suspensionRelativeVelocity;a-=(l<0?i.dampingCompression:i.dampingRelaxation)*l,i.suspensionForce=a*t,i.suspensionForce<0&&(i.suspensionForce=0)}else i.suspensionForce=0}},s.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var h=new o,p=new o;s.prototype.castRay=function(e){var t=h,n=p;this.updateWheelTransformWorld(e);var r=this.chassisBody,i=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var s=e.chassisConnectionPointWorld;s.vadd(t,n);var l=e.raycastResult;l.reset();var u=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(s,n,l),r.collisionResponse=u;var c=l.body;if(e.raycastResult.groundObject=0,c){i=l.distance,e.raycastResult.hitNormalWorld=l.hitNormalWorld,e.isInContact=!0;var d=l.distance;e.suspensionLength=d-e.radius;var f=e.suspensionRestLength-e.maxSuspensionTravel,y=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<f&&(e.suspensionLength=f),e.suspensionLength>y&&(e.suspensionLength=y,e.raycastResult.reset());var v=e.raycastResult.hitNormalWorld.dot(e.directionWorld),m=new o;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,m);var b=e.raycastResult.hitNormalWorld.dot(m);if(v>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var g=-1/v;e.suspensionRelativeVelocity=b*g,e.clippedInvContactDotSuspension=g}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return i},s.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},s.prototype.updateWheelTransform=function(e){var t=l,n=u,o=c,i=this.wheelInfos[e];this.updateWheelTransformWorld(i),i.directionLocal.scale(-1,t),n.copy(i.axleLocal),t.cross(n,o),o.normalize(),n.normalize();var a=i.steering,s=new r;s.setFromAxisAngle(t,a);var h=new r;h.setFromAxisAngle(n,i.rotation);var p=i.worldTransform.quaternion;this.chassisBody.quaternion.mult(s,p),p.mult(h,p),p.normalize();var d=i.worldTransform.position;d.copy(i.directionWorld),d.scale(i.suspensionLength,d),d.vadd(i.chassisConnectionPointWorld,d)};var d=[new o(1,0,0),new o(0,1,0),new o(0,0,1)];s.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var f=new o,y=[],v=[];s.prototype.updateFriction=function(e){for(var t=f,n=this.wheelInfos,r=n.length,i=this.chassisBody,a=v,s=y,l=0;l<r;l++)p=(S=n[l]).raycastResult.body,S.sideImpulse=0,S.forwardImpulse=0,a[l]||(a[l]=new o),s[l]||(s[l]=new o);for(l=0;l<r;l++)if(p=(S=n[l]).raycastResult.body){var u=s[l];this.getWheelTransformWorld(l).vectorToWorldFrame(d[this.indexRightAxis],u);var c=S.raycastResult.hitNormalWorld,h=u.dot(c);c.scale(h,t),u.vsub(t,u),u.normalize(),c.cross(u,a[l]),a[l].normalize(),S.sideImpulse=L(i,S.raycastResult.hitPointWorld,p,S.raycastResult.hitPointWorld,u),S.sideImpulse*=1}for(this.sliding=!1,l=0;l<r;l++){var p=(S=n[l]).raycastResult.body,m=0;if(S.slipInfo=1,p){var b=S.brake?S.brake:0;m=_(i,p,S.raycastResult.hitPointWorld,a[l],b);var g=b/(m+=S.engineForce*e);S.slipInfo*=g}if(S.forwardImpulse=0,S.skidInfo=1,p){S.skidInfo=1;var x=S.suspensionForce*e*S.frictionSlip,A=x*x;S.forwardImpulse=m;var w=.5*S.forwardImpulse,E=1*S.sideImpulse,T=w*w+E*E;S.sliding=!1,T>A&&(this.sliding=!0,S.sliding=!0,g=x/Math.sqrt(T),S.skidInfo*=g)}}if(this.sliding)for(l=0;l<r;l++)0!==(S=n[l]).sideImpulse&&S.skidInfo<1&&(S.forwardImpulse*=S.skidInfo,S.sideImpulse*=S.skidInfo);for(l=0;l<r;l++){var S=n[l],M=new o;if(M.copy(S.raycastResult.hitPointWorld),0!==S.forwardImpulse){var C=new o;a[l].scale(S.forwardImpulse,C),i.applyImpulse(C,M)}if(0!==S.sideImpulse){p=S.raycastResult.body;var R=new o;R.copy(S.raycastResult.hitPointWorld);var O=new o;s[l].scale(S.sideImpulse,O),i.pointToLocalFrame(M,M),M["xyz"[this.indexUpAxis]]*=S.rollInfluence,i.pointToWorldFrame(M,M),i.applyImpulse(O,M),O.scale(-1,O),p.applyImpulse(O,R)}}};var m=new o,b=new o,g=new o;function _(e,t,n,o,r){var i=0,a=n,s=m,l=b,u=g;return e.getVelocityAtWorldPoint(a,s),t.getVelocityAtWorldPoint(a,l),s.vsub(l,u),r<(i=-o.dot(u)*(1/(T(e,n,o)+T(t,n,o))))&&(i=r),i<-r&&(i=-r),i}var x=new o,A=new o,w=new o,E=new o;function T(e,t,n){var o=x,r=A,i=w,a=E;return t.vsub(e.position,o),o.cross(n,r),e.invInertiaWorld.vmult(r,a),a.cross(o,i),e.invMass+n.dot(i)}var S=new o,M=new o,C=new o;function L(e,t,n,o,r,i){if(r.norm2()>1.1)return 0;var a=S,s=M,l=C;return e.getVelocityAtWorldPoint(t,a),n.getVelocityAtWorldPoint(o,s),a.vsub(s,l),-.2*r.dot(l)*(1/(e.invMass+n.invMass))}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t,n){var o=e("./Body"),r=e("../shapes/Sphere"),i=e("../shapes/Box"),a=e("../math/Vec3"),s=e("../constraints/HingeConstraint");function l(e){if(this.wheelBodies=[],this.coordinateSystem="undefined"===typeof e.coordinateSystem?new a(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new i(new a(5,2,.5));this.chassisBody=new o(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}t.exports=l,l.prototype.addWheel=function(e){var t=(e=e||{}).body;t||(t=new o(1,new r(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0),new a;var n="undefined"!==typeof e.position?e.position.clone():new a,i=new a;this.chassisBody.pointToWorldFrame(n,i),t.position.set(i.x,i.y,i.z);var l="undefined"!==typeof e.axis?e.axis.clone():new a(0,1,0);this.wheelAxes.push(l);var u=new s(this.chassisBody,t,{pivotA:n,axisA:l,pivotB:a.ZERO,axisB:l,collideConnected:!1});return this.constraints.push(u),this.wheelBodies.length-1},l.prototype.setSteeringValue=function(e,t){var n=this.wheelAxes[t],o=Math.cos(e),r=Math.sin(e),i=n.x,a=n.y;this.constraints[t].axisA.set(o*i-r*a,r*i+o*a,0)},l.prototype.setMotorSpeed=function(e,t){var n=this.constraints[t];n.enableMotor(),n.motorTargetVelocity=e},l.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var u=new a;l.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},l.prototype.applyWheelForce=function(e,t){var n=this.wheelAxes[t],o=this.wheelBodies[t],r=o.torque;n.scale(e,u),o.vectorToWorldFrame(u,u),r.vadd(u,r)},l.prototype.addToWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),o=0;o<n.length;o++)e.add(n[o]);for(o=0;o<t.length;o++)e.addConstraint(t[o]);e.addEventListener("preStep",this._update.bind(this))},l.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},l.prototype.removeFromWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),o=0;o<n.length;o++)e.remove(n[o]);for(o=0;o<t.length;o++)e.removeConstraint(t[o])};var c=new a;l.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],n=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,c),n.dot(c)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t,n){t.exports=r,e("../shapes/Shape");var o=e("../math/Vec3");function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),r.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var i=new o;r.prototype.getNeighbors=function(e,t){for(var n=this.particles.length,o=e.id,r=this.smoothingRadius*this.smoothingRadius,a=i,s=0;s!==n;s++){var l=this.particles[s];l.position.vsub(e.position,a),o!==l.id&&a.norm2()<r&&t.push(l)}};var a=new o,s=new o,l=new o,u=new o,c=new o,h=new o;r.prototype.update=function(){for(var e=this.particles.length,t=a,n=this.speedOfSound,o=this.eps,r=0;r!==e;r++){var i=this.particles[r];(E=this.neighbors[r]).length=0,this.getNeighbors(i,E),E.push(this.particles[r]);for(var p=E.length,d=0,f=0;f!==p;f++){i.position.vsub(E[f].position,t);var y=t.norm(),v=this.w(y);d+=E[f].mass*v}this.densities[r]=d,this.pressures[r]=n*n*(this.densities[r]-this.density)}var m=s,b=l,g=u,_=c,x=h;for(r=0;r!==e;r++){var A,w,E,T=this.particles[r];for(m.set(0,0,0),b.set(0,0,0),p=(E=this.neighbors[r]).length,f=0;f!==p;f++){var S=E[f];T.position.vsub(S.position,_);var M=_.norm();A=-S.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+o)+this.pressures[f]/(this.densities[f]*this.densities[f]+o)),this.gradw(_,g),g.mult(A,g),m.vadd(g,m),S.velocity.vsub(T.velocity,x),x.mult(1/(1e-4+this.densities[r]*this.densities[f])*this.viscosity*S.mass,x),w=this.nablaw(M),x.mult(w,x),b.vadd(x,b)}b.mult(T.mass,b),m.mult(T.mass,m),T.force.vadd(b,T.force),T.force.vadd(m,T.force)}},r.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},r.prototype.gradw=function(e,t){var n=e.norm(),o=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(o,9))*Math.pow(o*o-n*n,2),t)},r.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t,n){var o=e("../math/Vec3");function r(e,t,n){n=n||{},this.restLength="number"===typeof n.restLength?n.restLength:1,this.stiffness=n.stiffness||100,this.damping=n.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new o,this.localAnchorB=new o,n.localAnchorA&&this.localAnchorA.copy(n.localAnchorA),n.localAnchorB&&this.localAnchorB.copy(n.localAnchorB),n.worldAnchorA&&this.setWorldAnchorA(n.worldAnchorA),n.worldAnchorB&&this.setWorldAnchorB(n.worldAnchorB)}t.exports=r,r.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},r.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},r.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},r.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var i=new o,a=new o,s=new o,l=new o,u=new o,c=new o,h=new o,p=new o,d=new o,f=new o,y=new o;r.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,n=this.restLength,o=this.bodyA,r=this.bodyB,v=i,m=a,b=s,g=l,_=y,x=u,A=c,w=h,E=p,T=d,S=f;this.getWorldAnchorA(x),this.getWorldAnchorB(A),x.vsub(o.position,w),A.vsub(r.position,E),A.vsub(x,v);var M=v.norm();m.copy(v),m.normalize(),r.velocity.vsub(o.velocity,b),r.angularVelocity.cross(E,_),b.vadd(_,b),o.angularVelocity.cross(w,_),b.vsub(_,b),m.mult(-e*(M-n)-t*b.dot(m),g),o.force.vsub(g,o.force),r.force.vadd(g,r.force),w.cross(g,T),E.cross(g,S),o.torque.vsub(T,o.torque),r.torque.vadd(S,r.torque)}},{"../math/Vec3":30}],36:[function(e,t,n){var o=e("../math/Vec3"),r=e("../math/Transform"),i=e("../collision/RaycastResult"),a=e("../utils/Utils");function s(e){e=a.defaults(e,{chassisConnectionPointLocal:new o,chassisConnectionPointWorld:new o,directionLocal:new o,directionWorld:new o,axleLocal:new o,axleWorld:new o,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new i,this.worldTransform=new r,this.isInContact=!1}t.exports=s;var l=new o,u=new o;l=new o,s.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var n=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,u),e.getVelocityAtWorldPoint(u,l);var o=t.hitNormalWorld.dot(l);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/n;this.suspensionRelativeVelocity=o*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t,n){t.exports=a;var o=e("./Shape"),r=e("../math/Vec3"),i=e("./ConvexPolyhedron");function a(e){o.call(this),this.type=o.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}a.prototype=new o,a.prototype.constructor=a,a.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,n=this.halfExtents.z,o=r,a=[new o(-e,-t,-n),new o(e,-t,-n),new o(e,t,-n),new o(-e,t,-n),new o(-e,-t,n),new o(e,-t,n),new o(e,t,n),new o(-e,t,n)],s=(new o(0,0,1),new o(0,1,0),new o(1,0,0),new i(a,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));this.convexPolyhedronRepresentation=s,s.material=this.material},a.prototype.calculateLocalInertia=function(e,t){return t=t||new r,a.calculateInertia(this.halfExtents,e,t),t},a.calculateInertia=function(e,t,n){var o=e;n.x=1/12*t*(2*o.y*2*o.y+2*o.z*2*o.z),n.y=1/12*t*(2*o.x*2*o.x+2*o.z*2*o.z),n.z=1/12*t*(2*o.y*2*o.y+2*o.x*2*o.x)},a.prototype.getSideNormals=function(e,t){var n=e,o=this.halfExtents;if(n[0].set(o.x,0,0),n[1].set(0,o.y,0),n[2].set(0,0,o.z),n[3].set(-o.x,0,0),n[4].set(0,-o.y,0),n[5].set(0,0,-o.z),void 0!==t)for(var r=0;r!==n.length;r++)t.vmult(n[r],n[r]);return n},a.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var s=new r;new r,a.prototype.forEachWorldCorner=function(e,t,n){for(var o=this.halfExtents,r=[[o.x,o.y,o.z],[-o.x,o.y,o.z],[-o.x,-o.y,o.z],[-o.x,-o.y,-o.z],[o.x,-o.y,-o.z],[o.x,o.y,-o.z],[-o.x,o.y,-o.z],[o.x,-o.y,o.z]],i=0;i<r.length;i++)s.set(r[i][0],r[i][1],r[i][2]),t.vmult(s,s),e.vadd(s,s),n(s.x,s.y,s.z)};var l=[new r,new r,new r,new r,new r,new r,new r,new r];a.prototype.calculateWorldAABB=function(e,t,n,o){var r=this.halfExtents;l[0].set(r.x,r.y,r.z),l[1].set(-r.x,r.y,r.z),l[2].set(-r.x,-r.y,r.z),l[3].set(-r.x,-r.y,-r.z),l[4].set(r.x,-r.y,-r.z),l[5].set(r.x,r.y,-r.z),l[6].set(-r.x,r.y,-r.z),l[7].set(r.x,-r.y,r.z);var i=l[0];t.vmult(i,i),e.vadd(i,i),o.copy(i),n.copy(i);for(var a=1;a<8;a++){i=l[a],t.vmult(i,i),e.vadd(i,i);var s=i.x,u=i.y,c=i.z;s>o.x&&(o.x=s),u>o.y&&(o.y=u),c>o.z&&(o.z=c),s<n.x&&(n.x=s),u<n.y&&(n.y=u),c<n.z&&(n.z=c)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t,n){t.exports=a;var o=e("./Shape"),r=e("../math/Vec3"),i=(e("../math/Quaternion"),e("../math/Transform"));function a(e,t,n){o.call(this),this.type=o.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=n?n.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}a.prototype=new o,a.prototype.constructor=a;var s=new r;a.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,n=(t.length,this.uniqueEdges);n.length=0;for(var o=s,r=0;r!==e.length;r++)for(var i=e[r],a=i.length,l=0;l!==a;l++){var u=(l+1)%a;t[i[l]].vsub(t[i[u]],o),o.normalize();for(var c=!1,h=0;h!==n.length;h++)if(n[h].almostEquals(o)||n[h].almostEquals(o)){c=!0;break}c||n.push(o.clone())}},a.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var n=this.faceNormals[e]||new r;this.getFaceNormal(e,n),n.negate(n),this.faceNormals[e]=n;var o=this.vertices[this.faces[e][0]];if(n.dot(o)<0)for(console.error(".faceNormals["+e+"] = Vec3("+n.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}};var l=new r,u=new r;a.computeNormal=function(e,t,n,o){t.vsub(e,u),n.vsub(t,l),l.cross(u,o),o.isZero()||o.normalize()},a.prototype.getFaceNormal=function(e,t){var n=this.faces[e],o=this.vertices[n[0]],r=this.vertices[n[1]],i=this.vertices[n[2]];return a.computeNormal(o,r,i,t)};var c=new r;a.prototype.clipAgainstHull=function(e,t,n,o,i,a,s,l,u){for(var h=c,p=-1,d=-Number.MAX_VALUE,f=0;f<n.faces.length;f++){h.copy(n.faceNormals[f]),i.vmult(h,h);var y=h.dot(a);y>d&&(d=y,p=f)}for(var v=[],m=n.faces[p],b=m.length,g=0;g<b;g++){var _=n.vertices[m[g]],x=new r;x.copy(_),i.vmult(x,x),o.vadd(x,x),v.push(x)}p>=0&&this.clipFaceAgainstHull(a,e,t,v,s,l,u)};var h=new r,p=new r,d=new r,f=new r,y=new r,v=new r;a.prototype.findSeparatingAxis=function(e,t,n,o,r,i,a,s){var l=h,u=p,c=d,m=f,b=y,g=v,_=Number.MAX_VALUE;if(this.uniqueAxes)for(A=0;A!==this.uniqueAxes.length;A++){if(n.vmult(this.uniqueAxes[A],l),!1===(T=this.testSepAxis(l,e,t,n,o,r)))return!1;T<_&&(_=T,i.copy(l))}else for(var x=a?a.length:this.faces.length,A=0;A<x;A++){var w=a?a[A]:A;if(l.copy(this.faceNormals[w]),n.vmult(l,l),!1===(T=this.testSepAxis(l,e,t,n,o,r)))return!1;T<_&&(_=T,i.copy(l))}if(e.uniqueAxes)for(A=0;A!==e.uniqueAxes.length;A++){if(r.vmult(e.uniqueAxes[A],u),!1===(T=this.testSepAxis(u,e,t,n,o,r)))return!1;T<_&&(_=T,i.copy(u))}else for(var E=s?s.length:e.faces.length,A=0;A<E;A++){var T;if(w=s?s[A]:A,u.copy(e.faceNormals[w]),r.vmult(u,u),!1===(T=this.testSepAxis(u,e,t,n,o,r)))return!1;T<_&&(_=T,i.copy(u))}for(var S=0;S!==this.uniqueEdges.length;S++){n.vmult(this.uniqueEdges[S],m);for(var M=0;M!==e.uniqueEdges.length;M++)if(r.vmult(e.uniqueEdges[M],b),m.cross(b,g),!g.almostZero()){g.normalize();var C=this.testSepAxis(g,e,t,n,o,r);if(!1===C)return!1;C<_&&(_=C,i.copy(g))}}return o.vsub(t,c),c.dot(i)>0&&i.negate(i),!0};var m=[],b=[];a.prototype.testSepAxis=function(e,t,n,o,r,i){a.project(this,e,n,o,m),a.project(t,e,r,i,b);var s=m[0],l=m[1],u=b[0],c=b[1];if(s<c||u<l)return!1;var h=s-c,p=u-l;return h<p?h:p};var g=new r,_=new r;a.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(g,_);var n=_.x-g.x,o=_.y-g.y,r=_.z-g.z;t.x=1/12*e*(2*o*2*o+2*r*2*r),t.y=1/12*e*(2*n*2*n+2*r*2*r),t.z=1/12*e*(2*o*2*o+2*n*2*n)},a.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],n=this.faceNormals[e],o=this.vertices[t[0]];return-n.dot(o)};var x=new r,A=new r,w=new r,E=new r,T=new r,S=new r,M=new r,C=new r;a.prototype.clipFaceAgainstHull=function(e,t,n,o,r,i,a){for(var s=x,l=A,u=w,c=E,h=T,p=S,d=M,f=C,y=o,v=[],m=-1,b=Number.MAX_VALUE,g=0;g<this.faces.length;g++){s.copy(this.faceNormals[g]),n.vmult(s,s);var _=s.dot(e);_<b&&(b=_,m=g)}if(!(m<0)){var L=this.faces[m];L.connectedFaces=[];for(var R=0;R<this.faces.length;R++)for(var O=0;O<this.faces[R].length;O++)-1!==L.indexOf(this.faces[R][O])&&R!==m&&-1===L.connectedFaces.indexOf(R)&&L.connectedFaces.push(R);y.length;for(var P=L.length,N=0;N<P;N++){var B=this.vertices[L[N]],I=this.vertices[L[(N+1)%P]];B.vsub(I,l),u.copy(l),n.vmult(u,u),t.vadd(u,u),c.copy(this.faceNormals[m]),n.vmult(c,c),t.vadd(c,c),u.cross(c,h),h.negate(h),p.copy(B),n.vmult(p,p),t.vadd(p,p),p.dot(h);var F=L.connectedFaces[N];d.copy(this.faceNormals[F]);var V=this.getPlaneConstantOfFace(F);f.copy(d),n.vmult(f,f);var D=V-f.dot(t);for(this.clipFaceAgainstPlane(y,v,f,D);y.length;)y.shift();for(;v.length;)y.push(v.shift())}for(d.copy(this.faceNormals[m]),V=this.getPlaneConstantOfFace(m),f.copy(d),n.vmult(f,f),D=V-f.dot(t),R=0;R<y.length;R++){var q=f.dot(y[R])+D;if(q<=r&&(console.log("clamped: depth="+q+" to minDist="+r),q=r),q<=i){var z=y[R];if(q<=0){var W={point:z,normal:f,depth:q};a.push(W)}}}}},a.prototype.clipFaceAgainstPlane=function(e,t,n,o){var i,a,s=e.length;if(s<2)return t;var l=e[e.length-1],u=e[0];i=n.dot(l)+o;for(var c=0;c<s;c++){if(u=e[c],a=n.dot(u)+o,i<0)if(a<0)(h=new r).copy(u),t.push(h);else{var h=new r;l.lerp(u,i/(i-a),h),t.push(h)}else a<0&&(h=new r,l.lerp(u,i/(i-a),h),t.push(h),t.push(u));l=u,i=a}return t},a.prototype.computeWorldVertices=function(e,t){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new r);for(var o=this.vertices,i=this.worldVertices,a=0;a!==n;a++)t.vmult(o[a],i[a]),e.vadd(i[a],i[a]);this.worldVerticesNeedsUpdate=!1},new r,a.prototype.computeLocalAABB=function(e,t){var n=this.vertices.length,o=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<n;r++){var i=o[r];i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y),i.z<e.z?e.z=i.z:i.z>t.z&&(t.z=i.z)}},a.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new r);for(var n=this.faceNormals,o=this.worldFaceNormals,i=0;i!==t;i++)e.vmult(n[i],o[i]);this.worldFaceNormalsNeedsUpdate=!1},a.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=0,o=t.length;n!==o;n++){var r=t[n].norm2();r>e&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var L=new r;a.prototype.calculateWorldAABB=function(e,t,n,o){for(var r,i,a,s,l,u,c=this.vertices.length,h=this.vertices,p=0;p<c;p++){L.copy(h[p]),t.vmult(L,L),e.vadd(L,L);var d=L;d.x<r||void 0===r?r=d.x:(d.x>s||void 0===s)&&(s=d.x),d.y<i||void 0===i?i=d.y:(d.y>l||void 0===l)&&(l=d.y),d.z<a||void 0===a?a=d.z:(d.z>u||void 0===u)&&(u=d.z)}n.set(r,i,a),o.set(s,l,u)},a.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},a.prototype.getAveragePointLocal=function(e){e=e||new r;for(var t=this.vertices.length,n=this.vertices,o=0;o<t;o++)e.vadd(n[o],e);return e.mult(1/t,e),e},a.prototype.transformAllPoints=function(e,t){var n=this.vertices.length,o=this.vertices;if(t){for(var r=0;r<n;r++){var i=o[r];t.vmult(i,i)}for(r=0;r<this.faceNormals.length;r++)i=this.faceNormals[r],t.vmult(i,i)}if(e)for(r=0;r<n;r++)(i=o[r]).vadd(e,i)};var R=new r,O=new r,P=new r;a.prototype.pointIsInside=function(e){var t=this.vertices.length,n=this.vertices,o=this.faces,r=this.faceNormals,i=this.faces.length,a=R;this.getAveragePointLocal(a);for(var s=0;s<i;s++){this.faces[s].length,t=r[s];var l=n[o[s][0]],u=O;e.vsub(l,u);var c=t.dot(u),h=P;a.vsub(l,h);var p=t.dot(h);if(c<0&&p>0||c>0&&p<0)return!1}return-1},new r;var N=new r,B=new r;a.project=function(e,t,n,o,r){var a=e.vertices.length,s=N,l=0,u=0,c=B,h=e.vertices;c.setZero(),i.vectorToLocalFrame(n,o,t,s),i.pointToLocalFrame(n,o,c,c);var p=c.dot(s);u=l=h[0].dot(s);for(var d=1;d<a;d++){var f=h[d].dot(s);f>l&&(l=f),f<u&&(u=f)}if((u-=p)>(l-=p)){var y=u;u=l,l=y}r[0]=l,r[1]=u}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t,n){t.exports=a;var o=e("./Shape"),r=e("../math/Vec3"),i=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function a(e,t,n,a){var s=a,l=[],u=[],c=[],h=[],p=[],d=Math.cos,f=Math.sin;l.push(new r(t*d(0),t*f(0),.5*-n)),h.push(0),l.push(new r(e*d(0),e*f(0),.5*n)),p.push(1);for(var y=0;y<s;y++){var v=2*Math.PI/s*(y+1),m=2*Math.PI/s*(y+.5);y<s-1?(l.push(new r(t*d(v),t*f(v),.5*-n)),h.push(2*y+2),l.push(new r(e*d(v),e*f(v),.5*n)),p.push(2*y+3),c.push([2*y+2,2*y+3,2*y+1,2*y])):c.push([0,1,2*y+1,2*y]),(s%2===1||y<s/2)&&u.push(new r(d(m),f(m),0))}c.push(p),u.push(new r(0,0,1));var b=[];for(y=0;y<h.length;y++)b.push(h[h.length-y-1]);c.push(b),this.type=o.types.CONVEXPOLYHEDRON,i.call(this,l,c,u)}a.prototype=new i},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,t,n){var o=e("./Shape"),r=e("./ConvexPolyhedron"),i=e("../math/Vec3"),a=e("../utils/Utils");function s(e,t){t=a.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,o.call(this),this.pillarConvex=new r,this.pillarOffset=new i,this.type=o.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}t.exports=s,s.prototype=new o,s.prototype.update=function(){this._cachedPillars={}},s.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var o=0;o!==e[n].length;o++){var r=e[n][o];r<t&&(t=r)}this.minValue=t},s.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var o=0;o!==e[n].length;o++){var r=e[n][o];r>t&&(t=r)}this.maxValue=t},s.prototype.setHeightValueAtIndex=function(e,t,n){this.data[e][t]=n,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},s.prototype.getRectMinMax=function(e,t,n,o,r){r=r||[];for(var i=this.data,a=this.minValue,s=e;s<=n;s++)for(var l=t;l<=o;l++){var u=i[s][l];u>a&&(a=u)}r[0]=this.minValue,r[1]=a},s.prototype.getIndexOfPosition=function(e,t,n,o){var r=this.elementSize,i=this.data,a=Math.floor(e/r),s=Math.floor(t/r);return n[0]=a,n[1]=s,o&&(a<0&&(a=0),s<0&&(s=0),a>=i.length-1&&(a=i.length-1),s>=i[0].length-1&&(s=i[0].length-1)),!(a<0||s<0||a>=i.length-1||s>=i[0].length-1)},s.prototype.getHeightAt=function(e,t,n){var o=[];this.getIndexOfPosition(e,t,o,n);var r=[];return this.getRectMinMax(o[0],o[1]+1,o[0],o[1]+1,r),(r[0]+r[1])/2},s.prototype.getCacheConvexTrianglePillarKey=function(e,t,n){return e+"_"+t+"_"+(n?1:0)},s.prototype.getCachedConvexTrianglePillar=function(e,t,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},s.prototype.setCachedConvexTrianglePillar=function(e,t,n,o,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]={convex:o,offset:r}},s.prototype.clearCachedConvexTrianglePillar=function(e,t,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},s.prototype.getConvexTrianglePillar=function(e,t,n){var o=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(e,t,n))return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);o=new r,a=new i,this.pillarConvex=o,this.pillarOffset=a}var s=this.data,l=this.elementSize,u=o.faces;o.vertices.length=6;for(var c=0;c<6;c++)o.vertices[c]||(o.vertices[c]=new i);for(u.length=5,c=0;c<5;c++)u[c]||(u[c]=[]);var h=o.vertices,p=(Math.min(s[e][t],s[e+1][t],s[e][t+1],s[e+1][t+1])-this.minValue)/2+this.minValue;n?(a.set((e+.75)*l,(t+.75)*l,p),h[0].set(.25*l,.25*l,s[e+1][t+1]-p),h[1].set(-.75*l,.25*l,s[e][t+1]-p),h[2].set(.25*l,-.75*l,s[e+1][t]-p),h[3].set(.25*l,.25*l,-p-1),h[4].set(-.75*l,.25*l,-p-1),h[5].set(.25*l,-.75*l,-p-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=2,u[2][1]=5,u[2][2]=3,u[2][3]=0,u[3][0]=3,u[3][1]=4,u[3][2]=1,u[3][3]=0,u[4][0]=1,u[4][1]=4,u[4][2]=5,u[4][3]=2):(a.set((e+.25)*l,(t+.25)*l,p),h[0].set(-.25*l,-.25*l,s[e][t]-p),h[1].set(.75*l,-.25*l,s[e+1][t]-p),h[2].set(-.25*l,.75*l,s[e][t+1]-p),h[3].set(-.25*l,-.25*l,-p-1),h[4].set(.75*l,-.25*l,-p-1),h[5].set(-.25*l,.75*l,-p-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=0,u[2][1]=2,u[2][2]=5,u[2][3]=3,u[3][0]=1,u[3][1]=0,u[3][2]=3,u[3][3]=4,u[4][0]=4,u[4][1]=5,u[4][2]=2,u[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,n,o,a)},s.prototype.calculateLocalInertia=function(e,t){return(t=t||new i).set(0,0,0),t},s.prototype.volume=function(){return Number.MAX_VALUE},s.prototype.calculateWorldAABB=function(e,t,n,o){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},s.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new i(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t,n){t.exports=i;var o=e("./Shape"),r=e("../math/Vec3");function i(){o.call(this),this.type=o.types.PARTICLE}i.prototype=new o,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},i.prototype.volume=function(){return 0},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},i.prototype.calculateWorldAABB=function(e,t,n,o){n.copy(e),o.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t,n){t.exports=i;var o=e("./Shape"),r=e("../math/Vec3");function i(){o.call(this),this.type=o.types.PLANE,this.worldNormal=new r,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}i.prototype=new o,i.prototype.constructor=i,i.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},i.prototype.calculateLocalInertia=function(e,t){return t=t||new r},i.prototype.volume=function(){return Number.MAX_VALUE};var a=new r;i.prototype.calculateWorldAABB=function(e,t,n,o){a.set(0,0,1),t.vmult(a,a);var r=Number.MAX_VALUE;n.set(-r,-r,-r),o.set(r,r,r),1===a.x&&(o.x=e.x),1===a.y&&(o.y=e.y),1===a.z&&(o.z=e.z),-1===a.x&&(n.x=e.x),-1===a.y&&(n.y=e.y),-1===a.z&&(n.z=e.z)},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t,n){t.exports=o;var o=e("./Shape");function o(){this.id=o.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),o.prototype.constructor=o,o.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},o.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},o.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},o.idCounter=0,o.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t,n){t.exports=i;var o=e("./Shape"),r=e("../math/Vec3");function i(e){if(o.call(this),this.radius=void 0!==e?Number(e):1,this.type=o.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}i.prototype=new o,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(e,t){t=t||new r;var n=2*e*this.radius*this.radius/5;return t.x=n,t.y=n,t.z=n,t},i.prototype.volume=function(){return 4*Math.PI*this.radius/3},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},i.prototype.calculateWorldAABB=function(e,t,n,o){for(var r=this.radius,i=["x","y","z"],a=0;a<i.length;a++){var s=i[a];n[s]=e[s]-r,o[s]=e[s]+r}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t,n){t.exports=l;var o=e("./Shape"),r=e("../math/Vec3"),i=(e("../math/Quaternion"),e("../math/Transform")),a=e("../collision/AABB"),s=e("../utils/Octree");function l(e,t){o.call(this),this.type=o.types.TRIMESH,this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new a,this.edges=null,this.scale=new r(1,1,1),this.tree=new s,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}l.prototype=new o,l.prototype.constructor=l;var u=new r;l.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var n=new a,o=new r,i=new r,s=new r,l=[o,i,s],u=0;u<this.indices.length/3;u++){var c=3*u;this._getUnscaledVertex(this.indices[c],o),this._getUnscaledVertex(this.indices[c+1],i),this._getUnscaledVertex(this.indices[c+2],s),n.setFromPoints(l),e.insert(n,u)}e.removeEmptyNodes()};var c=new a;l.prototype.getTrianglesInAABB=function(e,t){c.copy(e);var n=this.scale,o=n.x,r=n.y,i=n.z,a=c.lowerBound,s=c.upperBound;return a.x/=o,a.y/=r,a.z/=i,s.x/=o,s.y/=r,s.z/=i,this.tree.aabbQuery(c,t)},l.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,n=e.x===e.y===e.z;t&&n||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},l.prototype.updateNormals=function(){for(var e=u,t=this.normals,n=0;n<this.indices.length/3;n++){var o=3*n,r=this.indices[o],i=this.indices[o+1],a=this.indices[o+2];this.getVertex(r,y),this.getVertex(i,v),this.getVertex(a,m),l.computeNormal(v,y,m,e),t[o]=e.x,t[o+1]=e.y,t[o+2]=e.z}},l.prototype.updateEdges=function(){for(var e={},t=function(t,n){e[r<i?r+"_"+i:i+"_"+r]=!0},n=0;n<this.indices.length/3;n++){var o=3*n,r=this.indices[o],i=this.indices[o+1];this.indices[o+2],t(),t(),t()}var a=Object.keys(e);for(this.edges=new Int16Array(2*a.length),n=0;n<a.length;n++){var s=a[n].split("_");this.edges[2*n]=parseInt(s[0],10),this.edges[2*n+1]=parseInt(s[1],10)}},l.prototype.getEdgeVertex=function(e,t,n){var o=this.edges[2*e+(t?1:0)];this.getVertex(o,n)};var h=new r,p=new r;l.prototype.getEdgeVector=function(e,t){var n=h,o=p;this.getEdgeVertex(e,0,n),this.getEdgeVertex(e,1,o),o.vsub(n,t)};var d=new r,f=new r;l.computeNormal=function(e,t,n,o){t.vsub(e,f),n.vsub(t,d),d.cross(f,o),o.isZero()||o.normalize()};var y=new r,v=new r,m=new r;l.prototype.getVertex=function(e,t){var n=this.scale;return this._getUnscaledVertex(e,t),t.x*=n.x,t.y*=n.y,t.z*=n.z,t},l.prototype._getUnscaledVertex=function(e,t){var n=3*e,o=this.vertices;return t.set(o[n],o[n+1],o[n+2])},l.prototype.getWorldVertex=function(e,t,n,o){return this.getVertex(e,o),i.pointToWorldFrame(t,n,o,o),o},l.prototype.getTriangleVertices=function(e,t,n,o){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[r+1],n),this.getVertex(this.indices[r+2],o)},l.prototype.getNormal=function(e,t){var n=3*e;return t.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var b=new a;l.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(b);var n=b.upperBound.x-b.lowerBound.x,o=b.upperBound.y-b.lowerBound.y,r=b.upperBound.z-b.lowerBound.z;return t.set(1/12*e*(2*o*2*o+2*r*2*r),1/12*e*(2*n*2*n+2*r*2*r),1/12*e*(2*o*2*o+2*n*2*n))};var g=new r;l.prototype.computeLocalAABB=function(e){var t=e.lowerBound,n=e.upperBound,o=this.vertices.length,r=(this.vertices,g);this.getVertex(0,r),t.copy(r),n.copy(r);for(var i=0;i!==o;i++)this.getVertex(i,r),r.x<t.x?t.x=r.x:r.x>n.x&&(n.x=r.x),r.y<t.y?t.y=r.y:r.y>n.y&&(n.y=r.y),r.z<t.z?t.z=r.z:r.z>n.z&&(n.z=r.z)},l.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},l.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=new r,o=0,i=t.length/3;o!==i;o++){this.getVertex(o,n);var a=n.norm2();a>e&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new r;var _=new i,x=new a;l.prototype.calculateWorldAABB=function(e,t,n,o){var r=_,i=x;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,i),n.copy(i.lowerBound),o.copy(i.upperBound)},l.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},l.createTorus=function(e,t,n,o,r){e=e||1,t=t||.5,n=n||8,o=o||6,r=r||2*Math.PI;for(var i=[],a=[],s=0;s<=n;s++)for(var u=0;u<=o;u++){var c=u/o*r,h=s/n*Math.PI*2,p=(e+t*Math.cos(h))*Math.cos(c),d=(e+t*Math.cos(h))*Math.sin(c),f=t*Math.sin(h);i.push(p,d,f)}for(s=1;s<=n;s++)for(u=1;u<=o;u++){var y=(o+1)*s+u-1,v=(o+1)*(s-1)+u-1,m=(o+1)*(s-1)+u,b=(o+1)*s+u;a.push(y,v,b),a.push(v,m,b)}return new l(i,a)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t,n){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var o=e("./Solver");function r(){o.call(this),this.iterations=10,this.tolerance=1e-7}r.prototype=new o;var i=[],a=[],s=[];r.prototype.solve=function(e,t){var n,o,r,l,u,c=0,h=this.iterations,p=this.tolerance*this.tolerance,d=this.equations,f=d.length,y=t.bodies,v=y.length,m=e;if(0!==f)for(var b=0;b!==v;b++)y[b].updateSolveMassProperties();var g=a,_=s,x=i;for(g.length=f,_.length=f,x.length=f,b=0;b!==f;b++){var A=d[b];x[b]=0,_[b]=A.computeB(m),g[b]=1/A.computeC()}if(0!==f){for(b=0;b!==v;b++){var w=(S=y[b]).vlambda,E=S.wlambda;w.set(0,0,0),E&&E.set(0,0,0)}for(c=0;c!==h;c++){l=0;for(var T=0;T!==f;T++)A=d[T],n=_[T],o=g[T],(u=x[T])+(r=o*(n-A.computeGWlambda()-A.eps*u))<A.minForce?r=A.minForce-u:u+r>A.maxForce&&(r=A.maxForce-u),x[T]+=r,l+=r>0?r:-r,A.addToWlambda(r);if(l*l<p)break}for(b=0;b!==v;b++){var S,M=(S=y[b]).velocity,C=S.angularVelocity;M.vadd(S.vlambda,M),C&&C.vadd(S.wlambda,C)}}return c}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t,n){function o(){this.equations=[]}t.exports=o,o.prototype.solve=function(e,t){return 0},o.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},o.prototype.removeEquation=function(e){var t=this.equations,n=t.indexOf(e);-1!==n&&t.splice(n,1)},o.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t,n){t.exports=i,e("../math/Vec3"),e("../math/Quaternion");var o=e("./Solver"),r=e("../objects/Body");function i(e){for(o.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}i.prototype=new o;var a=[],s=[],l={bodies:[]},u=r.STATIC;function c(e){for(var t=e.length,n=0;n!==t;n++){var o=e[n];if(!o.visited&&!(o.body.type&u))return o}return!1}var h=[];function p(e,t,n,o){for(h.push(e),e.visited=!0,t(e,n,o);h.length;)for(var r,i=h.pop();r=c(i.children);)r.visited=!0,t(r,n,o),h.push(r)}function d(e,t,n){t.push(e.body);for(var o=e.eqs.length,r=0;r!==o;r++){var i=e.eqs[r];-1===n.indexOf(i)&&n.push(i)}}function f(e,t){return t.id-e.id}i.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},i.prototype.solve=function(e,t){for(var n=a,o=this.nodePool,r=t.bodies,i=this.equations,u=i.length,h=r.length,y=this.subsolver;o.length<h;)o.push(this.createNode());n.length=h;for(var v=0;v<h;v++)n[v]=o[v];for(v=0;v!==h;v++){var m=n[v];m.body=r[v],m.children.length=0,m.eqs.length=0,m.visited=!1}for(var b=0;b!==u;b++){var g=i[b],_=(v=r.indexOf(g.bi),r.indexOf(g.bj)),x=n[v],A=n[_];x.children.push(A),x.eqs.push(g),A.children.push(x),A.eqs.push(g)}var w,E=0,T=s;y.tolerance=this.tolerance,y.iterations=this.iterations;for(var S=l;w=c(n);){T.length=0,S.bodies.length=0,p(w,d,S.bodies,T);var M=T.length;for(T=T.sort(f),v=0;v!==M;v++)y.addEquation(T[v]);y.solve(e,S),y.removeAllEquations(),E++}return E}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t,n){var o=function(){};t.exports=o,o.prototype={constructor:o,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[e])return this;var o=n[e].indexOf(t);return-1!==o&&n[e].splice(o,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var n=0,o=t.length;n<o;n++)t[n].call(this,e)}return this}}},{}],50:[function(e,t,n){var o=e("../collision/AABB"),r=e("../math/Vec3");function i(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new o,this.data=[],this.children=[]}function a(e,t){(t=t||{}).root=null,t.aabb=e,i.call(this,t),this.maxDepth="undefined"!==typeof t.maxDepth?t.maxDepth:8}t.exports=a,a.prototype=new i,i.prototype.reset=function(e,t){this.children.length=this.data.length=0},i.prototype.insert=function(e,t,n){var o=this.data;if(n=n||0,!this.aabb.contains(e))return!1;var r=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var i=!1;r.length||(this.subdivide(),i=!0);for(var a=0;8!==a;a++)if(r[a].insert(e,t,n+1))return!0;i&&(r.length=0)}return o.push(t),!0};var s=new r;i.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,n=e.upperBound,a=this.children;a.push(new i({aabb:new o({lowerBound:new r(0,0,0)})}),new i({aabb:new o({lowerBound:new r(1,0,0)})}),new i({aabb:new o({lowerBound:new r(1,1,0)})}),new i({aabb:new o({lowerBound:new r(1,1,1)})}),new i({aabb:new o({lowerBound:new r(0,1,1)})}),new i({aabb:new o({lowerBound:new r(0,0,1)})}),new i({aabb:new o({lowerBound:new r(1,0,1)})}),new i({aabb:new o({lowerBound:new r(0,1,0)})})),n.vsub(t,s),s.scale(.5,s);for(var l=this.root||this,u=0;8!==u;u++){var c=a[u];c.root=l;var h=c.aabb.lowerBound;h.x*=s.x,h.y*=s.y,h.z*=s.z,h.vadd(t,h),h.vadd(s,c.aabb.upperBound)}},i.prototype.aabbQuery=function(e,t){this.data,this.children;for(var n=[this];n.length;){var o=n.pop();o.aabb.overlaps(e)&&Array.prototype.push.apply(t,o.data),Array.prototype.push.apply(n,o.children)}return t};var l=new o;i.prototype.rayQuery=function(e,t,n){return e.getAABB(l),l.toLocalFrame(t,l),this.aabbQuery(l,n),n},i.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),n=t.children.length-1;n>=0;n--)t.children[n].data.length||t.children.splice(n,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t,n){function o(){this.objects=[],this.type=Object}t.exports=o,o.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t])},o.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},o.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t,n){function o(){this.data={keys:[]}}t.exports=o,o.prototype.get=function(e,t){if(e>t){var n=t;t=e,e=n}return this.data[e+"-"+t]},o.prototype.set=function(e,t,n){if(e>t){var o=t;t=e,e=o}var r=e+"-"+t;this.get(e,t)||this.data.keys.push(r),this.data[r]=n},o.prototype.reset=function(){for(var e=this.data,t=e.keys;t.length>0;)delete e[t.pop()]}},{}],53:[function(e,t,n){function o(){}t.exports=o,o.defaults=function(e,t){for(var n in e=e||{},t)n in e||(e[n]=t[n]);return e}},{}],54:[function(e,t,n){t.exports=i;var o=e("../math/Vec3"),r=e("./Pool");function i(){r.call(this),this.type=o}i.prototype=new r,i.prototype.constructObject=function(){return new o}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,t,n){t.exports=p;var o=e("../collision/AABB"),r=e("../shapes/Shape"),i=e("../collision/Ray"),a=e("../math/Vec3"),s=e("../math/Transform"),l=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),u=(e("../solver/Solver"),e("../utils/Vec3Pool")),c=e("../equations/ContactEquation"),h=e("../equations/FrictionEquation");function p(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new u,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}p.prototype.createContactEquation=function(e,t,n,o,r,i){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new c(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&n.collisionResponse&&o.collisionResponse;var s=this.currentContactMaterial;a.restitution=s.restitution,a.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=n.material||e.material,u=o.material||t.material;return l&&u&&l.restitution>=0&&u.restitution>=0&&(a.restitution=l.restitution*u.restitution),a.si=r||n,a.sj=i||o,a},p.prototype.createFrictionEquationsFromContact=function(e,t){var n=e.bi,o=e.bj,r=e.si,i=e.sj,a=this.world,s=this.currentContactMaterial,l=s.friction,u=r.material||n.material,c=i.material||o.material;if(u&&c&&u.friction>=0&&c.friction>=0&&(l=u.friction*c.friction),l>0){var p=l*a.gravity.length(),d=n.invMass+o.invMass;d>0&&(d=1/d);var f=this.frictionEquationPool,y=f.length?f.pop():new h(n,o,p*d),v=f.length?f.pop():new h(n,o,p*d);return y.bi=v.bi=n,y.bj=v.bj=o,y.minForce=v.minForce=-p*d,y.maxForce=v.maxForce=p*d,y.ri.copy(e.ri),y.rj.copy(e.rj),v.ri.copy(e.ri),v.rj.copy(e.rj),e.ni.tangents(y.t,v.t),y.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),v.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),y.enabled=v.enabled=e.enabled,t.push(y,v),!0}return!1};var d=new a,f=new a,y=new a;p.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var n=this.frictionResult[this.frictionResult.length-2],o=this.frictionResult[this.frictionResult.length-1];d.setZero(),f.setZero(),y.setZero();for(var r=t.bi,i=(t.bj,0);i!==e;i++)(t=this.result[this.result.length-1-i]).bodyA!==r?(d.vadd(t.ni,d),f.vadd(t.ri,f),y.vadd(t.rj,y)):(d.vsub(t.ni,d),f.vadd(t.rj,f),y.vadd(t.ri,y));var a=1/e;f.scale(a,n.ri),y.scale(a,n.rj),o.ri.copy(n.ri),o.rj.copy(n.rj),d.normalize(),d.tangents(n.t,o.t)}};var v=new a,m=new a,b=new l,g=new l;p.prototype.getContacts=function(e,t,n,o,r,i,a){this.contactPointPool=r,this.frictionEquationPool=a,this.result=o,this.frictionResult=i;for(var s=b,l=g,u=v,c=m,h=0,p=e.length;h!==p;h++){var d=e[h],f=t[h],y=null;d.material&&f.material&&(y=n.getContactMaterial(d.material,f.material)||null);for(var _=0;_<d.shapes.length;_++){d.quaternion.mult(d.shapeOrientations[_],s),d.quaternion.vmult(d.shapeOffsets[_],u),u.vadd(d.position,u);for(var x=d.shapes[_],A=0;A<f.shapes.length;A++){f.quaternion.mult(f.shapeOrientations[A],l),f.quaternion.vmult(f.shapeOffsets[A],c),c.vadd(f.position,c);var w=f.shapes[A];if(!(u.distanceTo(c)>x.boundingSphereRadius+w.boundingSphereRadius)){var E=null;x.material&&w.material&&(E=n.getContactMaterial(x.material,w.material)||null),this.currentContactMaterial=E||y||n.defaultContactMaterial;var T=this[x.type|w.type];T&&(x.type<w.type?T.call(this,x,w,u,c,s,l,d,f,x,w):T.call(this,w,x,c,u,l,s,f,d,x,w))}}}}},p.prototype[r.types.BOX|r.types.BOX]=p.prototype.boxBox=function(e,t,n,o,r,i,a,s){e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,n,o,r,i,a,s,e,t)},p.prototype[r.types.BOX|r.types.CONVEXPOLYHEDRON]=p.prototype.boxConvex=function(e,t,n,o,r,i,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,n,o,r,i,a,s,e,t)},p.prototype[r.types.BOX|r.types.PARTICLE]=p.prototype.boxParticle=function(e,t,n,o,r,i,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,n,o,r,i,a,s,e,t)},p.prototype[r.types.SPHERE]=p.prototype.sphereSphere=function(e,t,n,o,r,i,a,s){var l=this.createContactEquation(a,s,e,t);o.vsub(n,l.ni),l.ni.normalize(),l.ri.copy(l.ni),l.rj.copy(l.ni),l.ri.mult(e.radius,l.ri),l.rj.mult(-t.radius,l.rj),l.ri.vadd(n,l.ri),l.ri.vsub(a.position,l.ri),l.rj.vadd(o,l.rj),l.rj.vsub(s.position,l.rj),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)};var _=new a,x=new a,A=new a;p.prototype[r.types.PLANE|r.types.TRIMESH]=p.prototype.planeTrimesh=function(e,t,n,o,r,i,l,u){var c=new a,h=_;h.set(0,0,1),r.vmult(h,h);for(var p=0;p<t.vertices.length/3;p++){t.getVertex(p,c);var d=new a;d.copy(c),s.pointToWorldFrame(o,i,d,c);var f=x;if(c.vsub(n,f),h.dot(f)<=0){var y=this.createContactEquation(l,u,e,t);y.ni.copy(h);var v=A;h.scale(f.dot(h),v),c.vsub(v,v),y.ri.copy(v),y.ri.vsub(l.position,y.ri),y.rj.copy(c),y.rj.vsub(u.position,y.rj),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult)}}};var w=new a,E=new a,T=(new a,new a),S=new a,M=new a,C=new a,L=new a,R=new a,O=new a,P=new a,N=new a,B=new a,I=new a,F=new o,V=[];p.prototype[r.types.SPHERE|r.types.TRIMESH]=p.prototype.sphereTrimesh=function(e,t,n,o,r,a,l,u){var c=M,h=C,p=L,d=R,f=O,y=P,v=F,m=S,b=E,g=V;s.pointToLocalFrame(o,a,n,f);var _=e.radius;v.lowerBound.set(f.x-_,f.y-_,f.z-_),v.upperBound.set(f.x+_,f.y+_,f.z+_),t.getTrianglesInAABB(v,g);for(var x=T,A=e.radius*e.radius,D=0;D<g.length;D++)for(var q=0;q<3;q++)t.getVertex(t.indices[3*g[D]+q],x),x.vsub(f,b),b.norm2()<=A&&(m.copy(x),s.pointToWorldFrame(o,a,m,x),x.vsub(n,b),(k=this.createContactEquation(l,u,e,t)).ni.copy(b),k.ni.normalize(),k.ri.copy(k.ni),k.ri.scale(e.radius,k.ri),k.ri.vadd(n,k.ri),k.ri.vsub(l.position,k.ri),k.rj.copy(x),k.rj.vsub(u.position,k.rj),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult));for(D=0;D<g.length;D++)for(q=0;q<3;q++){t.getVertex(t.indices[3*g[D]+q],c),t.getVertex(t.indices[3*g[D]+(q+1)%3],h),h.vsub(c,p),f.vsub(h,y);var z=y.dot(p);f.vsub(c,y);var W=y.dot(p);if(W>0&&z<0&&(f.vsub(c,y),d.copy(p),d.normalize(),W=y.dot(d),d.scale(W,y),y.vadd(c,y),(X=y.distanceTo(f))<e.radius)){var k=this.createContactEquation(l,u,e,t);y.vsub(f,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),s.pointToWorldFrame(o,a,y,y),y.vsub(u.position,k.rj),s.vectorToWorldFrame(a,k.ni,k.ni),s.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}for(var j=N,U=B,G=I,H=w,K=(D=0,g.length);D!==K;D++){t.getTriangleVertices(g[D],j,U,G),t.getNormal(g[D],H),f.vsub(j,y);var X=y.dot(H);H.scale(X,y),f.vsub(y,y),X=y.distanceTo(f),i.pointInTriangle(y,j,U,G)&&X<e.radius&&(k=this.createContactEquation(l,u,e,t),y.vsub(f,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),s.pointToWorldFrame(o,a,y,y),y.vsub(u.position,k.rj),s.vectorToWorldFrame(a,k.ni,k.ni),s.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult))}g.length=0};var D=new a,q=new a;p.prototype[r.types.SPHERE|r.types.PLANE]=p.prototype.spherePlane=function(e,t,n,o,r,i,a,s){var l=this.createContactEquation(a,s,e,t);if(l.ni.set(0,0,1),i.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(e.radius,l.ri),n.vsub(o,D),l.ni.mult(l.ni.dot(D),q),D.vsub(q,l.rj),-D.dot(l.ni)<=e.radius){var u=l.ri,c=l.rj;u.vadd(n,u),u.vsub(a.position,u),c.vadd(o,c),c.vsub(s.position,c),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var z=new a,W=new a,k=new a;function j(e,t,n){for(var o=null,r=e.length,i=0;i!==r;i++){var a=e[i],s=z;e[(i+1)%r].vsub(a,s);var l=W;s.cross(t,l);var u=k;n.vsub(a,u);var c=l.dot(u);if(!(null===o||c>0&&!0===o||c<=0&&!1===o))return!1;null===o&&(o=c>0)}return!0}var U=new a,G=new a,H=new a,K=new a,X=[new a,new a,new a,new a,new a,new a],Y=new a,Q=new a,Z=new a,J=new a;p.prototype[r.types.SPHERE|r.types.BOX]=p.prototype.sphereBox=function(e,t,n,o,r,i,a,s){var l=this.v3pool,u=X;n.vsub(o,U),t.getSideNormals(u,i);for(var c=e.radius,h=!1,p=Q,d=Z,f=J,y=null,v=0,m=0,b=0,g=null,_=0,x=u.length;_!==x&&!1===h;_++){var A=G;A.copy(u[_]);var w=A.norm();A.normalize();var E=U.dot(A);if(E<w+c&&E>0){var T=H,S=K;T.copy(u[(_+1)%3]),S.copy(u[(_+2)%3]);var M=T.norm(),C=S.norm();T.normalize(),S.normalize();var L=U.dot(T),R=U.dot(S);if(L<M&&L>-M&&R<C&&R>-C){var O=Math.abs(E-w-c);(null===g||O<g)&&(g=O,m=L,b=R,y=w,p.copy(A),d.copy(T),f.copy(S),v++)}}}if(v){h=!0;var P=this.createContactEquation(a,s,e,t);p.mult(-c,P.ri),P.ni.copy(p),P.ni.negate(P.ni),p.mult(y,p),d.mult(m,d),p.vadd(d,p),f.mult(b,f),p.vadd(f,P.rj),P.ri.vadd(n,P.ri),P.ri.vsub(a.position,P.ri),P.rj.vadd(o,P.rj),P.rj.vsub(s.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}for(var N=l.get(),B=Y,I=0;2!==I&&!h;I++)for(var F=0;2!==F&&!h;F++)for(var V=0;2!==V&&!h;V++)N.set(0,0,0),I?N.vadd(u[0],N):N.vsub(u[0],N),F?N.vadd(u[1],N):N.vsub(u[1],N),V?N.vadd(u[2],N):N.vsub(u[2],N),o.vadd(N,B),B.vsub(n,B),B.norm2()<c*c&&(h=!0,(P=this.createContactEquation(a,s,e,t)).ri.copy(B),P.ri.normalize(),P.ni.copy(P.ri),P.ri.mult(c,P.ri),P.rj.copy(N),P.ri.vadd(n,P.ri),P.ri.vsub(a.position,P.ri),P.rj.vadd(o,P.rj),P.rj.vsub(s.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult));l.release(N),N=null;var D=l.get(),q=l.get(),z=(P=l.get(),l.get()),W=(O=l.get(),u.length);for(I=0;I!==W&&!h;I++)for(F=0;F!==W&&!h;F++)if(I%3!==F%3){u[F].cross(u[I],D),D.normalize(),u[I].vadd(u[F],q),P.copy(n),P.vsub(q,P),P.vsub(o,P);var k=P.dot(D);for(D.mult(k,z),V=0;V===I%3||V===F%3;)V++;O.copy(n),O.vsub(z,O),O.vsub(q,O),O.vsub(o,O);var j=Math.abs(k),$=O.norm();if(j<u[V].norm()&&$<c){h=!0;var ee=this.createContactEquation(a,s,e,t);q.vadd(z,ee.rj),ee.rj.copy(ee.rj),O.negate(ee.ni),ee.ni.normalize(),ee.ri.copy(ee.rj),ee.ri.vadd(o,ee.ri),ee.ri.vsub(n,ee.ri),ee.ri.normalize(),ee.ri.mult(c,ee.ri),ee.ri.vadd(n,ee.ri),ee.ri.vsub(a.position,ee.ri),ee.rj.vadd(o,ee.rj),ee.rj.vsub(s.position,ee.rj),this.result.push(ee),this.createFrictionEquationsFromContact(ee,this.frictionResult)}}l.release(D,q,P,z,O)};var $=new a,ee=new a,te=new a,ne=new a,oe=new a,re=new a,ie=new a,ae=new a,se=new a,le=new a;p.prototype[r.types.SPHERE|r.types.CONVEXPOLYHEDRON]=p.prototype.sphereConvex=function(e,t,n,o,r,i,a,s){var l=this.v3pool;n.vsub(o,$);for(var u=t.faceNormals,c=t.faces,h=t.vertices,p=e.radius,d=0;d!==h.length;d++){var f=h[d],y=oe;i.vmult(f,y),o.vadd(y,y);var v=ne;if(y.vsub(n,v),v.norm2()<p*p)return m=!0,(O=this.createContactEquation(a,s,e,t)).ri.copy(v),O.ri.normalize(),O.ni.copy(O.ri),O.ri.mult(p,O.ri),y.vsub(o,O.rj),O.ri.vadd(n,O.ri),O.ri.vsub(a.position,O.ri),O.rj.vadd(o,O.rj),O.rj.vsub(s.position,O.rj),this.result.push(O),void this.createFrictionEquationsFromContact(O,this.frictionResult)}for(var m=!1,b=(d=0,c.length);d!==b&&!1===m;d++){var g=u[d],_=c[d],x=re;i.vmult(g,x);var A=ie;i.vmult(h[_[0]],A),A.vadd(o,A);var w=ae;x.mult(-p,w),n.vadd(w,w);var E=se;w.vsub(A,E);var T=E.dot(x),S=le;if(n.vsub(A,S),T<0&&S.dot(x)>0){for(var M=[],C=0,L=_.length;C!==L;C++){var R=l.get();i.vmult(h[_[C]],R),o.vadd(R,R),M.push(R)}if(j(M,x,n)){m=!0;var O=this.createContactEquation(a,s,e,t);x.mult(-p,O.ri),x.negate(O.ni);var P=l.get();x.mult(-T,P);var N=l.get();x.mult(-p,N),n.vsub(o,O.rj),O.rj.vadd(N,O.rj),O.rj.vadd(P,O.rj),O.rj.vadd(o,O.rj),O.rj.vsub(s.position,O.rj),O.ri.vadd(n,O.ri),O.ri.vsub(a.position,O.ri),l.release(P),l.release(N),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult),C=0;for(var B=M.length;C!==B;C++)l.release(M[C]);return}for(C=0;C!==_.length;C++){var I=l.get(),F=l.get();i.vmult(h[_[(C+1)%_.length]],I),i.vmult(h[_[(C+2)%_.length]],F),o.vadd(I,I),o.vadd(F,F);var V=ee;F.vsub(I,V);var D=te;V.unit(D);var q=l.get(),z=l.get();n.vsub(I,z);var W=z.dot(D);D.mult(W,q),q.vadd(I,q);var k=l.get();if(q.vsub(n,k),W>0&&W*W<V.norm2()&&k.norm2()<p*p){for(O=this.createContactEquation(a,s,e,t),q.vsub(o,O.rj),q.vsub(n,O.ni),O.ni.normalize(),O.ni.mult(p,O.ri),O.rj.vadd(o,O.rj),O.rj.vsub(s.position,O.rj),O.ri.vadd(n,O.ri),O.ri.vsub(a.position,O.ri),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult),C=0,B=M.length;C!==B;C++)l.release(M[C]);return l.release(I),l.release(F),l.release(q),l.release(k),void l.release(z)}l.release(I),l.release(F),l.release(q),l.release(k),l.release(z)}for(C=0,B=M.length;C!==B;C++)l.release(M[C])}}},new a,new a,p.prototype[r.types.PLANE|r.types.BOX]=p.prototype.planeBox=function(e,t,n,o,r,i,a,s){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.planeConvex(e,t.convexPolyhedronRepresentation,n,o,r,i,a,s)};var ue=new a,ce=new a,he=new a,pe=new a;p.prototype[r.types.PLANE|r.types.CONVEXPOLYHEDRON]=p.prototype.planeConvex=function(e,t,n,o,r,i,a,s){var l=ue,u=ce;u.set(0,0,1),r.vmult(u,u);for(var c=0,h=he,p=0;p!==t.vertices.length;p++)if(l.copy(t.vertices[p]),i.vmult(l,l),o.vadd(l,l),l.vsub(n,h),u.dot(h)<=0){var d=this.createContactEquation(a,s,e,t),f=pe;u.mult(u.dot(h),f),l.vsub(f,f),f.vsub(n,d.ri),d.ni.copy(u),l.vsub(o,d.rj),d.ri.vadd(n,d.ri),d.ri.vsub(a.position,d.ri),d.rj.vadd(o,d.rj),d.rj.vsub(s.position,d.rj),this.result.push(d),c++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(d,this.frictionResult)}this.enableFrictionReduction&&c&&this.createFrictionFromAverage(c)};var de=new a,fe=new a;p.prototype[r.types.CONVEXPOLYHEDRON]=p.prototype.convexConvex=function(e,t,n,o,r,i,a,s,l,u,c,h){var p=de;if(!(n.distanceTo(o)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,n,r,o,i,p,c,h)){var d=[],f=fe;e.clipAgainstHull(n,r,t,o,i,p,-100,100,d);for(var y=0,v=0;v!==d.length;v++){var m=this.createContactEquation(a,s,e,t,l,u),b=m.ri,g=m.rj;p.negate(m.ni),d[v].normal.negate(f),f.mult(d[v].depth,f),d[v].point.vadd(f,b),g.copy(d[v].point),b.vsub(n,b),g.vsub(o,g),b.vadd(n,b),b.vsub(a.position,b),g.vadd(o,g),g.vsub(s.position,g),this.result.push(m),y++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&y&&this.createFrictionFromAverage(y)}};var ye=new a,ve=new a,me=new a;p.prototype[r.types.PLANE|r.types.PARTICLE]=p.prototype.planeParticle=function(e,t,n,o,r,i,a,s){var l=ye;l.set(0,0,1),a.quaternion.vmult(l,l);var u=ve;if(o.vsub(a.position,u),l.dot(u)<=0){var c=this.createContactEquation(s,a,t,e);c.ni.copy(l),c.ni.negate(c.ni),c.ri.set(0,0,0);var h=me;l.mult(l.dot(o),h),o.vsub(h,h),c.rj.copy(h),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var be=new a;p.prototype[r.types.PARTICLE|r.types.SPHERE]=p.prototype.sphereParticle=function(e,t,n,o,r,i,a,s){var l=be;if(l.set(0,0,1),o.vsub(n,l),l.norm2()<=e.radius*e.radius){var u=this.createContactEquation(s,a,t,e);l.normalize(),u.rj.copy(l),u.rj.mult(e.radius,u.rj),u.ni.copy(l),u.ni.negate(u.ni),u.ri.set(0,0,0),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}};var ge=new l,_e=new a,xe=(new a,new a),Ae=new a,we=new a;p.prototype[r.types.PARTICLE|r.types.CONVEXPOLYHEDRON]=p.prototype.convexParticle=function(e,t,n,o,r,i,a,s){var l=-1,u=xe,c=we,h=null,p=_e;if(p.copy(o),p.vsub(n,p),r.conjugate(ge),ge.vmult(p,p),e.pointIsInside(p)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(n,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var d=0,f=e.faces.length;d!==f;d++){var y=[e.worldVertices[e.faces[d][0]]],v=e.worldFaceNormals[d];o.vsub(y[0],Ae);var m=-v.dot(Ae);(null===h||Math.abs(m)<Math.abs(h))&&(h=m,l=d,u.copy(v))}if(-1!==l){var b=this.createContactEquation(s,a,t,e);u.mult(h,c),c.vadd(o,c),c.vsub(n,c),b.rj.copy(c),u.negate(b.ni),b.ri.set(0,0,0);var g=b.ri,_=b.rj;g.vadd(o,g),g.vsub(s.position,g),_.vadd(n,_),_.vsub(a.position,_),this.result.push(b),this.createFrictionEquationsFromContact(b,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},p.prototype[r.types.BOX|r.types.HEIGHTFIELD]=p.prototype.boxHeightfield=function(e,t,n,o,r,i,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,n,o,r,i,a,s)};var Ee=new a,Te=new a,Se=[0];p.prototype[r.types.CONVEXPOLYHEDRON|r.types.HEIGHTFIELD]=p.prototype.convexHeightfield=function(e,t,n,o,r,i,a,l){var u=t.data,c=t.elementSize,h=e.boundingSphereRadius,p=Te,d=Se,f=Ee;s.pointToLocalFrame(o,i,n,f);var y=Math.floor((f.x-h)/c)-1,v=Math.ceil((f.x+h)/c)+1,m=Math.floor((f.y-h)/c)-1,b=Math.ceil((f.y+h)/c)+1;if(!(v<0||b<0||y>u.length||m>u[0].length)){y<0&&(y=0),v<0&&(v=0),m<0&&(m=0),b<0&&(b=0),y>=u.length&&(y=u.length-1),v>=u.length&&(v=u.length-1),b>=u[0].length&&(b=u[0].length-1),m>=u[0].length&&(m=u[0].length-1);var g=[];t.getRectMinMax(y,m,v,b,g);var _=g[0],x=g[1];if(!(f.z-h>x||f.z+h<_))for(var A=y;A<v;A++)for(var w=m;w<b;w++)t.getConvexTrianglePillar(A,w,!1),s.pointToWorldFrame(o,i,t.pillarOffset,p),n.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,n,p,r,i,a,l,null,null,d,null),t.getConvexTrianglePillar(A,w,!0),s.pointToWorldFrame(o,i,t.pillarOffset,p),n.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,n,p,r,i,a,l,null,null,d,null)}};var Me=new a,Ce=new a;p.prototype[r.types.SPHERE|r.types.HEIGHTFIELD]=p.prototype.sphereHeightfield=function(e,t,n,o,r,i,a,l){var u=t.data,c=e.radius,h=t.elementSize,p=Ce,d=Me;s.pointToLocalFrame(o,i,n,d);var f=Math.floor((d.x-c)/h)-1,y=Math.ceil((d.x+c)/h)+1,v=Math.floor((d.y-c)/h)-1,m=Math.ceil((d.y+c)/h)+1;if(!(y<0||m<0||f>u.length||m>u[0].length)){f<0&&(f=0),y<0&&(y=0),v<0&&(v=0),m<0&&(m=0),f>=u.length&&(f=u.length-1),y>=u.length&&(y=u.length-1),m>=u[0].length&&(m=u[0].length-1),v>=u[0].length&&(v=u[0].length-1);var b=[];t.getRectMinMax(f,v,y,m,b);var g=b[0],_=b[1];if(!(d.z-c>_||d.z+c<g))for(var x=this.result,A=f;A<y;A++)for(var w=v;w<m;w++){var E=x.length;if(t.getConvexTrianglePillar(A,w,!1),s.pointToWorldFrame(o,i,t.pillarOffset,p),n.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,n,p,r,i,a,l),t.getConvexTrianglePillar(A,w,!0),s.pointToWorldFrame(o,i,t.pillarOffset,p),n.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,n,p,r,i,a,l),x.length-E>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,t,n){t.exports=b;var o=e("../shapes/Shape"),r=e("../math/Vec3"),i=e("../math/Quaternion"),a=e("../solver/GSSolver"),s=(e("../utils/Vec3Pool"),e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),l=e("../utils/EventTarget"),u=e("../collision/ArrayCollisionMatrix"),c=e("../material/Material"),h=e("../material/ContactMaterial"),p=e("../objects/Body"),d=e("../utils/TupleDictionary"),f=e("../collision/RaycastResult"),y=e("../collision/AABB"),v=e("../collision/Ray"),m=e("../collision/NaiveBroadphase");function b(){l.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new r,this.broadphase=new m,this.bodies=[],this.solver=new a,this.constraints=[],this.narrowphase=new s(this),this.collisionMatrix=new u,this.collisionMatrixPrevious=new u,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new d,this.defaultMaterial=new c("default"),this.defaultContactMaterial=new h(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}b.prototype=new l,new y;var g=new v;if(b.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},b.prototype.numObjects=function(){return this.bodies.length},b.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},b.prototype.add=b.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof p&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent))},b.prototype.addConstraint=function(e){this.constraints.push(e)},b.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},b.prototype.rayTest=function(e,t,n){n instanceof f?this.raycastClosest(e,t,{skipBackfaces:!0},n):this.raycastAll(e,t,{skipBackfaces:!0},n)},b.prototype.raycastAll=function(e,t,n,o){return n.mode=v.ALL,n.from=e,n.to=t,n.callback=o,g.intersectWorld(this,n)},b.prototype.raycastAny=function(e,t,n,o){return n.mode=v.ANY,n.from=e,n.to=t,n.result=o,g.intersectWorld(this,n)},b.prototype.raycastClosest=function(e,t,n,o){return n.mode=v.CLOSEST,n.from=e,n.to=t,n.result=o,g.intersectWorld(this,n)},b.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,n=this.bodies,o=n.indexOf(e);if(-1!==o){n.splice(o,1);for(var r=0;r!==n.length;r++)n[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},b.prototype.removeBody=b.prototype.remove,b.prototype.addMaterial=function(e){this.materials.push(e)},b.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"===typeof performance&&(performance={}),!performance.now){var _=Date.now();performance.timing&&performance.timing.navigationStart&&(_=performance.timing.navigationStart),performance.now=function(){return Date.now()-_}}var x=new r;b.prototype.step=function(e,t,n){if(n=n||10,0===(t=t||0))this.internalStep(e),this.time+=e;else{var o=Math.floor((this.time+t)/e)-Math.floor(this.time/e);o=Math.min(o,n);for(var r=performance.now(),i=0;i!==o&&(this.internalStep(e),!(performance.now()-r>1e3*e));i++);this.time+=t;for(var a=this.time%e/e,s=x,l=this.bodies,u=0;u!==l.length;u++){var c=l[u];c.type!==p.STATIC&&c.sleepState!==p.SLEEPING?(c.position.vsub(c.previousPosition,s),s.scale(a,s),c.position.vadd(s,c.interpolatedPosition)):(c.interpolatedPosition.copy(c.position),c.interpolatedQuaternion.copy(c.quaternion))}}};var A={type:"postStep"},w={type:"preStep"},E={type:"collide",body:null,contact:null},T=[],S=[],M=[],C=[],L=(new r,new r,new r,new r,new r,new r,new r,new r,new r,new i,new i),R=new i,O=new r;b.prototype.internalStep=function(e){this.dt=e;var t,n=this.contacts,r=M,i=C,a=this.numObjects(),s=this.bodies,l=this.solver,u=this.gravity,c=this.doProfiling,h=this.profile,d=p.DYNAMIC,f=this.constraints,y=S,v=(u.norm(),u.x),m=u.y,b=u.z,g=0;for(c&&(t=performance.now()),g=0;g!==a;g++)if((z=s[g]).type&d){var _=z.force,x=z.mass;_.x+=x*v,_.y+=x*m,_.z+=x*b}g=0;for(var P=this.subsystems.length;g!==P;g++)this.subsystems[g].update();c&&(t=performance.now()),r.length=0,i.length=0,this.broadphase.collisionPairs(this,r,i),c&&(h.broadphase=performance.now()-t);var N=f.length;for(g=0;g!==N;g++)if(!(k=f[g]).collideConnected)for(var B=r.length-1;B>=0;B-=1)(k.bodyA===r[B]&&k.bodyB===i[B]||k.bodyB===r[B]&&k.bodyA===i[B])&&(r.splice(B,1),i.splice(B,1));this.collisionMatrixTick(),c&&(t=performance.now());var I=T,F=n.length;for(g=0;g!==F;g++)I.push(n[g]);n.length=0;var V=this.frictionEquations.length;for(g=0;g!==V;g++)y.push(this.frictionEquations[g]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(r,i,this,n,I,this.frictionEquations,y),c&&(h.narrowphase=performance.now()-t),c&&(t=performance.now()),g=0;g<this.frictionEquations.length;g++)l.addEquation(this.frictionEquations[g]);for(var D=n.length,q=0;q!==D;q++){var z=(k=n[q]).bi,W=k.bj;k.si,k.sj,(z.material&&W.material&&this.getContactMaterial(z.material,W.material)||this.defaultContactMaterial).friction,z.material&&W.material&&(z.material.friction>=0&&W.material.friction>=0&&(z.material.friction,W.material.friction),z.material.restitution>=0&&W.material.restitution>=0&&(k.restitution=z.material.restitution*W.material.restitution)),l.addEquation(k),z.allowSleep&&z.type===p.DYNAMIC&&z.sleepState===p.SLEEPING&&W.sleepState===p.AWAKE&&W.type!==p.STATIC&&W.velocity.norm2()+W.angularVelocity.norm2()>=2*Math.pow(W.sleepSpeedLimit,2)&&(z._wakeUpAfterNarrowphase=!0),W.allowSleep&&W.type===p.DYNAMIC&&W.sleepState===p.SLEEPING&&z.sleepState===p.AWAKE&&z.type!==p.STATIC&&z.velocity.norm2()+z.angularVelocity.norm2()>=2*Math.pow(z.sleepSpeedLimit,2)&&(W._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(z,W,!0),this.collisionMatrixPrevious.get(z,W)||(E.body=W,E.contact=k,z.dispatchEvent(E),E.body=z,W.dispatchEvent(E))}for(c&&(h.makeContactConstraints=performance.now()-t,t=performance.now()),g=0;g!==a;g++)(z=s[g])._wakeUpAfterNarrowphase&&(z.wakeUp(),z._wakeUpAfterNarrowphase=!1);for(N=f.length,g=0;g!==N;g++){var k;(k=f[g]).update(),B=0;for(var j=k.equations.length;B!==j;B++){var U=k.equations[B];l.addEquation(U)}}l.solve(e,this),c&&(h.solve=performance.now()-t),l.removeAllEquations();var G=Math.pow;for(g=0;g!==a;g++)if((z=s[g]).type&d){var H=G(1-z.linearDamping,e),K=z.velocity;K.mult(H,K);var X=z.angularVelocity;if(X){var Y=G(1-z.angularDamping,e);X.mult(Y,X)}}for(this.dispatchEvent(w),g=0;g!==a;g++)(z=s[g]).preStep&&z.preStep.call(z);c&&(t=performance.now());var Q=L,Z=R,J=this.stepnumber,$=p.DYNAMIC|p.KINEMATIC,ee=J%(this.quatNormalizeSkip+1)===0,te=this.quatNormalizeFast,ne=.5*e;for(o.types.PLANE,o.types.CONVEXPOLYHEDRON,g=0;g!==a;g++){var oe=s[g],re=oe.force,ie=oe.torque;if(oe.type&$&&oe.sleepState!==p.SLEEPING){var ae=oe.velocity,se=oe.angularVelocity,le=oe.position,ue=oe.quaternion,ce=oe.invMass,he=oe.invInertiaWorld;ae.x+=re.x*ce*e,ae.y+=re.y*ce*e,ae.z+=re.z*ce*e,oe.angularVelocity&&(he.vmult(ie,O),O.mult(e,O),O.vadd(se,se)),le.x+=ae.x*e,le.y+=ae.y*e,le.z+=ae.z*e,oe.angularVelocity&&(Q.set(se.x,se.y,se.z,0),Q.mult(ue,Z),ue.x+=ne*Z.x,ue.y+=ne*Z.y,ue.z+=ne*Z.z,ue.w+=ne*Z.w,ee&&(te?ue.normalizeFast():ue.normalize())),oe.aabb&&(oe.aabbNeedsUpdate=!0),oe.updateInertiaWorld&&oe.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,c&&(h.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(A),g=0;g!==a;g++){var pe=(z=s[g]).postStep;pe&&pe.call(z)}if(this.allowSleep)for(g=0;g!==a;g++)s[g].sleepTick(this.time)},b.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,n=0;n!==t;n++){var o=e[n];o.force,o.torque,o.force.set(0,0,0),o.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)}}]);
//# sourceMappingURL=7.25022b81.chunk.js.map